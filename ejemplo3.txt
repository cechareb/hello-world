create or replace 
PACKAGE BODY paquete_riesgos
IS

PROCEDURE cc_ldi_procesar (V_FECHA IN DATE) IS
c_part number;
BEGIN

DBMS_STATS.GATHER_TABLE_STATS (OWNNAME => 'ODS_GPF',TABNAME=>'CC_LDI_RESUMEN_DIARIO',DEGREE=>4,ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE, GRANULARITY =>'ALL',CASCADE => TRUE);

DELETE FROM CC_LDI_RESUMEN_CICLO WHERE
        PERIODO_FACTURACION =
        DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(V_FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END);

INSERT /*+APPEND*/ INTO CC_LDI_RESUMEN_CICLO
SELECT    RES_TELPAIS.COMPANIA
        , RES_TELPAIS.TELEFONO
        , RES_TELPAIS.CODIGOCONTRATOBSCS
        , RES_TELPAIS.CICLOFACTURACIONCONTRATO
        , RES_TELPAIS.PERIODO_FACTURACION
        , RES_TELPAIS.PLANTARIFARIO
        , RES_TELPAIS.TIPO_PLAN
        , RES_TELPAIS.RUCCOMPANIA
        , RES_TELPAIS.CODIGOCOMPANIA
        , RES_TELPAIS.CODIGOCUENTARESPONSABLE
        , RES_TELPAIS.NUMEROCUENTARESPONSABLE
        , RES_TELPAIS.PAIS
        , RES_TELPAIS.TIPO_DESTINO
        , RES_TELPAIS.MINUTOS
        , RES_TELPAIS.LLAMADAS
        , RES_TELPAIS.PRECIO

        , RES_TELEFONO.MINUTOS MIN_TELEFONO
        , RES_TELEFONO.LLAMADAS LLAM_TELEFONO
        , RES_TELEFONO.PRECIO PRECIO_TELEFONO
        , RES_COMPANIA.MINUTOS MIN_COMPANIA
        , RES_COMPANIA.LLAMADAS LLAM_COMPANIA
        , RES_COMPANIA.PRECIO PRECIO_COMPANIA
        , RES_COMPANIA.LIMITECREDITOCUENTA
        , TRUNC(V_FECHA) FECHA_PROCESO

        , RES_TELEFONO.CELDA  --CELDA A NIVEL DE TELEFONO
        , RES_TELEFONO.MIN_CELDA

        , RES_TELPAIS.FECHA_INICIAL
        , RES_TELPAIS.FECHA_FINAL

        , NVL(e.limite_credito, DECODE(tipopersona,'Natural',125,
                    CASE WHEN equiposactivospostpago <20 THEN 375
                         WHEN equiposactivospostpago >=20 AND equiposactivospostpago <80 THEN 750
                         WHEN equiposactivospostpago >=80 THEN 1250
                    END
                 )) limitecreditocuenta
         , RES_TELPAIS.C_PLAN
FROM
--POR TELEFONO PAIS
(SELECT  T_FOTO.compania
        ,RES_LDI.TELEFONO
        ,T_FOTO.codigocontratobscs
        ,T_FOTO.ciclofacturacioncontrato
        ,DECODE(CICLOFACTURACIONCONTRATO ,
                      '01', TO_CHAR(FECHA,'yyyymm'),
                      '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                      '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                      '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END) PERIODO_FACTURACION
        ,T_FOTO.plantarifario
        ,T_FOTO.tipo_plan
        ,T_FOTO.ruccompania
        ,T_FOTO.codigocompania
        ,T_FOTO.codigocuentaresponsable
        ,T_FOTO.numerocuentaresponsable
        ,COMP.equiposactivospostpago
        ,COMP.tipopersona
        ,RES_LDI.PAIS
        ,T_PAIS.tipo_destino
        ,T_FOTO.C_PLAN
        ,SUM(RES_LDI.MINUTOS) MINUTOS
        ,SUM(RES_LDI.LLAMADAS) LLAMADAS
        ,SUM(T_PAIS.precio * RES_LDI.MINUTOS) PRECIO
        , MIN(RES_LDI.FECHA) FECHA_INICIAL
        , MAX(RES_LDI.FECHA) FECHA_FINAL
FROM
            CC_LDI_RESUMEN_DIARIO RES_LDI
LEFT JOIN
            (     SELECT * FROM
                    (SELECT     COMPANIA
                              , RUCCOMPANIA
                              , CODIGOCOMPANIA
                              , codigocuentaresponsable
                              , numerocuentaresponsable
                              , CICLOFACTURACIONCONTRATO
                              , CODIGOCONTRATOBSCS
                              , TELEFONO
                              , PLANTARIFARIO
                              , CODIGOPLANTARIFARIOBSCS C_PLAN
                              , NVL(g_osiptel2, CASE WHEN UPPER(g_osiptel)LIKE '%CONTROL%' THEN 'Control'
                                                     WHEN UPPER(g_osiptel)LIKE '%PRE%' THEN 'Prepago'
                                                     WHEN UPPER(g_osiptel)LIKE '%POST%' THEN 'Postpago'
                                                     ELSE 'Otros'
                                                     END ) TIPO_PLAN
                             , RANK() OVER (PARTITION BY TELEFONO ORDER BY FECHACARGACONTRATO DESC) RN
                        FROM FOTOEQUIPOS F1
                        LEFT JOIN PM_PLANES F2
                        ON F1.codigoplantarifariobscs = F2.c_plan
                        WHERE F1.ESTADOCONTRATO IN ('Activo','Suspendido')
                        ) WHERE  RN = 1
            ) T_FOTO
ON RES_LDI.TELEFONO = '51'||T_FOTO.telefono
LEFT JOIN
        ID_PAIS_PLAN T_PAIS
 ON RES_LDI.PAIS = T_PAIS.PAIS AND T_FOTO.TIPO_PLAN = T_PAIS.TIPO_PLAN
LEFT JOIN P_COMPANIA COMP
  ON T_FOTO.CODIGOCOMPANIA = COMP.CODIGOCOMPANIA
WHERE  DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END)
        =
        DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(V_FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END)
GROUP BY     T_FOTO.compania
            ,RES_LDI.TELEFONO
            ,T_FOTO.codigocontratobscs
            ,T_FOTO.ciclofacturacioncontrato
            ,DECODE(CICLOFACTURACIONCONTRATO ,
                          '01', TO_CHAR(FECHA,'yyyymm'),
                          '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                          '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                          '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END)
            ,RES_LDI.PAIS
            ,T_PAIS.tipo_destino
            ,T_FOTO.plantarifario
            ,T_FOTO.tipo_plan
            ,T_FOTO.ruccompania
            ,T_FOTO.codigocompania
            ,T_FOTO.codigocuentaresponsable
            ,T_FOTO.numerocuentaresponsable
            ,COMP.equiposactivospostpago
            ,COMP.tipopersona
            ,T_FOTO.C_PLAN ) RES_TELPAIS
LEFT JOIN
-----POR TELEFONO
(SELECT   RES_LDI.TELEFONO
        ,DECODE(CICLOFACTURACIONCONTRATO ,
                      '01', TO_CHAR(FECHA,'yyyymm'),
                      '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                      '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                      '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END) PERIODO_FACTURACION
        ,SUM(RES_LDI.MINUTOS) MINUTOS
        ,SUM(RES_LDI.LLAMADAS) LLAMADAS
        ,SUM(T_PAIS.precio * RES_LDI.MINUTOS) PRECIO
        , T_CELDA.CELDA
        , T_CELDA.MIN_CELDA

FROM
            CC_LDI_RESUMEN_DIARIO RES_LDI
LEFT JOIN
            (     SELECT * FROM
                    (SELECT     TELEFONO
                              , CICLOFACTURACIONCONTRATO
                              , NVL(g_osiptel2, CASE WHEN UPPER(g_osiptel)LIKE '%CONTROL%' THEN 'Control'
                                                     WHEN UPPER(g_osiptel)LIKE '%PRE%' THEN 'Prepago'
                                                     WHEN UPPER(g_osiptel)LIKE '%POST%' THEN 'Postpago'
                                                     ELSE 'Otros'
                                                     END ) TIPO_PLAN
                             , RANK() OVER (PARTITION BY TELEFONO ORDER BY FECHACARGACONTRATO DESC) RN
                        FROM FOTOEQUIPOS F1
                        LEFT JOIN PM_PLANES F2
                        ON F1.codigoplantarifariobscs = F2.c_plan
                        ) WHERE  RN = 1
            ) T_FOTO
ON RES_LDI.TELEFONO = '51'||T_FOTO.telefono
LEFT JOIN
        ID_PAIS_PLAN T_PAIS
 ON RES_LDI.PAIS = T_PAIS.PAIS AND T_FOTO.TIPO_PLAN = T_PAIS.TIPO_PLAN
LEFT JOIN
(SELECT TELEFONO,  CELDA, MIN_CELDA FROM
    (SELECT   A.telefono
            , A.celda
            , sum (A.minutos) MIN_CELDA
            , RANK() OVER (PARTITION BY A.TELEFONO ORDER BY SUM(A.MINUTOS) DESC) RN
      FROM cc_ldi_resumen_diario A
      LEFT JOIN (SELECT *
                   FROM ( SELECT a.*
                               , rank() over (PARTITION BY telefono
                                                  ORDER BY fechacargacontrato desc) rn
                            FROM fotoequipos a )
                  WHERE rn = 1 ) B
      ON A.TELEFONO = '51'||B.telefono
      WHERE  DECODE(B.CICLOFACTURACIONCONTRATO ,
              '01', TO_CHAR(A.FECHA,'yyyymm'),
              '03', CASE WHEN TO_CHAR(A.FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(A.FECHA,1),'yyyymm') ELSE TO_CHAR(A.FECHA,'yyyymm') END,
              '04', CASE WHEN TO_CHAR(A.FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(A.FECHA,1),'yyyymm') ELSE TO_CHAR(A.FECHA,'yyyymm') END,
              '05', CASE WHEN TO_CHAR(A.FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(A.FECHA,1),'yyyymm') ELSE TO_CHAR(A.FECHA,'yyyymm') END)
            =
            DECODE(B.CICLOFACTURACIONCONTRATO ,
              '01', TO_CHAR(V_FECHA,'yyyymm'),
              '03', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
              '04', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
              '05', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END)
      group by A.telefono, A.celda
      order by A.telefono )
WHERE RN = 1 ) T_CELDA
ON RES_LDI.TELEFONO = T_CELDA.telefono
WHERE  DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END)
        =
        DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(V_FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END)
GROUP BY     RES_LDI.TELEFONO
            ,DECODE(CICLOFACTURACIONCONTRATO ,
                          '01', TO_CHAR(FECHA,'yyyymm'),
                          '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                          '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                          '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END)
            , T_CELDA.CELDA
            , T_CELDA.MIN_CELDA
) RES_TELEFONO
ON RES_TELPAIS.TELEFONO = RES_TELEFONO.TELEFONO
LEFT JOIN
--RESUMEN POR COMPANIA
(SELECT    T_FOTO.CODIGOCOMPANIA
        , T_FOTO.numerocuentaresponsable
        ,DECODE(CICLOFACTURACIONCONTRATO ,
                      '01', TO_CHAR(FECHA,'yyyymm'),
                      '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                      '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                      '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END) PERIODO_FACTURACION
        ,limitecreditocuenta
        ,SUM(RES_LDI.MINUTOS) MINUTOS
        ,SUM(RES_LDI.LLAMADAS) LLAMADAS
        ,SUM(T_PAIS.precio * RES_LDI.MINUTOS) PRECIO

FROM
            CC_LDI_RESUMEN_DIARIO RES_LDI
LEFT JOIN
            (     SELECT * FROM
                    (SELECT     TELEFONO
                              , CICLOFACTURACIONCONTRATO
                              , CODIGOCOMPANIA
                              , numerocuentaresponsable
                              , NVL(g_osiptel2, CASE WHEN UPPER(g_osiptel)LIKE '%CONTROL%' THEN 'Control'
                                                     WHEN UPPER(g_osiptel)LIKE '%PRE%' THEN 'Prepago'
                                                     WHEN UPPER(g_osiptel)LIKE '%POST%' THEN 'Postpago'
                                                     ELSE 'Otros'
                                                     END ) TIPO_PLAN
                             , RANK() OVER (PARTITION BY TELEFONO ORDER BY FECHACARGACONTRATO DESC) RN
                        FROM FOTOEQUIPOS F1
                        LEFT JOIN PM_PLANES F2
                        ON F1.codigoplantarifariobscs = F2.c_plan
                        ) WHERE  RN = 1
            ) T_FOTO
ON RES_LDI.TELEFONO = '51'||T_FOTO.telefono
LEFT JOIN
        ID_PAIS_PLAN T_PAIS
 ON RES_LDI.PAIS = T_PAIS.PAIS AND T_FOTO.TIPO_PLAN = T_PAIS.TIPO_PLAN
LEFT JOIN
        temp_credito_disponible T_CREDITO
 ON T_FOTO.numerocuentaresponsable = T_CREDITO.numerocuentaresponsable
WHERE  DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END)
        =
        DECODE(CICLOFACTURACIONCONTRATO ,
          '01', TO_CHAR(V_FECHA,'yyyymm'),
          '03', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '04', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END,
          '05', CASE WHEN TO_CHAR(V_FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(V_FECHA,1),'yyyymm') ELSE TO_CHAR(V_FECHA,'yyyymm') END)
GROUP BY      T_FOTO.CODIGOCOMPANIA
            , T_FOTO.numerocuentaresponsable
            ,DECODE(CICLOFACTURACIONCONTRATO ,
                          '01', TO_CHAR(FECHA,'yyyymm'),
                          '03', CASE WHEN TO_CHAR(FECHA, 'dd')>='16' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                          '04', CASE WHEN TO_CHAR(FECHA, 'dd')>='09' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END,
                          '05', CASE WHEN TO_CHAR(FECHA, 'dd')>='23' THEN TO_CHAR(ADD_MONTHS(FECHA,1),'yyyymm') ELSE TO_CHAR(FECHA,'yyyymm') END)
            ,limitecreditocuenta ) RES_COMPANIA
ON RES_TELPAIS.numerocuentaresponsable = RES_COMPANIA.numerocuentaresponsable
LEFT JOIN cc_especiales e
  ON RES_COMPANIA.CODIGOCOMPANIA = e.CODIGOCOMPANIA;

DBMS_STATS.GATHER_TABLE_STATS (OWNNAME => 'ODS_GPF',TABNAME=>'CC_LDI_RESUMEN_CICLO',DEGREE=>4,ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE, GRANULARITY =>'ALL',CASCADE => TRUE);

COMMIT;

--PARTICIONES
SELECT COUNT(1) INTO c_part
  FROM user_tab_partitions
 WHERE table_name = UPPER('CC_LDI_RESUMEN_DIARIO')
   AND PARTITION_NAME = 'P_'|| TO_CHAR(V_FECHA+1,'YYYYMMDD');
IF c_part = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE ods_gpf.CC_LDI_RESUMEN_DIARIO ADD PARTITION P_' || TO_CHAR(V_FECHA+1,'YYYYMMDD') || ' VALUES LESS THAN ( TO_DATE('''||  TO_CHAR(V_FECHA+2,'YYYYMMDD')  ||''',''YYYYMMDD'') ) tablespace BIGDATA_TBS' ;
END IF;
COMMIT;


DELETE FROM cc_ldi_resumen_ciclo@PODS_LM WHERE TRUNC(fecha_proceso) = TRUNC(V_FECHA);

INSERT /*+APPEND*/  INTO cc_ldi_resumen_ciclo@PODS_LM
SELECT a.compania, a.telefono, a.codigocontratobscs,
       a.ciclofacturacioncontrato, a.periodo_facturacion,
       a.plantarifario, a.tipo_plan, a.ruccompania, a.codigocompania,
       a.codigocuentaresponsable, a.numerocuentaresponsable, a.pais,
       a.tipo_destino, a.minutos, a.llamadas, a.precio, a.min_telefono,
       a.llam_telefono, a.precio_telefono, a.min_compania,
       a.llam_compania, a.precio_compania, a.limitecreditocuenta,
       a.fecha_proceso, a.celda, a.min_celda, a.fecha_inicial,
       a.fecha_final, a.limite_credito_cc, a.c_plan
  FROM cc_ldi_resumen_ciclo a
 WHERE TRUNC(fecha_proceso) = TRUNC(V_FECHA);

END cc_ldi_procesar;

PROCEDURE cc_ldi_obtener_resumen ( C_FECHA IN VARCHAR2, pcursor OUT t_cursor) IS
BEGIN

OPEN pcursor FOR
SELECT a.compania, a.telefono, a.codigocontratobscs,
       a.ciclofacturacioncontrato, a.periodo_facturacion,
       a.plantarifario, a.tipo_plan, a.ruccompania, a.codigocompania,
       a.codigocuentaresponsable, a.numerocuentaresponsable, a.pais,
       a.tipo_destino, a.minutos, a.llamadas, a.precio, a.min_telefono,
       a.llam_telefono, a.precio_telefono, a.min_compania,
       a.llam_compania, a.precio_compania, a.limitecreditocuenta,
       a.fecha_proceso, a.celda, a.min_celda
       ,b.tipopersona
       ,/*DECODE(b.tipopersona,'Natural',125,
                        DECODE(t_especiales.NUMEROCUENTACOMPANIA, NULL,
                                CASE WHEN TO_NUMBER(NVL(ccontratos.numcontratos,0)) <20 THEN 375
                                     WHEN TO_NUMBER(NVL(ccontratos.numcontratos,0)) >=20 AND TO_NUMBER(NVL(ccontratos.numcontratos,0)) <80 THEN 750
                                     WHEN TO_NUMBER(NVL(ccontratos.numcontratos,0)) >=80 THEN 1250
                                END
                             ,2500 ))*/limite_credito_cc
        , NVL(TO_CHAR(fecha_inicial,'DD/MM/YYYY'),' ') Fecha_inicial
        , NVL(TO_CHAR(fecha_final,'DD/MM/YYYY'),' ') Fecha_final
        ,NULL alerta25
        ,NULL alerta50
        ,NULL alerta75
        ,NULL alerta100
        ,NULL suspendido
        ,NULL reclamado
        ,NULL activado
        ,NULL observaciones
FROM cc_ldi_resumen_ciclo a
LEFT JOIN (  SELECT *
               FROM ( SELECT a.*
                           , rank() over (PARTITION BY telefono
                                              ORDER BY fechacargacontrato desc) rn
                        FROM fotoequipos a )
              WHERE rn = 1 ) b
ON a.telefono = '51'||b.telefono
/*LEFT JOIN
 ( Select distinct a.*,b.numerocuentaresponsable from
                         (select  NUMEROCUENTACOMPANIA, count(distinct codigocontratobscs) numcontratos
                                                from fotoequipos
                                               where estadocontrato in ('Activo','Suspendido')
                                                 and product not like '%Pre%'
                                                 and tipopersona = 'Jurídica'
                                            group by NUMEROCUENTACOMPANIA ) a
                        left join fotoequipos b
                        on a.NUMEROCUENTACOMPANIA= b.NUMEROCUENTACOMPANIA ) ccontratos
ON b.numerocuentaresponsable  = ccontratos.numerocuentaresponsable
LEFT JOIN CC_BASE_ESTRATEGICA_ESPECIAL t_especiales
ON b.NUMEROCUENTACOMPANIA = t_especiales.NUMEROCUENTACOMPANIA
-- Campos adicionales
left join
(
    select alerta25,alerta50,alerta75,alerta100,suspendido,reclamado,activado,observaciones,periodo,telefono
    from cc_roaming_historial_acciones
) z
on trim(a.telefono) = trim(z.telefono) and a.periodo_facturacion = z.periodo*/
WHERE TRUNC(FECHA_PROCESO) = TRUNC(TO_DATE(C_FECHA,'DD/MM/YYYY'))
    AND precio_telefono/ limite_credito_cc > 0.1

ORDER BY  a.precio_telefono desc, a.precio desc, a.compania, a.telefono,a.pais ;

END cc_ldi_obtener_resumen;

PROCEDURE cc_ldi_notificar (V_FECHA DATE) IS
  BEGIN

    BEGIN paquete_riesgos.cc_ldi_notificar_tplan (V_FECHA,'Comercial'); END;
    BEGIN paquete_riesgos.cc_ldi_notificar_tplan (V_FECHA,'No Comercial'); END;

END cc_ldi_notificar;


PROCEDURE cc_local_procesar (V_FECHA IN DATE) IS
c_part number;
BEGIN

        DBMS_STATS.GATHER_TABLE_STATS (OWNNAME => 'ODS_GPF',TABNAME=>'cc_local_resumen_diario',PARTNAME=>'P_'||TO_CHAR(V_FECHA,'YYYYMMDD'), DEGREE=>4,ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE, GRANULARITY =>'PARTITION',CASCADE => TRUE);

        --Completar campos relacionados al contrato FOTOEQUIPOS
        MERGE INTO (SELECT *
                      FROM cc_local_resumen_diario
                     WHERE fecha = TRUNC(V_FECHA)
                        OR fecha = TRUNC(V_FECHA-1)) a
        USING (SELECT telefono
                    , codigocontratobscs
                    , ciclofacturacioncontrato
                    , codigocompania
                    , codigoplantarifariobscs
                 FROM   (SELECT *
                           FROM ( SELECT a.*
                                       , row_number() over (PARTITION BY telefono
                                                          ORDER BY DECODE(estadocontrato, 'Desactivado',2,0) ASC
                                                                 , fechacargacontrato desc) rn
                                    FROM fotoequipos a )
                          WHERE rn = 1 ) b
                 LEFT JOIN PM_PLANES c
                   ON b.codigoplantarifariobscs = c.c_plan
                WHERE   NVL(g_osiptel2,  CASE WHEN UPPER(g_osiptel)LIKE '%CONTROL%' THEN 'Control'
                                                  WHEN UPPER(g_osiptel)LIKE '%PRE%' THEN 'Prepago'
                                                  WHEN UPPER(g_osiptel)LIKE '%POST%' THEN 'Postpago'
                                             ELSE 'Otros'
                                             END ) = 'Postpago'
                 AND b.codigoplantarifariobscs NOT IN (SELECT C_PLAN FROM pf_ilimitados_planes)
                ) b
        ON ( a.telefono = '51'||b.telefono )
        WHEN MATCHED THEN UPDATE SET a.contrato = b.codigocontratobscs
                                   , a.compania = b.codigocompania
                                   , a.c_plan = b.codigoplantarifariobscs
                                   , a.ciclo_facturacion = b.ciclofacturacioncontrato ;
        COMMIT;

        --Completar campos relacionados al contrato P_FOTOEQUIPOSMESANTERIOR
        MERGE INTO (SELECT *
                      FROM cc_local_resumen_diario
                     WHERE ( fecha = TRUNC(V_FECHA)OR fecha = TRUNC(V_FECHA-1) )
                       AND contrato IS null) a
        USING (SELECT telefono
                    , codigocontratobscs
                    , ciclofacturacioncontrato
                    , codigocompania
                    , codigoplantarifariobscs
                 FROM   (SELECT *
                           FROM ( SELECT a.*
                                       , row_number() over (PARTITION BY telefono
                                                          ORDER BY DECODE(estadocontrato, 'Desactivado',2,0) ASC
                                                                 , fechacargacontrato desc) rn
                                    FROM p_fotoequiposmesanterior a )
                          WHERE rn = 1 ) b
                 LEFT JOIN PM_PLANES c
                   ON b.codigoplantarifariobscs = c.c_plan
                WHERE   NVL(g_osiptel2,  CASE WHEN UPPER(g_osiptel)LIKE '%CONTROL%' THEN 'Control'
                                                  WHEN UPPER(g_osiptel)LIKE '%PRE%' THEN 'Prepago'
                                                  WHEN UPPER(g_osiptel)LIKE '%POST%' THEN 'Postpago'
                                             ELSE 'Otros'
                                             END ) = 'Postpago'
                 AND b.codigoplantarifariobscs NOT IN (SELECT C_PLAN FROM pf_ilimitados_planes)
                 ) b
        ON ( a.telefono = '51'||b.telefono )
        WHEN MATCHED THEN UPDATE SET a.contrato = b.codigocontratobscs
                                   , a.compania = b.codigocompania
                                   , a.c_plan = b.codigoplantarifariobscs
                                   , a.ciclo_facturacion = b.ciclofacturacioncontrato ;
        COMMIT;


        --Borrar tráfico de líneas no encontradas o no postpago
        EXECUTE IMMEDIATE  'DELETE FROM cc_local_resumen_diario PARTITION (P_'||TO_CHAR(V_FECHA,'YYYYMMDD')||') WHERE contrato is null';
        EXECUTE IMMEDIATE  'DELETE FROM cc_local_resumen_diario PARTITION (P_'||TO_CHAR(V_FECHA-1,'YYYYMMDD')||') WHERE contrato is null';

        COMMIT;

        DELETE FROM CC_LOCAL_RESUMEN_CICLO_TEMP;
        COMMIT;
        --RESUMEN TELEFONO
            INSERT INTO CC_LOCAL_RESUMEN_CICLO_TEMP (telefono, contrato,codigocompania, ciclofacturacioncontrato, periodo_facturacion, C_PLAN
                                    ,MINUTOS_ONNET,LLAMADAS_ONNET,MINUTOS_OFFNET_MOVIL, LLAMADAS_OFFNET_MOVIL
                                    ,MINUTOS_OFFNET_FIJO,LLAMADAS_OFFNET_FIJO, FECHA_INICIAL, FECHA_FINAL, fecha_proceso  )
                 SELECT   TELEFONO
                        , CONTRATO
                        , COMPANIA
                        , CICLO_FACTURACION
                        , obtener_periodo_fact_actual (ciclo_facturacion, FECHA) PERIODO_FACTURACION
                        , C_PLAN
                        , SUM(onnet_min) MINUTOS_ONNET
                        , SUM(onnet_llam ) LLAMADAS_ONNET
                        , SUM(offnet_movil_min ) MINUTOS_OFFNET_MOVIL
                        , SUM(offnet_movil_llam ) LLAMADAS_OFFNET_MOVIL
                        , SUM(offnet_fijo_min ) MINUTOS_OFFNET_FIJO
                        , SUM(offnet_fijo_llam ) LLAMADAS_OFFNET_FIJO
                        , MIN(FECHA) FECHA_INICIAL
                        , MAX(FECHA) FECHA_FINAL
                        , TRUNC(V_FECHA) fecha_proceso
                 FROM cc_local_resumen_diario a
                WHERE obtener_periodo_fact_actual (ciclo_facturacion, FECHA) = obtener_periodo_fact_actual (ciclo_facturacion, V_FECHA)
                GROUP BY  TELEFONO
                        , CONTRATO
                        , COMPANIA
                        , obtener_periodo_fact_actual (ciclo_facturacion, FECHA)
                        , CICLO_FACTURACION
                        , C_PLAN;
            COMMIT;

            MERGE INTO CC_LOCAL_RESUMEN_CICLO_TEMP A
            USING (--RESUMEN POR CELDA
                         SELECT CONTRATO, CELDA, MINUTOS_CELDA
                          FROM
                                (SELECT CONTRATO
                                        , CELDA
                                        , SUM (MIN_CELDA) MINUTOS_CELDA
                                        ,RANK() OVER ( PARTITION BY CONTRATO ORDER BY  SUM (MIN_CELDA) DESC, CELDA) RN
                                 FROM cc_local_resumen_diario a
                                 WHERE  obtener_periodo_fact_actual (ciclo_facturacion, FECHA)
                                    = obtener_periodo_fact_actual (ciclo_facturacion, V_FECHA)
                         GROUP BY CONTRATO, CELDA )
                         WHERE RN = 1
                    ) RES_CELDA
            ON (A.CONTRATO = RES_CELDA.CONTRATO)
            WHEN MATCHED THEN UPDATE SET celda = RES_CELDA.CELDA
                                       , minutos_celda = ROUND(RES_CELDA.MINUTOS_CELDA,2);
            COMMIT;

            MERGE INTO CC_LOCAL_RESUMEN_CICLO_TEMP A
            USING FOTOEQUIPOS B
            ON (A.CONTRATO = B.CODIGOCONTRATOBSCS)
            WHEN MATCHED THEN UPDATE SET A.plan_tarifario = B.PLANTARIFARIO
                                        ,A.tipo_plan = 'Postpago'
                                        ,A.ruccompania = B.RUCCOMPANIA
                                        ,A.codigocuentaresponsable = B.CODIGOCUENTARESPONSABLE
                                        ,A.numerocuentaresponsable = B.NUMEROCUENTARESPONSABLE
                                        ,A.compania = b.compania;
            COMMIT;


            DELETE FROM CC_LIMITE_CREDITO_TEMP;
            COMMIT;
            INSERT INTO CC_LIMITE_CREDITO_TEMP
                SELECT TAB_CONTRATOS.codigocompania,
                         NVL(TAB_ESPECIALES.limite_credito ,
                                DECODE(TAB_CONTRATOS.tipopersona,'Natural',250, --NATURAL
                                        CASE WHEN TO_NUMBER(NVL(TAB_CONTRATOS.numcontratos,0)) <20 THEN 750
                                             WHEN TO_NUMBER(NVL(TAB_CONTRATOS.numcontratos,0)) >=20
                                                  AND TO_NUMBER(NVL(TAB_CONTRATOS.numcontratos,0)) <80 THEN 1500
                                             WHEN TO_NUMBER(NVL(TAB_CONTRATOS.numcontratos,0)) >=80 THEN 2500
                                        END
                                     )
                         ) LIMITE_CREDITO_CC
                     FROM
                     (select tipopersona,  x.codigocompania, count(distinct codigocontratobscs) numcontratos
                        from fotoequipos x
                       where estadocontrato in ('Activo','Suspendido')
                         and product not like '%Pre%'
                       group by tipopersona, x.codigocompania  ) TAB_CONTRATOS
                    LEFT JOIN cc_especiales TAB_ESPECIALES
                    ON TAB_CONTRATOS.codigocompania = TAB_ESPECIALES.codigocompania;


            MERGE INTO CC_LOCAL_RESUMEN_CICLO_TEMP A
            USING  CC_LIMITE_CREDITO_TEMP B
            ON (a.codigocompania = b.codigocompania)
            WHEN MATCHED THEN UPDATE SET a.LIMITE_CREDITO_CC = b.LIMITE_CREDITO_CC;
            COMMIT;

        --ACTUALIZAR CAMPOS DE EXCESOS SEGÚN BUCKET
            MERGE INTO CC_LOCAL_RESUMEN_CICLO_TEMP A
                USING cc_local_bucket b
                ON (a.c_plan = b.c_plan)
                WHEN MATCHED THEN
                UPDATE SET A.EXCESO_MINUTOS_ONNET =CASE WHEN a.minutos_onnet > DECODE(b.minutos_onnet,0,999999,b.minutos_onnet)
                                                            THEN a.minutos_onnet - b.minutos_onnet
                                                            ELSE null END --EXCESO_MIN_ONNET
                         , A.EXCESO_MINUTOS_OFFNET_MOVIL = CASE WHEN a.minutos_offnet_movil > DECODE(b.minutos_movil,0,999999,b.minutos_movil)
                                                                THEN a.minutos_offnet_movil - b.minutos_movil
                                                                ELSE null END -- EXCESO_MIN_OFFNET_MOVIL
                         , A.EXCESO_MINUTOS_OFFNET_FIJO =CASE WHEN a.minutos_offnet_fijo >  DECODE(b.minutos_fijo,0,999999,b.minutos_fijo)
                                                                THEN a.minutos_offnet_fijo -  b.minutos_fijo
                                                                ELSE null END -- EXCESO_MIN_OFFNET_FIJO
                         , A.EXCESO_MINUTOS_OFFNET = CASE WHEN (a.minutos_offnet_fijo + a.minutos_offnet_movil) >  DECODE(b.minutos_offnet,0,999999,b.minutos_offnet)
                                                            THEN (a.minutos_offnet_fijo + a.minutos_offnet_movil) - b.minutos_offnet
                                                            ELSE null END -- EXCESO_MIN_OFFNET
                         , A.EXCESO_MINUTOS_TD = CASE WHEN (a.minutos_offnet_fijo + a.minutos_offnet_movil + CASE WHEN b.minutos_onnet = 0 THEN a.minutos_onnet ELSE 0 END )  > DECODE(b.minutos_todo_destino,0,999999,b.minutos_todo_destino)
                                                        THEN (a.minutos_offnet_fijo + a.minutos_offnet_movil + CASE WHEN b.minutos_onnet = 0 THEN a.minutos_onnet ELSE 0 END ) - b.minutos_todo_destino
                                                        ELSE null END -- EXCESO_MIN_TD
                         , A.EXCESO_PRECIO_ONNET = ROUND(CASE WHEN a.minutos_onnet > DECODE(b.minutos_onnet,0,999999,b.minutos_onnet)
                                                            THEN a.minutos_onnet - b.minutos_onnet
                                                            ELSE null END * adicional_onnet,4) --EXCESO_PRECIO_ONNET
                         , A.EXCESO_PRECIO_OFFNET_MOVIL = ROUND(CASE WHEN a.minutos_offnet_movil > DECODE(b.minutos_movil,0,999999,b.minutos_movil)
                                                            THEN a.minutos_offnet_movil - b.minutos_movil
                                                            ELSE null END * adicional_movil,4) --EXCESO_PRECIO_OFFNET_MOVIL
                         , A.EXCESO_PRECIO_OFFNET_FIJO = ROUND(CASE WHEN a.minutos_offnet_fijo > DECODE(b.minutos_fijo,0,999999,b.minutos_fijo)
                                                                THEN a.minutos_offnet_fijo -  b.minutos_fijo
                                                                ELSE null END * adicional_fijo,4)  --EXCESO_PRECIO_OFFNET_FIJO
                         , A.EXCESO_PRECIO_OFFNET = ROUND(CASE WHEN (a.minutos_offnet_fijo + a.minutos_offnet_movil) > DECODE(b.minutos_offnet,0,999999,b.minutos_offnet)
                                                        THEN (a.minutos_offnet_fijo + a.minutos_offnet_movil) - b.minutos_offnet
                                                        ELSE null END * adicional_onnet,4) --EXCESO_PRECIO_OFFNET
                         , A.EXCESO_PRECIO_TD = ROUND(CASE WHEN (a.minutos_offnet_fijo + a.minutos_offnet_movil + CASE WHEN b.minutos_onnet = 0 THEN a.minutos_onnet ELSE 0 END) > DECODE(b.minutos_todo_destino,0,999999,b.minutos_todo_destino)
                                                                THEN (a.minutos_offnet_fijo + a.minutos_offnet_movil + CASE WHEN b.minutos_onnet = 0 THEN a.minutos_onnet ELSE 0 END) - b.minutos_todo_destino
                                                                ELSE null END
                                                                * --PRECIO TODO DESTINO
                                                                (NVL(b.adicional_fijo,0)
                                                                + NVL(b.adicional_movil,0)
                                                                + NVL(b.adicional_offnet,0)
                                                                + CASE WHEN b.minutos_onnet = 0 THEN NVL(b.adicional_onnet,0) ELSE 0 END)
                                                                / decode(   decode(b.adicional_fijo,NULL,0,1)
                                                                          + decode(b.adicional_movil,NULL,0,1)
                                                                          + decode(b.adicional_offnet,NULL,0,1)
                                                                          + decode(CASE WHEN b.minutos_onnet = 0 THEN NVL(b.adicional_onnet,0) ELSE 0 END,0,0,1)
                                                                   ,0,1,
                                                                            decode(b.adicional_fijo,NULL,0,1)
                                                                          + decode(b.adicional_movil,NULL,0,1)
                                                                          + decode(b.adicional_offnet,NULL,0,1)
                                                                          + decode(CASE WHEN b.minutos_onnet = 0 THEN NVL(b.adicional_onnet,0) ELSE 0 END,0,0,1) )
                                                                ,4) --EXCESO_PRECIO_TD
                         , A.BUCKET_MINUTOS_ONNET = B.minutos_onnet
                         , A.BUCKET_MINUTOS_OFFNET_MOVIL = B.minutos_movil
                         , A.BUCKET_MINUTOS_OFFNET_FIJO = B.minutos_fijo
                         , A.BUCKET_MINUTOS_OFFNET = B.minutos_offnet
                         , A.BUCKET_MINUTOS_TD = B.minutos_todo_destino ;


        COMMIT;

        --ACTUALIZAR EL EXCESO ONNET CUANDO TIENE BUCKET ONNET Y TD Y AGOTA MINUTOS ONNET PERO TIENE MINUTOS TD DISPONIBLES
        --EL EXCESO CALCULADO EN EL PRIMER UPDATE SEPARA ONNET Y TD PARA LOS PLANES CON ESTOS BUCKETS
        UPDATE CC_LOCAL_RESUMEN_CICLO_TEMP --nuevo exceso
        SET exceso_minutos_onnet  = exceso_minutos_onnet - (bucket_minutos_td - (minutos_offnet_movil + minutos_offnet_fijo))
        where bucket_minutos_td>0
            and bucket_minutos_onnet >0
            and bucket_minutos_onnet <> 999999
            and exceso_minutos_onnet > 0
            and ( exceso_minutos_td is null or exceso_minutos_td = 0);
        COMMIT;

        --Borrar acumulado del ciclo actual
        DELETE FROM CC_LOCAL_RESUMEN_CICLO
              WHERE PERIODO_FACTURACION = obtener_periodo_fact_actual (CICLOFACTURACIONCONTRATO, V_FECHA);

        INSERT /*+APPEND*/ INTO CC_LOCAL_RESUMEN_CICLO
        SELECT * FROM CC_LOCAL_RESUMEN_CICLO_TEMP;
        COMMIT;

        DBMS_STATS.GATHER_TABLE_STATS (OWNNAME => 'ODS_GPF',TABNAME=>'CC_LOCAL_RESUMEN_CICLO',DEGREE=>4,ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE, GRANULARITY =>'ALL',CASCADE => TRUE);

        --PARTICION (DEL DÍA SIGUIENTE)
        SELECT COUNT(1) INTO c_part
          FROM user_tab_partitions
         WHERE table_name = UPPER('CC_LOCAL_RESUMEN_DIARIO')
           AND PARTITION_NAME = 'P_'|| TO_CHAR(V_FECHA+1,'YYYYMMDD');
        IF c_part = 0 THEN
            EXECUTE IMMEDIATE 'ALTER TABLE ods_gpf.CC_LOCAL_RESUMEN_DIARIO ADD PARTITION P_' || TO_CHAR(V_FECHA+1,'YYYYMMDD') || ' VALUES LESS THAN ( TO_DATE('''||  TO_CHAR(V_FECHA+2,'YYYYMMDD')  ||''',''YYYYMMDD'') ) tablespace BIGDATA_TBS' ;
        END IF;

        SELECT COUNT(1) INTO c_part
          FROM user_tab_partitions
         WHERE table_name = UPPER('CC_LOCAL_RESUMEN_DIARIO')
           AND PARTITION_NAME = 'P_'|| TO_CHAR(V_FECHA+2,'YYYYMMDD');
        IF c_part = 0 THEN
            EXECUTE IMMEDIATE 'ALTER TABLE ods_gpf.CC_LOCAL_RESUMEN_DIARIO ADD PARTITION P_' || TO_CHAR(V_FECHA+2,'YYYYMMDD') || ' VALUES LESS THAN ( TO_DATE('''||  TO_CHAR(V_FECHA+3,'YYYYMMDD')  ||''',''YYYYMMDD'') ) tablespace BIGDATA_TBS' ;
        END IF;

        COMMIT;

        BEGIN paquete_riesgos.cc_local_notificar (TRUNC(V_FECHA)); END;

END cc_local_procesar;


PROCEDURE cc_local_notificar (V_FECHA DATE) IS

BEGIN
    BEGIN paquete_riesgos.cc_local_notificar_tplan (V_FECHA,'Comercial'); END;
    BEGIN paquete_riesgos.cc_local_notificar_tplan (V_FECHA,'No Comercial'); END;

END cc_local_notificar;

PROCEDURE cc_local_obtener_resumen ( C_FECHA IN VARCHAR2, pcursor OUT t_cursor) IS
BEGIN

OPEN pcursor FOR

SELECT * FROM
    (SELECT a.compania, a.telefono, a.contrato, a.ciclofacturacioncontrato,
           a.periodo_facturacion, a.plan_tarifario, a.tipo_plan,
           a.ruccompania, a.codigocompania, a.codigocuentaresponsable,
           a.numerocuentaresponsable
           , a.minutos_onnet, a.llamadas_onnet
           , a.minutos_offnet_movil, a.llamadas_offnet_movil
           , a.minutos_offnet_fijo, a.llamadas_offnet_fijo
           , a.limite_credito_dwh, a.limite_credito_cc
           , to_char(a.fecha_proceso,'DD/MM/YYYY')
           , to_char(a.fecha_inicial,'DD/MM/YYYY')
           , to_char(a.fecha_final,'DD/MM/YYYY')
           , a.celda, a.minutos_celda
            ,exceso_minutos_onnet
            ,exceso_minutos_offnet_movil
            ,exceso_minutos_offnet_fijo
            ,exceso_minutos_offnet
            ,exceso_minutos_td
            ,exceso_precio_onnet
            ,exceso_precio_offnet_movil
            ,exceso_precio_offnet_fijo
            ,exceso_precio_offnet
            ,exceso_precio_td
            ,bucket_minutos_onnet
            ,bucket_minutos_offnet_movil
            ,bucket_minutos_offnet_fijo
            ,bucket_minutos_offnet
            ,bucket_minutos_td
            ,(NVL(exceso_precio_onnet,0)
                +NVL(exceso_precio_offnet_movil,0)
                +NVL(exceso_precio_offnet_fijo,0)
                +NVL(exceso_precio_offnet,0)
                +NVL(exceso_precio_td,0)) EXCESO_PRECIO_TOTAL
            ,ROUND((NVL(exceso_precio_onnet,0)
                +NVL(exceso_precio_offnet_movil,0)
                +NVL(exceso_precio_offnet_fijo,0)
                +NVL(exceso_precio_offnet,0)
                +NVL(exceso_precio_td,0))/limite_credito_cc,4) RATIO_CREDITO
            ,ROUND((NVL(exceso_minutos_onnet,0)
                +NVL(exceso_minutos_offnet_movil,0)
                +NVL(exceso_minutos_offnet_fijo,0)
                +NVL(exceso_minutos_offnet,0)
                +NVL(exceso_minutos_td,0))/
                (NVL(bucket_minutos_onnet,0)
                +NVL(bucket_minutos_offnet_movil,0)
                +NVL(bucket_minutos_offnet_fijo,0)
                +NVL(bucket_minutos_offnet,0)
                +NVL(bucket_minutos_td,0)),4) RATIO_EXCESO
      FROM cc_local_resumen_ciclo a
     WHERE TRUNC(FECHA_PROCESO) = TRUNC(TO_DATE(C_FECHA,'DD/MM/YYYY'))
        AND (NVL(exceso_precio_onnet,0)
                +NVL(exceso_minutos_offnet_movil,0)
                +NVL(exceso_minutos_offnet_fijo,0)
                +NVL(exceso_minutos_offnet,0)
                +NVL(exceso_minutos_td,0))>0
ORDER BY (NVL(exceso_precio_onnet,0)
                +NVL(exceso_precio_offnet_movil,0)
                +NVL(exceso_precio_offnet_fijo,0)
                +NVL(exceso_precio_offnet,0)
                +NVL(exceso_precio_td,0)) desc, a.compania )
 WHERE ROWNUM<5000;

END cc_local_obtener_resumen;

PROCEDURE cc_roaming3g_cargar IS
V_TABLA VARCHAR2(60);
V_SQL VARCHAR2(10000);
BEGIN

    SELECT DISTINCT DECODE(TIPO_FECHA,'carga','ROAM_DETALLE3G'
                                 ,'llamada','ROAM_DETALLE3G_FECLLAM', '') INTO V_TABLA
    FROM roam_detalle3g_temp;


    UPDATE /*+PARALLEL(3)*/roam_detalle3g_temp
        SET telefono = '51'||SUBSTR(REPLACE(numerocliente,',',''),-9)
        WHERE numerocliente <> '-'
          AND telefono is null ;

    --UPDATE DE REGISTROS DE 60 DIAS
    MERGE /*+PARALLEL(3)*/INTO  roam_detalle3g_temp  a
    USING  (SELECT * FROM
                (SELECT IMSI, numerocliente, ROW_NUMBER() OVER (PARTITION BY IMSI ORDER BY FECHA DESC ) RN
                  FROM roam_detalle3g
                 WHERE numerocliente <> '-'
                   AND FECHA >= TRUNC(SYSDATE-60) and fecha<= TRUNC(SYSDATE)  )
                WHERE RN = '1'
                ) b
    ON ( a.IMSI = b.IMSI)
    WHEN MATCHED THEN UPDATE SET a.telefono = '51'||SUBSTR(b.numerocliente,-9)
    WHERE  a.numerocliente = '-'
     AND a.telefono is null;
    COMMIT;

    --UPDATE TELÉFONO SEGÚN TABLA DE ROAMING IMSI
     /*MERGE /*+PARALLEL(3)/INTO roam_detalle3g_temp A
        USING
        (
        SELECT * FROM
            (SELECT   a.imsi, '51'||SUBSTR(a.nextel,-9) telefono
                    , row_number () over (partition by imsi order by fecha desc, nextel) rn
             FROM roam_imsi_nextel a)WHERE RN = 1
        )B
        ON
        (
        a.imsi = b.imsi
        )
        WHEN MATCHED THEN
        UPDATE SET A.TELEFONO = '51'||SUBSTR(B.TELEFONO,-9)
        WHERE telefono is null;
    COMMIT;*/

     --UPDATE DATOS DE LA FOTO
     MERGE /*+PARALLEL(3)*/INTO roam_detalle3g_temp A
        USING
        (
        SELECT * FROM (
                SELECT  a.*
                 , ROW_NUMBER() over (partition by telefono  order by fechacargacontrato desc) rn
                FROM fotoequipos a)
                WHERE rn = 1
        )B
        ON
        (a.telefono = '51'||b.telefono )
        WHEN MATCHED THEN
        UPDATE SET A.CICLO  = B.ciclofacturacioncontrato
        , A.CODIGOCOMPANIA = B.CODIGOCOMPANIA
        , A.CONTRATO = B.codigocontratobscs
        , A.NUMEROCUENTARESPONSABLE = B.NUMEROCUENTARESPONSABLE
    WHERE contrato is null;
    COMMIT;


    V_SQL := 'DELETE FROM ' || V_TABLA ||
            ' WHERE fecha IN (SELECT DISTINCT FECHA FROM roam_detalle3g_temp)';
    dbms_output.put_line(V_SQL);
    EXECUTE IMMEDIATE V_SQL;
    COMMIT;

    V_SQL := 'INSERT INTO ' || V_TABLA ||
                    ' (roamingpartner, fecha, tipollamada, cdr, horizonte, '||
                    '  imsi, numerocliente, numerodestino, consumo,'||
                    '  unidadconsumo, monto, fechacarga, telefono, ciclo,'||
                    '  codigocompania, contrato, numerocuentaresponsable) ' ||
                  'SELECT roamingpartner, fecha, tipollamada, cdr, horizonte, '||
                       '  imsi, numerocliente, numerodestino, consumo,'||
                       '  unidadconsumo, monto, fechacarga, telefono, ciclo,'||
                       '  codigocompania, contrato, numerocuentaresponsable' ||
                   ' FROM roam_detalle3g_temp';
    EXECUTE IMMEDIATE V_SQL;
    COMMIT;

END cc_roaming3g_cargar;

PROCEDURE cc_roaming3g_procesar (V_FECHA IN DATE) IS
maxcarga number;
V_TABLA VARCHAR2(60);
V_FECHA_INI DATE:= V_FECHA - 14;
BEGIN

    SELECT DISTINCT DECODE(TIPO_FECHA,'carga','ROAM_DETALLE3G'
                                 ,'llamada','ROAM_DETALLE3G_FECLLAM', '') INTO V_TABLA
    FROM roam_detalle3g_temp
    WHERE FECHACARGA >= SYSDATE-1/24;

            --BORRAR REDUNDANCIA (CARGA ANTERIOR)
            /*
            SELECT MAX(NROCARGA) into maxcarga
            FROM ROAM_DETALLE3G  WHERE TRUNC(FECHACARGA) = TRUNC(SYSDATE);

            DELETE FROM ROAM_DETALLE3G
            WHERE NROCARGA  <> maxcarga
                  and TRUNC(fechacarga)=TRUNC(sysdate)
                  AND FECHA IN (select distinct FECHA from ROAM_DETALLE3G where TRUNC(FECHACARGA)=TRUNC(SYSDATE) and NROCARGA = maxcarga);

            COMMIT;
            DELETE FROM ROAM_DETALLE3G WHERE TRUNC(FECHACARGA) <> TRUNC(SYSDATE)
            AND FECHA IN (select distinct FECHA from ROAM_DETALLE3G where TRUNC(FECHACARGA)=TRUNC(SYSDATE) and NROCARGA = maxcarga);
            COMMIT;

        --UPDATE TELÉFONO SEGÚN NUMERO CLIENTE
            UPDATE roam_detalle3g
            SET telefono = '51'||SUBSTR(REPLACE(numerocliente,',',''),-9)
            WHERE numerocliente <> '-'
              AND FECHA >= V_FECHA-30
              AND telefono is null ;



        --UPDAT DE REGISTROS DE 60 DIAS
            MERGE INTO  roam_detalle3g  a
            USING  (SELECT * FROM
                        (SELECT IMSI, numerocliente, ROW_NUMBER() OVER (PARTITION BY IMSI ORDER BY FECHA DESC ) RN
                          FROM roam_detalle3g
                         WHERE numerocliente <> '-'
                           AND FECHA >= TRUNC(V_FECHA-60) and fecha<= TRUNC(V_FECHA)  )
                        WHERE RN = '1'
                        ) b
            ON ( a.IMSI = b.IMSI)
            WHEN MATCHED THEN UPDATE SET a.telefono = '51'||SUBSTR(b.numerocliente,-9)
            WHERE  a.numerocliente = '-'
             AND a.FECHA >= TRUNC(V_FECHA-30) and a.fecha<= TRUNC(V_FECHA)
             AND a.telefono is null;

            COMMIT;

        --UPDATE TELÉFONO SEGÚN TABLA DE ROAMING IMSI
             MERGE INTO
                roam_detalle3g A
                USING
                (
                SELECT * FROM
                    (SELECT   a.imsi, '51'||SUBSTR(a.nextel,-9) telefono
                            , row_number () over (partition by imsi order by fecha desc, nextel) rn
                     FROM roam_imsi_nextel a)WHERE RN = 1
                )B
                ON
                (
                a.imsi = b.imsi
                )
                WHEN MATCHED THEN
                UPDATE SET A.TELEFONO = '51'||SUBSTR(B.TELEFONO,-9)
                WHERE FECHA >= TRUNC(V_FECHA-30) and telefono is null;
            COMMIT;
            */

    IF V_TABLA = 'ROAM_DETALLE3G' THEN

            --UPDATE DATOS DE LA FOTO
             MERGE INTO
                roam_detalle3g A
                USING
                (
                SELECT * FROM (
                        SELECT  a.*
                         , ROW_NUMBER() over (partition by telefono  order by fechacargacontrato desc) rn
                        FROM fotoequipos a)
                        WHERE rn = 1
                )B
                ON
                (
                a.telefono = '51'||b.telefono
                )
                WHEN MATCHED THEN
                UPDATE SET A.CICLO  = B.ciclofacturacioncontrato
                , A.CODIGOCOMPANIA = B.CODIGOCOMPANIA
                , A.CONTRATO = B.codigocontratobscs
                , A.NUMEROCUENTARESPONSABLE = B.NUMEROCUENTARESPONSABLE
            WHERE FECHA >= TRUNC(V_FECHA-5) and contrato is null;

            COMMIT;

        --RESUMEN POR CICLO
        DELETE FROM cc_roaming3g_ciclo
         WHERE periodo_facturacion = obtener_periodo_fact_actual(ciclo,V_FECHA);

        --ALERTA 1 DNI-RUC10 CON MENOS DE 3 meses
        --ALERTA 2 RUC 20 Y DNI-RUC10 CON MAS DE 3 meses
        INSERT INTO cc_roaming3g_ciclo
          SELECT   FOTO.tipopersona tipopersona,
                   FOTO.tipocuenta tipocuenta,
                   FOTO.compania compania,
                   TRUNC(V_FECHA) fecha_proceso,
                   RES_IMSI.periodo_facturacion,
                   RES_IMSI.imsi imsi,
                   RES_IMSI.telefono telefono,
                   RES_IMSI.consumoLlamadas_minutos consumoLlamadas_minutos,
                   RES_IMSI.montoLlamadas montoLlamadas,
                   RES_IMSI.consumoMensajes_cant consumoMensajes_cant,
                   RES_IMSI.montoMensajes montoMensajes,
                   RES_IMSI.consumoDatos_KB consumoDatos_KB,
                   RES_IMSI.montoDatos montoDatos,
                   RES_IMSI.montototal  monto_total,
                   RES_CUENTA.totalcuenta totalcuenta,
                   RES_IMSI.fechaini ,
                   RES_IMSI.fechafin ,
                   NVL(e.limite_credito,
                            DECODE(CCONTRATOS.RUCCOMPANIA,NULL,
                                --SI ES DNI O RUC10
                                CASE WHEN MONTHS_BETWEEN(SYSDATE ,FOTO.fechaactivacioncontrato) <= 3
                                     THEN 300 ELSE 500 END,
                                --SI ES RUC20
                                CASE WHEN  CCONTRATOS.numcontratos < 4  THEN 500
                                     WHEN  CCONTRATOS.numcontratos >=4  AND CCONTRATOS.numcontratos < 11 THEN 800
                                     WHEN  CCONTRATOS.numcontratos >=11 AND CCONTRATOS.numcontratos < 20 THEN 1200
                                     WHEN  CCONTRATOS.numcontratos >=20 AND CCONTRATOS.numcontratos < 80 THEN 2000
                                     WHEN  CCONTRATOS.numcontratos >=80 THEN 4500
                                END )
                        )  LIMITE_EMPRESA ,
                 CCONTRATOS.numcontratos numcontratos,
                 FOTO.codigoplantarifariobscs c_plan,
                 RES_IMSI.contrato,
                 RES_IMSI.ciclo,
                 FOTO.fechaactivacioncontrato,
                 ROUND(MONTHS_BETWEEN(SYSDATE ,FOTO.fechaactivacioncontrato),2) meses,
                 CASE WHEN MONTHS_BETWEEN(SYSDATE ,FOTO.fechaactivacioncontrato) <=3 AND CCONTRATOS.RUCCOMPANIA IS NULL THEN 1 ELSE 2 END tipo_alerta
            FROM
                (--RESUMEN IMSI NUMERO
                SELECT  NUMEROCUENTARESPONSABLE,
                        IMSI,
                        TELEFONO, contrato, ciclo,
                        obtener_periodo_fact_actual(ciclo, fecha) periodo_facturacion,
                        SUM(DECODE(tipollamada,'LLAMADAS VOZ',consumo,0)) consumoLlamadas_minutos,
                        SUM(DECODE(tipollamada,'MENSAJES',consumo,0)) consumoMensajes_cant,
                        ROUND((SUM(DECODE(tipollamada,'DATA',consumo,0))/1024), 2) consumoDatos_KB,
                        SUM(DECODE(tipollamada,'LLAMADAS VOZ',monto,0)) montoLlamadas,
                        SUM(DECODE(tipollamada,'MENSAJES',monto,0)) montoMensajes,
                        SUM(DECODE(tipollamada,'DATA',monto,0)) montoDatos,
                        sum(monto) montoTotal,
                        min(fecha) fechaini,
                        max(fecha)fechafin,
                        count(distinct fecha) cantdias
                  FROM roam_detalle3g c
                 WHERE obtener_periodo_fact_actual(ciclo,fecha)= obtener_periodo_fact_actual(ciclo,V_FECHA)
                   AND tipollamada<>'DATA'
                 GROUP BY NUMEROCUENTARESPONSABLE, imsi, telefono, contrato
                     , obtener_periodo_fact_actual(ciclo,fecha), ciclo) RES_IMSI
           LEFT JOIN
                --RESUMEN COMPAÑÍA
                (SELECT  NUMEROCUENTARESPONSABLE,
                        sum(monto) totalcuenta
                  FROM roam_detalle3g c
                 WHERE obtener_periodo_fact_actual(ciclo,fecha)= obtener_periodo_fact_actual(ciclo,V_FECHA)
                   AND tipollamada<>'DATA'
                GROUP BY NUMEROCUENTARESPONSABLE) RES_CUENTA
          ON RES_IMSI.NUMEROCUENTARESPONSABLE = RES_CUENTA.NUMEROCUENTARESPONSABLE
            LEFT JOIN (  SELECT *
                              FROM ( SELECT a.*
                                          , row_number() over (PARTITION BY telefono
                                                                   ORDER BY DECODE(ESTADOCONTRATO,'Desactivado',2,1) ASC
                                                                          , fechacargacontrato desc) rn
                                       FROM fotoequipos a
                                        WHERE TELEFONO IS NOT NULL )
                             WHERE rn = 1)  FOTO
            ON RES_IMSI.telefono = '51' || foto.telefono
            LEFT JOIN
            --NÚMERO DE CONTRATOS POR RUC20
            (SELECT obtener_tipodoc_2(RUCCOMPANIA) TIPODOC2
                            , RUCCOMPANIA
                            , count(distinct codigocontratobscs) numcontratos
                        FROM fotoequipos
                       WHERE estadocontrato in ('Activo','Suspendido')
                         AND product not like '%Pre%'
                         AND obtener_tipodoc_2(RUCCOMPANIA) = 'RUC20'
                    GROUP BY  RUCCOMPANIA ) CCONTRATOS
            ON foto.RUCCOMPANIA  = CCONTRATOS.RUCCOMPANIA
            LEFT JOIN cc_especiales e
            ON foto.RUCCOMPANIA = e.RUCCOMPANIA;
        COMMIT;

        BEGIN paquete_riesgos.cc_roaming3g_notificar (V_FECHA,1);  END;
        BEGIN paquete_riesgos.cc_roaming3g_notificar (V_FECHA,2);  END;

    ELSE

        BEGIN paquete_riesgos.CC_ROAMING_REPORTE_GC (V_FECHA); END;

    END IF;

END cc_roaming3g_procesar;

PROCEDURE cc_roaming3g_notificar (V_FECHA IN DATE, V_TIPO_ALERTA NUMBER ) IS
  HTML CLOB;
  HTML2 CLOB;
  P_TO VARCHAR2(200);
  P_TO2 VARCHAR2(200);
  P_TO3 VARCHAR2(200);
  P_TO4 VARCHAR2(200);
  P_TO5 VARCHAR2(200);
  P_TO6 VARCHAR2(200);
  P_TO7 VARCHAR2(200);
  P_TO8 VARCHAR2(200);
  P_TO9 VARCHAR2(200);
  P_TO10 VARCHAR2(200);
  P_TO11 VARCHAR2(200);
  P_TO12 VARCHAR2(200);
  P_FROM VARCHAR2(200);
  P_SUBJECT VARCHAR2(200);
  P_TEXT VARCHAR2(200);
  P_HTML CLOB;
  P_SMTP_HOSTNAME VARCHAR2(200);
  P_SMTP_PORTNUM VARCHAR2(200);
  finicio varchar2(30);
  V_TABLA varchar2(60);
  ffin varchar2(30);

  text_aux varchar2(1000);
BEGIN

        EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS = ''. ''';

        IF V_TIPO_ALERTA = 1 THEN text_aux :='DNI/RUC10 con menos de 3 meses' ;
        ELSIF V_TIPO_ALERTA = 2 THEN text_aux :='RUC20 y DNI/RUC10 con más de 3 meses' ;
        END IF;

        HTML := '<h1 style = "font-size:20px;font-family:sans-serif; ">'||
                        'Alerta de usuarios que sobrepasan el l&iacute;mite de consumo en Roaming - ' || TO_CHAR(V_FECHA,'DD/MM/YYYY') ||
                '</h1>'||
                '<h2 style = "font-size:16px;font-family:sans-serif; ">' || text_aux  || '</h2>' ||


         '<style>'||
                        '  table { margin:0px;padding:0px;'||
                             '   border:1px solid #000000;'||
                             '   border-collapse: collapse;'||
                              '   border-spacing: 0;'||
                             '   height:100%;'||
                             '   margin:0px;padding:0px;'||
                           ' } .fr td{ '||
                               ' background-color:#3177e0;'||
                               ' text-align:center;'||
                               ' border-width:0px 0px 1px 1px;'||
                               ' font-size:12px;'||
                               ' font-family:sans-serif;'||
                               ' font-weight:bold;'||
                               ' color:#ffffff;'||
                           ' }  td{'||
                            '    vertical-align:middle;'||
                            '    background-color:#ffffff;'||
                            '    border:1px solid #000000;'||
                             '   border-width:0px 1px 1px 0px;'||
                             '   text-align:left;'||
                             '   padding:5px;'||
                             '   font-size:10px;'||
                              '  font-family:sans-serif;'||
                              '  color:#000000;'||
                           ' }' ||
                     '</style>' ;

            IF V_TIPO_ALERTA = 1 THEN
                text_aux :=' <p style = "font-size:14px;font-family:sans-serif; ">L&iacute;mite de consumos: <br>'||
                '&nbsp&nbsp Persona natural, RUC10: S/. 300 <br>';
            ELSIF V_TIPO_ALERTA = 2 THEN
                text_aux :=' <p style = "font-size:14px;font-family:sans-serif; ">L&iacute;mite de consumos: <br>'||
                '&nbsp&nbsp Persona natural, RUC10: S/. 500 <br>'||
                '&nbsp&nbsp RUC20: <br>'||
                '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp De 1 a 3 unidades S/. 500 por contrato <br>'||
                '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp De 4 a 10 unidades S/. 800 por contrato <br>'||
                '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp De 11 a 19 unidades S/ 1,200 por contrato <br>'||
                '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp De 20 a 79 unidades S/. 2,000 por contrato <br>'||
                '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp De 80 a más unidades, hasta S/. 4,500 por contrato <br> </p>';
            END IF;
            HTML := HTML || text_aux ||'<table  border="1">'||
                    '<tr class="fr"><td>Ciclo</td>'||
                                    '<td>Tipo de persona</td>'||
                                  --  '<td>Tipo de cuenta</td>'||
                                    '<td>Raz&oacute;n Social</td>'||
                                    '<td>Fecha proceso</td>'||
                                  --  '<td>Cod. Plan</td>'||
                                    '<td>Plan tarifario</td>'||
                                  -- '<td>IMSI</td>'||
                                    '<td>Tel&eacute;fono</td>'||
                                    '<td>Llamadas (minutos)</td>'||
                                    '<td>Monto llamadas</td>'||
                                    '<td>Mensajes</td>'||
                                    '<td>Monto mensajes</td>'||
                                  --  '<td>Datos (KB)</td>'||
                                  --  '<td>Monto datos</td>'||
                                    '<td>Monto S/.</td>'||
                                    '<td>Monto cuenta S/.</td>'||
                                  --  '<td>Periodo facturación</td>'||
                                    '<td>Fecha inicial</td>'||
                                    '<td>Fecha final</td>'||
                                    '<td>L&iacute;mite cr&eacute;dito contrato S/.</td>'||
                                    '<td>Validaci&oacuten</td>'||
                                    '<td>Empleado</td>'||
                                    '<td>Periodo Fact.</td>'||

                                    '</tr>';
            FOR REC IN
              (  SELECT * FROM
                    (SELECT  a.tipopersona,
                             a.tipocuenta,
                             a.compania,
                             a.fecha_proceso,
                             a.imsi,
                             a.telefono,
                             a.consumoLlamadas_minutos,
                             a.montoLlamadas,
                             a.consumoMensajes_cant,
                             a.montoMensajes,
                             a.consumoDatos_KB,
                             a.montoDatos,
                             a.monto_total,
                             a.totalcuenta,
                             a.fechaini,
                             a.fechafin,
                             null limite_cred, --NVL(CREDITO.limitecreditocuenta,0) limite_cred,
                             a.LIMITE_EMPRESA ,
                             a.numcontratos ,
                             a.c_plan,
                             p.n_plan,
                             NVL(validacion.validacion,'ACTIV. ANTES DE BIO')validacion
                             , emp.modalidad_contratacion
                             , a.periodo_facturacion
                             , a.ciclo
                             , row_number() over (ORDER BY monto_total DESC) rn
                       FROM  cc_roaming3g_ciclo a
                       LEFT JOIN pm_planes p
                         ON  a.c_plan = p.c_plan
                       LEFT JOIN fotoequipos foto
                         ON a.contrato = foto.codigocontratobscs
                       LEFT JOIN (SELECT * FROM P_EMPLEADO WHERE activo = 1) emp
                         ON foto.ruccompania = emp.dni
                       LEFT JOIN
                            (SELECT contrato
                                 , DECODE(validacion_identidad,'NOT BIOMETRIC','NO BIO: ','BIOMETRIC','BIO: ',validacion_identidad)
                                 ||DECODE(resultado_validacion,'NO VALIDADO','',resultado_validacion) VALIDACION
                            FROM p_inar
                            WHERE estadoinar in ('NEWS','ADDS','REAC')) validacion
                          ON a.contrato = validacion.contrato
                       WHERE totalcuenta>=DECODE(a.tipopersona  , 'Natural' ,200
                                                            , 'Empleado' ,200
                                                            , 500)
                         AND fecha_proceso = TRUNC(V_FECHA)
                         AND fechafin >= TRUNC(V_FECHA)-7
                         AND NVL(monto_total,0)/NVL( LIMITE_EMPRESA,0.01) > 0.2
                         AND foto.estadocontrato <> 'Desactivado'
                         AND tipo_alerta = V_TIPO_ALERTA
                    ORDER BY DECODE ( a.tipopersona,'Empleado',1,'Natural',2,'Jurídica',3), totalcuenta desc, monto_total desc, tipocuenta
                    )
                    WHERE rn <= 80
                ) --FIN REC

              LOOP

              HTML := HTML  || '<tr><td>' || REC.ciclo ||'</td>'||
                                    '<td>' ||REC.tipopersona||'</td>'||
                                   -- '<td>' ||  REC.tipocuenta || '</td>'||
                                    '<td>' ||  REC.compania || '</td>'||
                                    '<td>' || REC.fecha_proceso || '</td>'||
                                   -- '<td>' || REC.c_plan || '</td>'||
                                    '<td>' || REC.n_plan || '</td>'||
                                   -- '<td>' ||  REC.imsi || '</td>'||
                                    '<td>' ||  REC.telefono || '</td>'||
                                    '<td>' ||  REC.consumoLlamadas_minutos|| '</td>'||
                                    '<td>' ||  REC.montoLlamadas|| '</td>'||
                                    '<td>' ||  REC.consumoMensajes_cant|| '</td>'||
                                    '<td>' ||  REC.montoMensajes|| '</td>'||
                                    --'<td>' ||  REC.consumoDatos_KB|| '</td>'||
                                    --'<td>' ||  REC.montoDatos || '</td>'||
                                    '<td>' ||  REC.monto_total || '</td>'||
                                    '<td>' || REC.totalcuenta || '</td>'||
                                    '<td>' || REC.fechaini || '</td>'||
                                    '<td>' || REC.fechafin || '</td>'||
                                    '<td>' || REC.LIMITE_EMPRESA ||'</td>'||
                                    '<td>' || REC.validacion ||'</td>'||
                                    '<td>' || REC.modalidad_contratacion ||'</td>'||
                                    '<td>' || REC.periodo_facturacion ||'</td>'||

                                    '</tr>';

            END LOOP;
            HTML := HTML || '</table>';


            P_TO  := 'alejandra.linares@entel.pe';
            P_TO2 := 'andres.bravo@entel.pe';
            P_TO3 := 'ana.ramos@entel.pe';
            --P_TO4 := 'angelica.valdes@entel.pe';
            P_TO4 := 'Finanzas.ControldeConsumos@entel.pe';
            P_TO5 := 'candie.chang@entel.pe';
            P_TO6 := 'gianfranco.salvatierra@entel.pe';
            P_TO7 := 'manuel.tello@entel.pe';
            P_TO8 := 'karlos.hernandez@entel.pe';
            P_TO9 := 'katya.campos@entel.pe';
            P_FROM:= 'ip_alertas@entel.pe';
            P_TO10 := 'jcarvallo@rcpasesores.com';
            P_TO11 := 'msaavedra@rcpasesores.com';
            P_TO12 := 'bzegarra@rcpasesores.com';



            IF V_TIPO_ALERTA = 1 THEN text_aux :='DNI/RUC10 3M-' ;
            ELSIF V_TIPO_ALERTA = 2 THEN text_aux :='RUC20 y DNI/RUC10 3M+' ;
            END IF;

            P_SUBJECT := 'Alerta de consumos Roaming - '||text_aux ;
            P_TEXT := 'msg';
            P_HTML := HTML;
            --P_SMTP_HOSTNAME := 'relay-alertas.entel.pe';
            P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
            P_SMTP_PORTNUM := '25';

            BEGIN HTML_EMAIL(    P_TO => P_TO,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO2,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO3,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO4,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO5,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO6,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO7,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO8,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO9,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO10,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO11,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
            BEGIN HTML_EMAIL(    P_TO => P_TO12,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

END cc_roaming3g_notificar;

PROCEDURE BUSCAR_PRE_EVALUACIONES(P_RUCCOMPANIA VARCHAR2,pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
select NVL(CORRELATIVO,'-')CORRELATIVO
      ,NVL(NOMBRE_CLIENTE,'-')NOMBRE_CLIENTE
      ,NVL(RUCCOMPANIA,'-')RUCCOMPANIA
      ,NVL(TIPODOCUMENTO,'-')TIPODOCUMENTO
      ,NVL(PROMOTOR,'-')PROMOTOR
      ,NVL(TO_CHAR(CAPACIDADENDEUDAMIENTO),'-')CAPACIDADENDEUDAMIENTO
      ,NVL(MODELO,'-')MODELO
      ,NVL(TO_CHAR(NPCREATEDDATE),'-')NPCREATEDDATE
      ,NVL(TO_CHAR(VALORINCOMEPREDICTOR),'-')VALORINCOMEPREDICTOR
      ,NVL(NUMERO_OPERACION,'-')NUMERO_OPERACION
      ,NVL(MOTIVO,'-')MOTIVO
      ,NVL(DETALLE_MOTIVO,'-')DETALLE_MOTIVO
      ,NVL(COMPANIA,'-')COMPANIA
      ,NVL(RESULTADOEVALUACION,'-')RESULTADOEVALUACION
      ,NVL(BANCARIZACION,'-')BANCARIZACION
      ,NVL(TO_CHAR(VALORTOPEEQUIPOS),'-')VALORTOPEEQUIPOS
      ,NVL(TO_CHAR(RIESGOFINANCIERO),'-')RIESGOFINANCIERO
      ,NVL(TO_CHAR(TYPECUSTOMER),'-')TYPECUSTOMER
      ,NVL(DESTYPECUSTOMER,'-')DESTYPECUSTOMER
      ,NVL(TO_CHAR(PERIODO),'-')PERIODO
      ,NVL(TIPO_OPERACION,'-')TIPO_OPERACION
      ,NVL(TO_CHAR(FECHAPROCESO),'-')FECHAPROCESO
      ,NVL(TO_CHAR(FECHACREACION,'dd/mm/yyyy hh24:mm:ss'),'-')FECHACREACION
      ,NVL(PREEV_PDV,'-')PREEV_PDV
      ,NVL(NUMERO_PREEVALUADO,'-')NUMERO_PREEVALUADO
FROM
    TNP_PRE_EVALUACIONES
WHERE
RUCCOMPANIA = P_RUCCOMPANIA
ORDER BY
FECHACREACION ASC;

END BUSCAR_PRE_EVALUACIONES;

PROCEDURE BUSCAR_PREEVALUACIONES_MASIVA(pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
select NVL(CORRELATIVO,'-')CORRELATIVO
      ,NVL(NOMBRE_CLIENTE,'-')NOMBRE_CLIENTE
      ,NVL(RUCCOMPANIA,'-')RUCCOMPANIA
      ,NVL(TIPODOCUMENTO,'-')TIPODOCUMENTO
      ,NVL(PROMOTOR,'-')PROMOTOR
      ,NVL(TO_CHAR(CAPACIDADENDEUDAMIENTO),'-')CAPACIDADENDEUDAMIENTO
      ,NVL(MODELO,'-')MODELO
      ,NVL(TO_CHAR(NPCREATEDDATE),'-')NPCREATEDDATE
      ,NVL(TO_CHAR(VALORINCOMEPREDICTOR),'-')VALORINCOMEPREDICTOR
      ,NVL(NUMERO_OPERACION,'-')NUMERO_OPERACION
      ,NVL(MOTIVO,'-')MOTIVO
      ,NVL(DETALLE_MOTIVO,'-')DETALLE_MOTIVO
      ,NVL(COMPANIA,'-')COMPANIA
      ,NVL(RESULTADOEVALUACION,'-')RESULTADOEVALUACION
      ,NVL(BANCARIZACION,'-')BANCARIZACION
      ,NVL(TO_CHAR(VALORTOPEEQUIPOS),'-')VALORTOPEEQUIPOS
      ,NVL(TO_CHAR(RIESGOFINANCIERO),'-')RIESGOFINANCIERO
      ,NVL(TO_CHAR(TYPECUSTOMER),'-')TYPECUSTOMER
      ,NVL(DESTYPECUSTOMER,'-')DESTYPECUSTOMER
      ,NVL(TO_CHAR(PERIODO),'-')PERIODO
      ,NVL(TIPO_OPERACION,'-')TIPO_OPERACION
      ,NVL(TO_CHAR(FECHAPROCESO),'-')FECHAPROCESO
      ,NVL(TO_CHAR(FECHACREACION,'dd/mm/yyyy hh24:mm:ss'),'-')FECHACREACION
      ,NVL(PREEV_PDV,'-')PREEV_PDV
      ,NVL(NUMERO_PREEVALUADO,'-')NUMERO_PREEVALUADO
FROM
    TNP_PRE_EVALUACIONES
WHERE
RUCCOMPANIA IN (
                  select case when (length(doc)<8)
                          then lpad(doc,8,'0')
                         else doc end doc
                  from Busqueda_Preevaluaciones
                )
ORDER BY
RUCCOMPANIA,FECHACREACION ASC;

END BUSCAR_PREEVALUACIONES_MASIVA;

PROCEDURE CC_DATOS_RESUMIR_PERIODO (V_FECHA DATE) IS

BEGIN

    dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Merge con fotoequipos');

    MERGE /*+PARALLEL(3) */ INTO (SELECT * FROM trafico_internet_resumen
                                    WHERE CONTRATO = 0
                                      AND fecha > TRUNC(V_FECHA) - 10) A
           USING (  SELECT CODIGOCONTRATOBSCS,
                           CICLOFACTURACIONCONTRATO,
                           CODIGOPLANTARIFARIOBSCS,
                           CODIGOCOMPANIA,
                           NUMEROCUENTARESPONSABLE,
                           TELEFONO,
                           FECHAACTIVACIONCONTRATO
                      FROM ( SELECT a.*
                                  , row_number() over (PARTITION BY telefono
                                                           ORDER BY DECODE(ESTADOCONTRATO,'Desactivado',2,1) ASC
                                                                  , fechacargacontrato desc) rn
                               FROM fotoequipos a)
                     WHERE rn = 1) B
           ON (TRIM(a.TELEFONO) = '51'||TRIM(b.TELEFONO))
           WHEN MATCHED THEN UPDATE SET A.CONTRATO = B.CODIGOCONTRATOBSCS
                                      , A.CICLO = B.CICLOFACTURACIONCONTRATO
                                      , A.C_PLAN = B.CODIGOPLANTARIFARIOBSCS
                                      , A.CODIGOCOMPANIA = B.CODIGOCOMPANIA
                                      , A.NUMEROCUENTARESPONSABLE = B.NUMEROCUENTARESPONSABLE;
    COMMIT;

    dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Resumir por periodo');
    EXECUTE IMMEDIATE 'TRUNCATE TABLE CC_DATOS_RESUMEN_CICLO_TEMP';
    --RESUMIR POR PERIODO DE FACTURACION
INSERT /*+APPEND PARALLEL(5)*/ INTO CC_DATOS_RESUMEN_CICLO_TEMP (contrato, telefono, c_plan, ciclo, periodo_fact,
           /*codigocuentaresponsable,*/ numerocuentaresponsable,
           codigocompania, mb, mb_libre, fecha_ini, fecha_fin, fecha_proceso)
    SELECT CONTRATO
         , TELEFONO
         , C_PLAN
         , CICLO
         , OBTENER_PERIODO_FACT_ACTUAL(CICLO,FECHA) PERIODO_FACT
        -- , CODIGOCUENTARESPONSABLE
         , NUMEROCUENTARESPONSABLE
         , CODIGOCOMPANIA
         , SUM(MB_TOTAL) MB
         , SUM(MB_LIBRE) MB_LIBRE
         , MIN(FECHA) FECHA_INI
         , MAX(FECHA) FECHA_FIN
         , SYSDATE fecha_proc
      FROM trafico_internet_resumen
     WHERE FECHA >= V_FECHA - 60
       AND FECHA <= V_FECHA
       AND C_PLAN IN (SELECT c_plan FROM CC_DATOS_BUCKET WHERE g_osiptel IN ('Postpago'/*,'Renta Control','Plan Control'*/))
     GROUP BY CONTRATO
            , telefono
            , C_PLAN
            , CICLO
            , OBTENER_PERIODO_FACT_ACTUAL(CICLO,FECHA)
          --  , CODIGOCUENTARESPONSABLE
            , NUMEROCUENTARESPONSABLE
            , CODIGOCOMPANIA;
COMMIT;

    BEGIN
        dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Crear indices');
        EXECUTE IMMEDIATE 'CREATE INDEX ODS_GPF.IDX_CCD_CPLAN ON ODS_GPF.CC_DATOS_RESUMEN_CICLO_TEMP (C_PLAN ASC) TABLESPACE BIGINDEX_TBS';
        EXECUTE IMMEDIATE 'CREATE INDEX ODS_GPF.IDX_CCD_COMP ON ODS_GPF.CC_DATOS_RESUMEN_CICLO_TEMP(CODIGOCOMPANIA ASC) TABLESPACE BIGINDEX_TBS';

        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.put_line( 'ÍNDICE YA EXISTE' );
    END;


    dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Completar datos del plan');
    --AGREGAR CAMPOS DEL PLAN
    MERGE /*+ PARALLEL(3) */
     INTO CC_DATOS_RESUMEN_CICLO_TEMP D
    USING CC_DATOS_BUCKET P
       ON (D.C_PLAN = P.C_PLAN)
     WHEN MATCHED THEN UPDATE SET D.n_plan = P.n_plan
                                , D.tipo_plan = P.g_osiptel
                                , D.bucket_mb = DECODE(P.ilimitado, 'SI', 'Ilimitado', P.mb)
                                , D.adic_mb = CASE WHEN P.ilimitado is null
                                                    AND ((D.mb - NVL(D.mb_libre,0)) - P.mb) > 0
                                                   THEN ((D.mb - NVL(D.mb_libre,0)) - P.mb)
                                              ELSE 0 END
                                , D.adic_precio = CASE WHEN P.ilimitado is null
                                                          AND ((D.mb - NVL(D.mb_libre,0)) - P.mb) > 0
                                                         THEN ROUND(((D.mb - NVL(D.mb_libre,0)) - P.mb)* CASE WHEN NVL(P.mb_adic,0) > 0 THEN P.mb_adic ELSE P.kb_adic*1024 END ,2)
                                                         ELSE 0 END;

    COMMIT;

    dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Completar datos de la compañía');
    --AGREGAR CAMPOS DE LA COMPAÑÍA
    MERGE /*+ PARALLEL(3) */
     INTO CC_DATOS_RESUMEN_CICLO_TEMP D
    USING P_COMPANIA C
       ON (D.CODIGOCOMPANIA = C.CODIGOCOMPANIA)
     WHEN MATCHED THEN UPDATE SET D.COMPANIA = C.RAZONSOCIAL
                                , D.RUCCOMPANIA = C.RUCCOMPANIA
                                , D.CONTRATOS_COMP = C.EQUIPOSACTIVOSPOSTPAGO;

    COMMIT;

    dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Copiar a tabla CC_DATOS_RESUMEN_CICLO');
    DELETE FROM CC_DATOS_RESUMEN_CICLO WHERE PERIODO_FACT = OBTENER_PERIODO_FACT_ACTUAL(CICLO,V_FECHA);
    COMMIT;

    INSERT /*+APPEND*/ INTO CC_DATOS_RESUMEN_CICLO
    SELECT * FROM CC_DATOS_RESUMEN_CICLO_TEMP
     WHERE PERIODO_FACT = OBTENER_PERIODO_FACT_ACTUAL(CICLO,V_FECHA);

    COMMIT;


    BEGIN
        dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Drop index');
        EXECUTE IMMEDIATE 'DROP INDEX IDX_CCD_CPLAN';
        EXECUTE IMMEDIATE 'DROP INDEX IDX_CCD_COMP';
        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.put_line( 'ÍNDICE YA EXISTE' );
    END;

    dbms_output.put_line(TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') || ' : Fin del proceso');

END CC_DATOS_RESUMIR_PERIODO;

PROCEDURE CC_DATOS_NOTIFICAR (V_FECHA DATE) IS
BEGIN
    BEGIN paquete_riesgos.cc_datos_notificar_tplan (V_FECHA,'Comercial'); END;
    BEGIN paquete_riesgos.cc_datos_notificar_tplan (V_FECHA,'No Comercial'); END;

    EXECUTE IMMEDIATE 'ALTER TABLE CC_DATOS_RESUMEN_CICLO MOVE';
    DBMS_STATS.GATHER_TABLE_STATS (OWNNAME => 'ODS_GPF',TABNAME=>'CC_DATOS_RESUMEN_CICLO',DEGREE=>4,ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE, GRANULARITY =>'ALL',CASCADE => TRUE);
END CC_DATOS_NOTIFICAR;

PROCEDURE cc_datos_obtener_resumen ( C_FECHA IN VARCHAR2, pcursor OUT t_cursor) IS
BEGIN

OPEN pcursor FOR

SELECT * FROM
        (SELECT a.contrato
             , a.telefono
             , a.c_plan
             , a.ciclo
             , a.periodo_fact
             , a.codigocuentaresponsable
             , a.numerocuentaresponsable
             , a.codigocompania
             , a.mb
             , a.mb_whatsapp
             , TO_CHAR(a.fecha_ini,'DD-MM-YYYY') fecha_ini
             , TO_CHAR(a.fecha_fin,'DD-MM-YYYY') fecha_fin
             , a.n_plan
             , a.tipo_plan
             , a.bucket_mb
             , a.adic_mb
             , a.adic_precio
             , a.compania
             , a.ruccompania
             , a.contratos_comp
             , TO_CHAR(a.fecha_proceso,'DD-MM-YYYY') fecha_proceso
             , (a.mb - a.mb_whatsapp) mb_neto
             , DECODE(obtener_tipodoc_2(RUCCOMPANIA),'RUC20',
                    CASE WHEN  contratos_comp < 4  THEN 500
                         WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800
                         WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200
                         WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000
                         WHEN  contratos_comp >=80 THEN 4500
                    END
                       , 500 )  LIMITE_CC
             , ROUND(a.adic_precio / DECODE(obtener_tipodoc_2(RUCCOMPANIA),'RUC20',
                    CASE WHEN  contratos_comp < 4  THEN 500
                         WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800
                         WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200
                         WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000
                         WHEN  contratos_comp >=80 THEN 4500
                    END , 500 ) ,4 ) RATIO_LDC
          FROM cc_datos_resumen_ciclo a
         WHERE TRUNC(FECHA_PROCESO) = TRUNC(TO_DATE(C_FECHA,'DD/MM/YYYY'))
           AND adic_mb is not null
           AND a.tipo_plan = 'Postpago'
         ORDER BY (a.adic_precio / DECODE(obtener_tipodoc_2(RUCCOMPANIA),'RUC20',
                    CASE WHEN  contratos_comp < 4  THEN 500
                         WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800
                         WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200
                         WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000
                         WHEN  contratos_comp >=80 THEN 4500
                    END , 500 )) DESC )
 WHERE ROWNUM<5000;

END cc_datos_obtener_resumen;

PROCEDURE CC_ROAM_OUTBOUND_RES
IS
    --V_MIN_PERIODOFACTURACION VARCHAR2(6) := TO_CHAR(SYSDATE,'YYYYMM');
    V_UMBRAL_PERSONA ROAMING_GGSN_UMBRAL.monto%TYPE;
    V_UMBRAL_EMPRESA ROAMING_GGSN_UMBRAL.monto%TYPE;
    V_TARIFA_BANDA_1 ROAMING_GGSN_TARIFA.tarifa%TYPE;
    V_TARIFA_BANDA_2 ROAMING_GGSN_TARIFA.tarifa%TYPE;
    V_TARIFA_BANDA_PROMEDIO ROAMING_GGSN_TARIFA.tarifa%TYPE;
BEGIN

    SELECT MONTO INTO V_UMBRAL_PERSONA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'PERSONA' AND ACTIVO = 1 AND ROWNUM = 1;
    SELECT MONTO INTO V_UMBRAL_EMPRESA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'EMPRESA' AND ACTIVO = 1 AND ROWNUM = 1;

    SELECT TARIFA INTO V_TARIFA_BANDA_1 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 1 AND ACTIVO = 1 AND ROWNUM = 1;
    SELECT TARIFA INTO V_TARIFA_BANDA_2 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 2 AND ACTIVO = 1 AND ROWNUM = 1;
    V_TARIFA_BANDA_PROMEDIO := (V_TARIFA_BANDA_1+V_TARIFA_BANDA_2)/2;

    --------------------------------------------------------------------------
    -- TABLA RESUMEN

    --Borrar registros del periodo de facturacion actual (se obtiene según el ciclo de facturacion de cada cliente)
    DELETE FROM ROAMING_GGSN_RESUMEN
    WHERE   PERIODOFACTURACION =
                    (CASE TO_NUMBER(CICLOFACTURACION)
                        WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                        WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                        WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                        WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                    END); --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
    COMMIT;

    --Insertar nuevo consumo del periodo de facturacion actual (de esta manera se actualiza su consumo)
    INSERT INTO ROAMING_GGSN_RESUMEN
    (FECHAPROCESO, PERIODOFACTURACION, MINFECHACDR, MAXFECHACDR, TIPOCLIENTE, RUCCOMPANIA, CODIGOCOMPANIA, RAZONSOCIAL, CODIGOCONTRATOBSCS,
    IMSI, TELEFONO, ESTADOCONTRATO, FECHACARGACONTRATO, CICLOFACTURACION, CONSUMO_KB, CONSUMO_MB, PAIS_MAYOR_CONSUMO, MONTO_CONTRATO, T_PLAN)
    SELECT
        SYSDATE
        ,D.periodofacturacion
        , MIN(TO_NUMBER(SUBSTR(D.recopentim,1,8))) AS MINFechaCDR
        , MAX(TO_NUMBER(SUBSTR(D.recopentim,1,8))) AS MAXFechaCDR
        , (CASE
            WHEN UPPER(TRIM(f.PLANTARIFARIO)) LIKE '%EMPLEADO%' AND UPPER(TRIM(f.PLANTARIFARIO)) NOT LIKE '%ILIMITADO%'
                THEN 'Empleado'
            ELSE (CASE
                    WHEN d.tipoDocumento = 'RUC20' THEN 'Empresa'
                    ELSE 'Natural'
                END)
        END) AS TipoCliente
        , F.RUCCOMPANIA
        , F.CODIGOCOMPANIA
        , TRIM(F.COMPANIA) AS RAZONSOCIAL
        , F.CODIGOCONTRATOBSCS
        , D.serimsi as imsi
        , D.sermsisdn
        , F.ESTADOCONTRATO
        , F.FECHACARGACONTRATO
        , D.ciclofacturacion AS CICLOFACTURACIONCONTRATO
        , SUM(VOLDOWN+VOLUP)/1024 AS CONSUMO_KB
        , SUM(VOLDOWN+VOLUP)/1024/1024 AS CONSUMO_MB
        , PAIS.PAIS_MAYOR_CONSUMO
        , SUM( (VOLDOWN+VOLUP)*TARIFA )/1024 AS MONTO
        , F.T_PLAN
        --, 0.0 as Tarifa_x_KB_Soles
        --, '' AS Ultima_Fecha_ConsumoTap
        --, '' as banda
        --, ROW_NUMBER() OVER(PARTITION BY D.sermsisdn ORDER BY F.FECHACARGACONTRATO DESC, F.FECHAACTIVACIONCONTRATO desc) AS RN
    FROM
        ROAMING_GGSN_CDR D,
        ( SELECT    *
            FROM (
                    SELECT  FE.CODIGOCOMPANIA, FE.RUCCOMPANIA, FE.COMPANIA, FE.PLANTARIFARIO, FE.FECHACARGACONTRATO, FE.CICLOFACTURACIONCONTRATO, FE.TELEFONO, FE.CODIGOCONTRATOBSCS, FE.ESTADOCONTRATO, P.T_PLAN,
                            ROW_NUMBER() OVER(PARTITION BY FE.TELEFONO ORDER BY FE.FECHACARGACONTRATO DESC, FE.FECHAACTIVACIONCONTRATO desc, FE.codigocontratobscs desc) AS RN
                    FROM    ODS_GPF.FOTOEQUIPOS FE LEFT JOIN ODS_GPF.PM_PLANES P ON FE.CODIGOPLANTARIFARIOBSCS = P.C_PLAN
                 )
            WHERE RN = 1
          ) F,
        (
            --PAIS CON MAYOR CONSUMO
            select serimsi, pais AS PAIS_MAYOR_CONSUMO
            from
                (
                SELECT  SERIMSI,
                        PAIS,
                        ROW_NUMBER() over (partition by serimsi order by SUM(VOLDOWN+VOLUP) desc) rn
                FROM    ROAMING_GGSN_CDR
                WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                                    WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                    WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                    WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                    WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                        END) --PERIODOFACTURACION DE CADA IMSI, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                GROUP BY SERIMSI, PAIS
                )
            where rn = 1
            ) PAIS
    WHERE
        substr(D.sermsisdn,3,length(d.sermsisdn)-2) = F.TELEFONO
        AND D.SERIMSI = PAIS.SERIMSI
        AND D.periodofacturacion = (CASE TO_NUMBER(D.ciclofacturacion)
                                WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                    END) --PERIODOFACTURACION DE CADA IMSI, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
    GROUP BY
        D.periodofacturacion
        , (CASE
                WHEN UPPER(TRIM(f.PLANTARIFARIO)) LIKE '%EMPLEADO%' AND UPPER(TRIM(f.PLANTARIFARIO)) NOT LIKE '%ILIMITADO%'
                    THEN 'Empleado'
                ELSE (CASE
                        WHEN d.tipoDocumento = 'RUC20' THEN 'Empresa'
                        ELSE 'Natural'
                    END)
            END)
        , F.RUCCOMPANIA
        , F.CODIGOCOMPANIA
        , TRIM(F.COMPANIA)
        , F.CODIGOCONTRATOBSCS
        , D.serimsi
        , D.sermsisdn
        , F.ESTADOCONTRATO
        , F.FECHACARGACONTRATO
        , D.ciclofacturacion
        , PAIS.PAIS_MAYOR_CONSUMO
        , F.T_PLAN;
    --ORDER BY RAZONSOCIAL, MINFECHACDR
    COMMIT;

    --------------------------------------------------------------------------
    -- TABLA ALERTA

    DELETE FROM ROAMING_GGSN_EXCESOS
    WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                        WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                        WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                        WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                        WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                    END); --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)

    INSERT INTO ROAMING_GGSN_EXCESOS
    (periodofacturacion, minfechacdr, maxfechacdr, tipocliente, ruccompania, codigocompania, razonsocial, codigocontratobscs,
     imsi, telefono, estadocontrato, fechacargacontrato, ciclofacturacion, consumo_kb, consumo_mb, pais_mayor_consumo, monto_contrato,
     umbral, /*limitecredito,*/ fechaproceso, t_plan)
        SELECT  periodofacturacion, minfechacdr, maxfechacdr, tipocliente, ruccompania, codigocompania, razonsocial, codigocontratobscs,
                imsi, telefono, estadocontrato, fechacargacontrato, ciclofacturacion, consumo_kb, consumo_mb, pais_mayor_consumo, monto_contrato,
                decode(tipoCliente,'Empresa',V_UMBRAL_EMPRESA,V_UMBRAL_PERSONA) AS umbral,SYSDATE, t_plan
        FROM    ROAMING_GGSN_RESUMEN
        WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                            WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                            WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                            WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                            WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                        END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                AND codigocompania IN --seleccionar solo las compañías cuyo suma de montos de sus contratos excedan su umbral
                    (
                    SELECT      codigocompania
                    FROM        ROAMING_GGSN_RESUMEN
                    WHERE       periodoFacturacion = (CASE TO_NUMBER(ciclofacturacion)
                                            WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                            WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                            WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                            WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                        END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                    GROUP BY    codigocompania, tipoCliente
                    HAVING      (CASE WHEN tipoCliente = 'Empresa' THEN sum(monto_contrato) END) >= V_UMBRAL_EMPRESA
                                OR
                                (CASE WHEN tipoCliente IN ('Natural','Empleado') THEN sum(monto_contrato) END) >= V_UMBRAL_PERSONA
                    );
    COMMIT;

END CC_ROAM_OUTBOUND_RES;

PROCEDURE CC_ROAM_OUTBOUND_RES_REPRO(P_FECHAACTUAL_SIMULADA IN VARCHAR2)
IS
    V_FECHAACTUAL_SIMULADA DATE := TO_DATE(P_FECHAACTUAL_SIMULADA,'YYYYMMDD');
    V_MIN_PERIODOFACTURACION VARCHAR2(6);
    V_UMBRAL_PERSONA ROAMING_GGSN_UMBRAL.monto%TYPE;
    V_UMBRAL_EMPRESA ROAMING_GGSN_UMBRAL.monto%TYPE;
    V_TARIFA_BANDA_1 ROAMING_GGSN_TARIFA.tarifa%TYPE;
    V_TARIFA_BANDA_2 ROAMING_GGSN_TARIFA.tarifa%TYPE;
    V_TARIFA_BANDA_PROMEDIO ROAMING_GGSN_TARIFA.tarifa%TYPE;
BEGIN

    V_MIN_PERIODOFACTURACION := TO_CHAR(V_FECHAACTUAL_SIMULADA,'YYYYMM');

    SELECT MONTO INTO V_UMBRAL_PERSONA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'PERSONA' AND ACTIVO = 1 AND ROWNUM = 1;
    SELECT MONTO INTO V_UMBRAL_EMPRESA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'EMPRESA' AND ACTIVO = 1 AND ROWNUM = 1;

    SELECT TARIFA INTO V_TARIFA_BANDA_1 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 1 AND ACTIVO = 1 AND ROWNUM = 1;
    SELECT TARIFA INTO V_TARIFA_BANDA_2 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 2 AND ACTIVO = 1 AND ROWNUM = 1;
    V_TARIFA_BANDA_PROMEDIO := (V_TARIFA_BANDA_1+V_TARIFA_BANDA_2)/2;

    --------------------------------------------------------------------------
    -- TABLA RESUMEN

    --Borrar registros del periodo de facturacion actual (se obtiene según el ciclo de facturacion de cada cliente)
    DELETE FROM ROAMING_GGSN_RESUMEN
    WHERE   PERIODOFACTURACION =
                    (CASE TO_NUMBER(CICLOFACTURACION)
                        WHEN 1 THEN V_MIN_PERIODOFACTURACION
                        WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                        WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                        WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                    END); --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
    COMMIT;

    --Insertar nuevo consumo del periodo de facturacion actual (de esta manera se actualiza su consumo)
    INSERT INTO ROAMING_GGSN_RESUMEN
    (FECHAPROCESO, PERIODOFACTURACION, MINFECHACDR, MAXFECHACDR, TIPOCLIENTE, RUCCOMPANIA, CODIGOCOMPANIA, RAZONSOCIAL, CODIGOCONTRATOBSCS,
    IMSI, TELEFONO, ESTADOCONTRATO, FECHACARGACONTRATO, CICLOFACTURACION, CONSUMO_KB, CONSUMO_MB, PAIS_MAYOR_CONSUMO, MONTO_CONTRATO, T_PLAN)
    SELECT
        SYSDATE
        ,D.periodofacturacion
        , MIN(TO_NUMBER(SUBSTR(D.recopentim,1,8))) AS MINFechaCDR
        , MAX(TO_NUMBER(SUBSTR(D.recopentim,1,8))) AS MAXFechaCDR
        , (CASE
            WHEN UPPER(TRIM(f.PLANTARIFARIO)) LIKE '%EMPLEADO%' AND UPPER(TRIM(f.PLANTARIFARIO)) NOT LIKE '%ILIMITADO%'
                THEN 'Empleado'
            ELSE (CASE
                    WHEN d.tipoDocumento = 'RUC20' THEN 'Empresa'
                    ELSE 'Natural'
                END)
        END) AS TipoCliente
        , F.RUCCOMPANIA
        , F.CODIGOCOMPANIA
        , TRIM(F.COMPANIA) AS RAZONSOCIAL
        , F.CODIGOCONTRATOBSCS
        , D.serimsi as imsi
        , D.sermsisdn
        , F.ESTADOCONTRATO
        , F.FECHACARGACONTRATO
        , D.ciclofacturacion AS CICLOFACTURACIONCONTRATO
        , SUM(VOLDOWN+VOLUP)/1024 AS CONSUMO_KB
        , SUM(VOLDOWN+VOLUP)/1024/1024 AS CONSUMO_MB
        , PAIS.PAIS_MAYOR_CONSUMO
        , SUM( (VOLDOWN+VOLUP)*TARIFA )/1024 AS MONTO
        , F.T_PLAN
        --, 0.0 as Tarifa_x_KB_Soles
        --, '' AS Ultima_Fecha_ConsumoTap
        --, '' as banda
        --, ROW_NUMBER() OVER(PARTITION BY D.sermsisdn ORDER BY F.FECHACARGACONTRATO DESC, F.FECHAACTIVACIONCONTRATO desc) AS RN
    FROM
        ROAMING_GGSN_CDR D,
        ( SELECT    *
            FROM (
                    SELECT  FE.CODIGOCOMPANIA, FE.RUCCOMPANIA, FE.COMPANIA, FE.PLANTARIFARIO, FE.FECHACARGACONTRATO, FE.CICLOFACTURACIONCONTRATO, FE.TELEFONO, FE.CODIGOCONTRATOBSCS, FE.ESTADOCONTRATO, P.T_PLAN,
                            ROW_NUMBER() OVER(PARTITION BY FE.TELEFONO ORDER BY FE.FECHACARGACONTRATO DESC, FE.FECHAACTIVACIONCONTRATO desc, FE.codigocontratobscs desc) AS RN
                    FROM    ODS_GPF.FOTOEQUIPOS FE LEFT JOIN ODS_GPF.PM_PLANES P ON FE.CODIGOPLANTARIFARIOBSCS = P.C_PLAN
                 )
            WHERE RN = 1
          ) F,
        (
            --PAIS CON MAYOR CONSUMO
            select serimsi, pais AS PAIS_MAYOR_CONSUMO
            from
                (
                SELECT  SERIMSI,
                        PAIS,
                        ROW_NUMBER() over (partition by serimsi order by SUM(VOLDOWN+VOLUP) desc) rn
                FROM    ROAMING_GGSN_CDR
                WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                                    WHEN 1 THEN V_MIN_PERIODOFACTURACION
                                    WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                    WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                    WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                        END) --PERIODOFACTURACION DE CADA IMSI, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                GROUP BY SERIMSI, PAIS
                )
            where rn = 1
            ) PAIS
    WHERE
        substr(D.sermsisdn,3,length(d.sermsisdn)-2) = F.TELEFONO
        AND D.SERIMSI = PAIS.SERIMSI
        AND D.periodofacturacion = (CASE TO_NUMBER(D.ciclofacturacion)
                                WHEN 1 THEN V_MIN_PERIODOFACTURACION
                                WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                    END) --PERIODOFACTURACION DE CADA IMSI, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
    GROUP BY
        D.periodofacturacion
        , (CASE
                WHEN UPPER(TRIM(f.PLANTARIFARIO)) LIKE '%EMPLEADO%' AND UPPER(TRIM(f.PLANTARIFARIO)) NOT LIKE '%ILIMITADO%'
                    THEN 'Empleado'
                ELSE (CASE
                        WHEN d.tipoDocumento = 'RUC20' THEN 'Empresa'
                        ELSE 'Natural'
                    END)
            END)
        , F.RUCCOMPANIA
        , F.CODIGOCOMPANIA
        , TRIM(F.COMPANIA)
        , F.CODIGOCONTRATOBSCS
        , D.serimsi
        , D.sermsisdn
        , F.ESTADOCONTRATO
        , F.FECHACARGACONTRATO
        , D.ciclofacturacion
        , PAIS.PAIS_MAYOR_CONSUMO
        , F.T_PLAN;
    --ORDER BY RAZONSOCIAL, MINFECHACDR
    COMMIT;

    --------------------------------------------------------------------------
    -- TABLA EXCESOS

    DELETE FROM ROAMING_GGSN_EXCESOS
    WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                        WHEN 1 THEN V_MIN_PERIODOFACTURACION
                        WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                        WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                        WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                    END); --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)

    INSERT INTO ROAMING_GGSN_EXCESOS
    (periodofacturacion, minfechacdr, maxfechacdr, tipocliente, ruccompania, codigocompania, razonsocial, codigocontratobscs,
     imsi, telefono, estadocontrato, fechacargacontrato, ciclofacturacion, consumo_kb, consumo_mb, pais_mayor_consumo, monto_contrato,
     umbral, /*limitecredito,*/ fechaproceso, t_plan)
        SELECT  periodofacturacion, minfechacdr, maxfechacdr, tipocliente, ruccompania, codigocompania, razonsocial, codigocontratobscs,
                imsi, telefono, estadocontrato, fechacargacontrato, ciclofacturacion, consumo_kb, consumo_mb, pais_mayor_consumo, monto_contrato,
                decode(tipoCliente,'Empresa',V_UMBRAL_EMPRESA,V_UMBRAL_PERSONA) AS umbral,SYSDATE, t_plan
        FROM    ROAMING_GGSN_RESUMEN
        WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                            WHEN 1 THEN V_MIN_PERIODOFACTURACION
                            WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                            WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                            WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                        END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                AND codigocompania IN --seleccionar solo las compañías cuyo suma de montos de sus contratos excedan su umbral
                    (
                    SELECT      codigocompania
                    FROM        ROAMING_GGSN_RESUMEN
                    WHERE       periodoFacturacion = (CASE TO_NUMBER(ciclofacturacion)
                                            WHEN 1 THEN V_MIN_PERIODOFACTURACION
                                            WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                            WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                            WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(V_FECHAACTUAL_SIMULADA,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(V_FECHAACTUAL_SIMULADA,1),'YYYYMM') else V_MIN_PERIODOFACTURACION end)
                                        END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                    GROUP BY    codigocompania, tipoCliente
                    HAVING      (CASE WHEN tipoCliente = 'Empresa' THEN sum(monto_contrato) END) >= V_UMBRAL_EMPRESA
                                OR
                                (CASE WHEN tipoCliente IN ('Natural','Empleado') THEN sum(monto_contrato) END) >= V_UMBRAL_PERSONA
                    );
    COMMIT;

END CC_ROAM_OUTBOUND_RES_REPRO;

PROCEDURE CC_ROAM_OUTBOUND_ALERTA
IS
    V_MIN_PERIODOFACTURACION VARCHAR2(6) := TO_CHAR(SYSDATE,'YYYYMM');
    V_UMBRAL_PERSONA ROAMING_GGSN_UMBRAL.monto%TYPE;
    V_UMBRAL_EMPRESA ROAMING_GGSN_UMBRAL.monto%TYPE;
    V_TARIFA_BANDA_1 ROAMING_GGSN_TARIFA.tarifa%TYPE;
    V_TARIFA_BANDA_2 ROAMING_GGSN_TARIFA.tarifa%TYPE;
    V_TARIFA_BANDA_PROMEDIO ROAMING_GGSN_TARIFA.tarifa%TYPE;
BEGIN

    SELECT MONTO INTO V_UMBRAL_PERSONA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'PERSONA' AND ACTIVO = 1 AND ROWNUM = 1;
    SELECT MONTO INTO V_UMBRAL_EMPRESA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'EMPRESA' AND ACTIVO = 1 AND ROWNUM = 1;

    SELECT TARIFA INTO V_TARIFA_BANDA_1 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 1 AND ACTIVO = 1 AND ROWNUM = 1;
    SELECT TARIFA INTO V_TARIFA_BANDA_2 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 2 AND ACTIVO = 1 AND ROWNUM = 1;
    V_TARIFA_BANDA_PROMEDIO := (V_TARIFA_BANDA_1+V_TARIFA_BANDA_2)/2;

    EXECUTE IMMEDIATE 'TRUNCATE TABLE temp_roaming_ggsn_rankalerta';

    INSERT INTO temp_roaming_ggsn_rankalerta
    (tipocliente, codigocompania, cantcontratos, totalcliente, limiteCredito, rank)
        select  a.tipocliente, a.codigocompania, b.cantcontratos, round(sum(monto_contrato),0) as totalcliente,
                (case
                    when SUBSTR(trim(b.RUCCOMPANIA),1,2) <> '20' then 500
                                when SUBSTR(trim(b.RUCCOMPANIA),1,2) = '20' and c.ruccompania IS NOT NULL then c.limiteCredito
                                when SUBSTR(trim(b.RUCCOMPANIA),1,2) = '20' and c.ruccompania IS NULL then
                      (case
                          when b.cantContratos <= 3 then 500
                          when b.cantContratos >= 4 and b.cantContratos <= 10 then 800
                          when b.cantContratos >= 11 and b.cantContratos <= 19 then 1200
                          when b.cantContratos >= 20 and b.cantContratos <= 79 then 2000
                          when b.cantContratos >= 80 then 4500
                      end)
                end) as limiteCredito,
                RANK() over(partition by a.tipoCliente order by ROUND(SUM(monto_contrato),0) desc) as rnk_monto
        from    ROAMING_GGSN_EXCESOS a,
                (
                select  cant_contratos.*
                from
                    (
                    select  COUNT(CODIGOCONTRATOBSCS) cantContratos, CODIGOCOMPANIA, RUCCOMPANIA
                    from    fotoequipos
                    where   upper(ESTADOCONTRATO) in ('ACTIVO','SUSPENDIDO')
                    group by CODIGOCOMPANIA, RUCCOMPANIA
                    ) cant_contratos,
                    (
                    select  distinct codigoCompania
                    from    ROAMING_GGSN_EXCESOS
                    where   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                                            WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                            WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                            WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                            WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                        END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                            AND upper(trim(t_plan)) = 'COMERCIAL'
                    ) comp_unico
                where cant_contratos.codigocompania = comp_unico.codigocompania
                ) b,
                (select * from roaming_ggsn_vip where activo = 1) c
        where   a.codigocompania = b.codigocompania
                and a.ruccompania = c.ruccompania(+)
                and a.periodofacturacion = (CASE TO_NUMBER(a.ciclofacturacion)
                                    WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                    WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                    WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                    WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                AND upper(trim(a.t_plan)) = 'COMERCIAL'
        group by
                a.tipocliente, a.codigocompania, b.cantcontratos,
                (case
                    when SUBSTR(trim(b.RUCCOMPANIA),1,2) <> '20' then 500
                                when SUBSTR(trim(b.RUCCOMPANIA),1,2) = '20' and c.ruccompania IS NOT NULL then c.limiteCredito
                                when SUBSTR(trim(b.RUCCOMPANIA),1,2) = '20' and c.ruccompania IS NULL then
                      (case
                          when b.cantContratos <= 3 then 500
                          when b.cantContratos >= 4 and b.cantContratos <= 10 then 800
                          when b.cantContratos >= 11 and b.cantContratos <= 19 then 1200
                          when b.cantContratos >= 20 and b.cantContratos <= 79 then 2000
                          when b.cantContratos >= 80 then 4500
                      end)
                end)
        order by a.tipocliente DESC, rnk_monto;

    COMMIT;

    --Setear en 0 la última alerta enviada para colocarle 1 a los nuevos registros de la alerta en el query siguiente
    UPDATE ROAMING_GGSN_ALERTA SET PARAENVIO = 0 WHERE PARAENVIO = 1;

    INSERT INTO ROAMING_GGSN_ALERTA
    (FECHAPROCESO,FECHAPROCESOCHAR,HORAPROCESOCHAR,PERIODOFACTURACION,MINFECHACDR,MAXFECHACDR,RANGO_CONSUMO,TIPOCLIENTE,
    RUCCOMPANIA,CODIGOCOMPANIA,RAZONSOCIAL,CODIGOCONTRATOBSCS,IMSI,TELEFONO,ESTADOCONTRATO,FECHACARGACONTRATO,CICLOFACTURACION,
    CONSUMO_KB,CONSUMO_MB,PAIS_MAYOR_CONSUMO,MONTO_CONTRATO,MONTO_CLIENTE,UMBRAL,LIMITECREDITO,PARAENVIO,ORDENLISTADO)
      SELECT  fechaproceso,fecha,hora,periodofacturacion,MINFECHACDR,MAXFECHACDR,rango_consumo,tipocliente,ruccompania,
              codigocompania,RAZONSOCIAL,CODIGOCONTRATOBSCS,IMSI,TELEFONO,ESTADOCONTRATO,FECHACARGACONTRATO,CICLOFACTURACION,
              CONSUMO_KB,CONSUMO_MB,PAIS_MAYOR_CONSUMO,MONTO_CONTRATO,TOTALCLIENTE,UMBRAL,LIMITECREDITO,PARAENVIO,RN
      FROM
              (
              SELECT  a.fechaproceso, to_char(a.fechaproceso,'yyyymmdd') fecha,
                      extract(hour from cast(to_char(fechaproceso, 'DD-MON-YYYY HH24:MI:SS') as timestamp)) hora,
                      a.periodofacturacion, a.MINFECHACDR, a.MAXFECHACDR,
                      (substr(TO_CHAR(to_date(minfechacdr,'yyyymmdd'), 'fmMonth'),1,3) || ' ' || substr(minfechacdr,7,2)
                      || ' - ' ||
                      substr(TO_CHAR(to_date(maxfechacdr,'yyyymmdd'), 'fmMonth'),1,3) || ' ' || substr(maxfechacdr,7,2))
                      as rango_consumo,
                      a.tipocliente, a.ruccompania, a.codigocompania, a.RAZONSOCIAL, a.CODIGOCONTRATOBSCS, a.IMSI,
                      a.TELEFONO, a.ESTADOCONTRATO, a.FECHACARGACONTRATO, a.CICLOFACTURACION, a.CONSUMO_KB, a.CONSUMO_MB,
                      a.PAIS_MAYOR_CONSUMO, a.MONTO_CONTRATO, b.TOTALCLIENTE, a.UMBRAL, b.LIMITECREDITO, 1 AS PARAENVIO --se setean los registros de la nueva alerta
                      ,ROW_NUMBER() OVER(ORDER BY b.TOTALCLIENTE DESC, a.MONTO_CONTRATO DESC) AS RN
              FROM    ROAMING_GGSN_EXCESOS a, TEMP_ROAMING_GGSN_RANKALERTA b
              WHERE   a.codigocompania = b.codigocompania
                      and a.periodofacturacion = (CASE TO_NUMBER(a.ciclofacturacion)
                                                WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                                WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                                WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                                WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                            END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                      and (trunc(sysdate) - to_date(a.maxfechacdr,'yyyymmdd') < 7)
                      and ROUND(a.monto_contrato/(case when b.LIMITECREDITO = 0 then 500 else b.LIMITECREDITO end),2) >= 0.20 --solo mostrar registros con un ratio mayor o igual al 20%
                      AND upper(trim(a.t_plan)) = 'COMERCIAL'
              )
      WHERE ROWNUM <= 45
      ORDER BY RN;
    COMMIT;

END CC_ROAM_OUTBOUND_ALERTA;

PROCEDURE CC_ROAM_OUTBOUND_CORREO
IS
  HTML CLOB;
  P_TO VARCHAR2(200);
  P_TO2 VARCHAR2(200);
  P_TO3 VARCHAR2(200);
  P_TO4 VARCHAR2(200);
  P_TO5 VARCHAR2(100);
  P_TO6 VARCHAR2(100);
  P_TO9 VARCHAR2(100);
  P_TO10 VARCHAR2(100);
  P_TO11 VARCHAR2(100);
  P_TO12 VARCHAR2(100);
  P_TO13 VARCHAR2(100);
  P_TO14 VARCHAR2(100);
  P_TO15 VARCHAR2(100);
  P_TO16 VARCHAR2(100);
  P_TO17 VARCHAR2(100);
  P_TO18 VARCHAR2(100);
  P_TO19 VARCHAR2(100);
  P_FROM VARCHAR2(200);
  P_SUBJECT VARCHAR2(200);
  P_TEXT VARCHAR2(200);
  P_HTML CLOB;
  P_SMTP_HOSTNAME VARCHAR2(200);
  P_SMTP_PORTNUM VARCHAR2(200);
  PCURSOR SYS_REFCURSOR;

  V_FECHAPROCESO VARCHAR2(30);
  V_UMBRAL_PERSONA VARCHAR2(20);
  V_UMBRAL_EMPRESA VARCHAR2(20);
  V_TARIFA_BANDA_1 ROAMING_GGSN_TARIFA.tarifa%TYPE;
  V_TARIFA_BANDA_2 ROAMING_GGSN_TARIFA.tarifa%TYPE;
  V_TARIFA_BANDA_PROMEDIO VARCHAR2(20);

BEGIN
  SELECT TO_CHAR(FECHAPROCESO,'DD/MM/YYYY HH24:MI') INTO V_FECHAPROCESO FROM ROAMING_GGSN_ALERTA WHERE PARAENVIO = 1 AND ROWNUM = 1;
  SELECT TO_CHAR(MONTO) INTO V_UMBRAL_PERSONA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'PERSONA' AND ACTIVO = 1 AND ROWNUM = 1;
  SELECT TO_CHAR(MONTO) INTO V_UMBRAL_EMPRESA FROM ROAMING_GGSN_UMBRAL WHERE UMBRAL = 'EMPRESA' AND ACTIVO = 1 AND ROWNUM = 1;
  SELECT TARIFA INTO V_TARIFA_BANDA_1 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 1 AND ACTIVO = 1 AND ROWNUM = 1;
  SELECT TARIFA INTO V_TARIFA_BANDA_2 FROM ROAMING_GGSN_TARIFA WHERE BANDA = 2 AND ACTIVO = 1 AND ROWNUM = 1;
  V_TARIFA_BANDA_PROMEDIO := TO_CHAR((V_TARIFA_BANDA_1+V_TARIFA_BANDA_2)/2);

  HTML := '<style>'
          || 'table {border-collapse: collapse; font:11px Arial, san-serif; text-align:left;} '
          || 'th {background:#ff6702; color:#fff; font-size:12px;} '
          || 'table, th, td {border:1px solid #333; padding:4px;} '
          || '.center {text-align:center;} '
          || '.left {text-align:left;} '
          || '.right {text-align:right;} '
          || 'h1 {font:20px Arial;} '
          || 'ul li {font:12px Arial, san-serif;}'
          || '</style>'

          || '<h1>Alerta de usuarios que sobrepasan el l&iacute;mite de consumo de Roaming en Datos:</h1>'

          || '<p>Fecha/hora proceso: ' || V_FECHAPROCESO || ' hrs.</p>'
          || '<ul>'
          ||    '<li>Umbral Personas: &nbsp;&nbsp;&nbsp;S/. ' || V_UMBRAL_PERSONA || '</li>'
          ||      '<li>Umbral Empresas: &nbsp;&nbsp;&nbsp;S/. ' || V_UMBRAL_EMPRESA || '</li>'
          ||      '<li>Tarifa Banda 1: &nbsp;&nbsp;&nbsp;S/ ' || TO_CHAR(V_TARIFA_BANDA_1) || ' x KB</li>'
          ||      '<li>Tarifa Banda 2: &nbsp;&nbsp;&nbsp;S/ ' || TO_CHAR(V_TARIFA_BANDA_2) || ' x KB</li>'
          ||      '<li>Tarifa No Banda: &nbsp;&nbsp;&nbsp;S/ ' || TO_CHAR(V_TARIFA_BANDA_PROMEDIO) || ' x KB (promedio de las 2 bandas)</li>'
          ||      '<li><strong>Solo se muestran contratos con consumos dentro de los &uacute;ltimos 7 d&iacute;as</strong></li>'
          ||'</ul>'

          || '<table>'
          || '  <tr>'
          || '    <th>Nro.</th>'
          || '    <th>Ciclo Fact.</th>'
          || '    <th>Rango Consumo</th>'
          || '    <th>Tipo Cliente</th>'
          || '    <th>Raz&oacute;n Social</th>'
          || '    <th>IMSI</th>'
          || '    <th>Tel&eacute;fono</th>'
          || '    <th>Estado Contrato</th>'
          || '    <th>Fecha Cambio Estado</th>'
          || '    <th>Total (MB)</th>'
          || '    <th>Pa&iacute;s mayor consumo</th>'
          || '    <th>Monto Contrato (S/.)</th>'
          || '    <th>Monto Total Cliente (S/.)</th>'
          || '    <th>L&iacute;mite Cr&eacute;dito (S/.)</th>'
          || '  </tr>';

          FOR REC IN (
            select  ORDENLISTADO, CICLOFACTURACION, RANGO_CONSUMO, TIPOCLIENTE, RAZONSOCIAL, IMSI
                    ,TELEFONO, ESTADOCONTRATO
                    ,(CASE SUBSTR(TRIM(FECHACARGACONTRATO),3,1)
                        WHEN '/' THEN TO_CHAR(TO_DATE(FECHACARGACONTRATO,'DD-MM-YY'),'DD-MM-YYYY')
                        ELSE TO_CHAR(TO_DATE(FECHACARGACONTRATO,'DD-MON-YYYY'),'DD-MM-YYYY')
                    END) AS FECHACARGACONTRATO
                    ,TRIM(TO_CHAR(ROUND(CONSUMO_MB,0), '999,999,999')) CONSUMO_MB, PAIS_MAYOR_CONSUMO, TRIM(TO_CHAR(ROUND(MONTO_CONTRATO,0), '999,999,999')) MONTO_CONTRATO
                    ,TRIM(TO_CHAR(ROUND(MONTO_CLIENTE,0), '999,999,999')) MONTO_CLIENTE
                    ,TRIM(TO_CHAR(LIMITECREDITO, '999,999,999')) LIMITECREDITO
            from    ROAMING_GGSN_ALERTA
            where   paraenvio = 1
            order by ordenlistado
          )
          LOOP
            HTML := HTML  || '<tr>'
                          ||  '<td class="center">' || REC.ORDENLISTADO || '</td>'
                          ||  '<td class="center">' || REC.CICLOFACTURACION || '</td>'
                          ||  '<td class="left">' || REC.RANGO_CONSUMO || '</td>'
                          ||  '<td class="center">' || REC.TIPOCLIENTE || '</td>'
                          ||  '<td class="left">' || REC.RAZONSOCIAL || '</td>'
                          ||  '<td class="center">' || REC.IMSI || '</td>'
                          ||  '<td class="center">' || REC.TELEFONO || '</td>'
                          ||  '<td class="center">' || REC.ESTADOCONTRATO || '</td>'
                          ||  '<td class="center">' || REC.FECHACARGACONTRATO || '</td>'
                          ||  '<td class="right">' || REC.CONSUMO_MB || '</td>'
                          ||  '<td class="center">' || REC.PAIS_MAYOR_CONSUMO || '</td>'
                          ||  '<td class="right">' || REC.MONTO_CONTRATO || '</td>'
                          ||  '<td class="right">' || REC.MONTO_CLIENTE || '</td>'
                          ||  '<td class="right">' || REC.LIMITECREDITO || '</td>'
                          || '</tr>';
          END LOOP;

  HTML := HTML || '</table>';

  --P_TO:= 'carlos.perez.betancour@entel.pe';
  P_TO2 := 'francisco.espinoza@entel.pe';
  P_TO3 := 'nathali.vega@entel.pe';
  P_TO4 := 'Finanzas.ControldeConsumos@entel.pe';
  --P_TO5 := 'gianfranco.salvatierra@entel.pe';
  --P_TO9 := 'jorge.linares@entel.pe';
  --P_TO10 := 'federico.balarezo@entel.pe';
  P_TO11 := 'gabriela.gonzales@entel.pe';
  P_TO12 := 'manuel.tello@entel.pe';
  P_TO13 := 'karlos.hernandez@entel.pe';
  P_TO14 := 'katya.campos@entel.pe';
  P_TO17 := 'faride.febres@entel.pe';
  --P_TO18 := 'luis.muroya@entel.pe';
  P_TO19 := 'ana.ramos@entel.pe';

  P_FROM := 'ip_alertas@entel.pe';
  P_SUBJECT := 'Alerta de consumo de Roaming Datos';
  P_TEXT := 'msg';
  P_HTML := HTML;
  P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
  P_SMTP_PORTNUM := '25';

  --BEGIN HTML_EMAIL(    P_TO => P_TO,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO2,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO3,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO4,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  --BEGIN HTML_EMAIL(    P_TO => P_TO10,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO11,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO12,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO13,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO14,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO17,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
  BEGIN HTML_EMAIL(    P_TO => P_TO19,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

END CC_ROAM_OUTBOUND_CORREO;

PROCEDURE CC_ROAM_OUTBOUND_CORREO_IPS
IS
    HTML CLOB;
    P_TO VARCHAR2(200);
    P_TO2 VARCHAR2(200);
    P_TO3 VARCHAR2(200);
    P_TO4 VARCHAR2(200);
    P_FROM VARCHAR2(200);
    P_SUBJECT VARCHAR2(200);
    P_TEXT VARCHAR2(200);
    P_HTML CLOB;
    P_SMTP_HOSTNAME VARCHAR2(200);
    P_SMTP_PORTNUM VARCHAR2(200);
    PCURSOR SYS_REFCURSOR;

    V_FECHAPROCESO VARCHAR2(30);
BEGIN
    SELECT TO_CHAR(FECHAPROCESO,'DD/MM/YYYY HH24:MI') INTO V_FECHAPROCESO FROM ROAMING_GGSN_ALERTA WHERE PARAENVIO = 1 AND ROWNUM = 1;

    HTML := '<style>'
          || 'table {border-collapse: collapse; font:11px Arial, san-serif; text-align:left;} '
          || 'th {background:#ff6702; color:#fff; font-size:12px;} '
          || 'table, th, td {border:1px solid #333; padding:4px;} '
          || '.center {text-align:center;} '
          || '.left {text-align:left;} '
          || '.right {text-align:right;} '
          || 'h1 {font:20px Arial;} '
          || 'ul li {font:12px Arial, san-serif;}'
          || '</style>'

          || '<h1>IPs no identificados y que muestran valor "N/D" en la alerta:</h1>'

          || '<p>Fecha/hora de la alerta: ' || V_FECHAPROCESO || ' hrs.</p>'

          || '<table>'
          || '  <tr>'
          || '    <th>Raz&oacute;n Social</th>'
          || '    <th>IMSI</th>'
          || '    <th>Tel&eacute;fono</th>'
          || '    <th>Total (MB)</th>'
          || '    <th>Monto Contrato (S/.)</th>'
          || '    <th>Monto Total Cliente (S/.)</th>'
          || '    <th>L&iacute;mite Cr&eacute;dito (S/.)</th>'
          || '    <th>IP</th>'
          || '  </tr>';

          FOR REC IN (
            select  razonsocial, imsi, telefono, CONSUMO_MB, MONTO_CONTRATO, MONTO_CLIENTE, LIMITECREDITO
                    ,LISTAGG(IP, ' ') WITHIN GROUP (ORDER BY imsi) AS IP
            from
            (
            SELECT  B.sgsnAdd AS IP, A.razonsocial, A.imsi, A.telefono, A.CONSUMO_MB, A.MONTO_CONTRATO, A.MONTO_CLIENTE, A.LIMITECREDITO
            FROM
                    (
                    select  (CASE WHEN LENGTH(TRIM(razonsocial)) > 30 THEN SUBSTR(TRIM(razonsocial),1,30)||'...' ELSE TRIM(razonsocial) END) razonsocial
                            ,imsi, telefono
                            ,TRIM(TO_CHAR(ROUND(CONSUMO_MB,0), '999,999,999')) CONSUMO_MB
                            ,TRIM(TO_CHAR(ROUND(MONTO_CONTRATO,0), '999,999,999')) MONTO_CONTRATO
                            ,TRIM(TO_CHAR(ROUND(MONTO_CLIENTE,0), '999,999,999')) MONTO_CLIENTE
                            ,TRIM(TO_CHAR(LIMITECREDITO, '999,999,999')) LIMITECREDITO
                            ,ORDENLISTADO
                    from    ROAMING_GGSN_ALERTA
                    where   PARAENVIO = 1 AND (PAIS_MAYOR_CONSUMO = 'N/D' OR PAIS_MAYOR_CONSUMO IS NULL)
                    ) A,
                    (
                    SELECT  SERIMSI, sgsnAdd, COUNT(1) REGISTROS_X_IP
                    FROM    ROAMING_GGSN_CDR
                    WHERE   periodofacturacion = (CASE TO_NUMBER(ciclofacturacion)
                                                      WHEN 1 THEN TO_CHAR(SYSDATE,'YYYYMM')
                                                      WHEN 3 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 16 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                                      WHEN 4 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 9 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                                      WHEN 5 THEN (case when TO_NUMBER(TO_CHAR(SYSDATE,'DD')) >= 23 then TO_CHAR(ADD_MONTHS(SYSDATE,1),'YYYYMM') else TO_CHAR(SYSDATE,'YYYYMM') end)
                                                  END) --PERIODOFACTURACION, SEGUN SU CICLO (PUEDE SER EL MES ACTUAL O EL PROXIMO)
                            AND (PAIS = 'N/D' OR PAIS IS NULL)
                    GROUP BY SERIMSI, sgsnAdd
                    ) B
            WHERE   A.imsi = B.SERIMSI
            ORDER BY A.ORDENLISTADO, A.MONTO_CONTRATO DESC
            )
            group by razonsocial, imsi, telefono, CONSUMO_MB, MONTO_CONTRATO, MONTO_CLIENTE, LIMITECREDITO
          )
          LOOP
            HTML := HTML  || '<tr>'
                          ||  '<td class="left">' || REC.RAZONSOCIAL || '</td>'
                          ||  '<td class="center">' || REC.IMSI || '</td>'
                          ||  '<td class="center">' || REC.TELEFONO || '</td>'
                          ||  '<td class="right">' || REC.CONSUMO_MB || '</td>'
                          ||  '<td class="right">' || REC.MONTO_CONTRATO || '</td>'
                          ||  '<td class="right">' || REC.MONTO_CLIENTE || '</td>'
                          ||  '<td class="right">' || REC.LIMITECREDITO || '</td>'
                          ||  '<td class="left">' || REC.IP || '</td>'
                          || '</tr>';
          END LOOP;

      HTML := HTML || '</table>';

      P_TO:= 'carlos.perez.betancour@entel.pe';
      P_TO2:= 'jimmy.robles@entel.pe';
      P_TO3:= 'maritza.saavedra@Externo.entel.pe';
      P_TO4:= 'daniel.delzo@entel.pe';

      P_FROM := 'ip_alertas@entel.pe';
      P_SUBJECT := 'IPs no identificados en Alerta Roaming Datos';
      P_TEXT := 'msg';
      P_HTML := HTML;
      P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
      P_SMTP_PORTNUM := '25';

    BEGIN HTML_EMAIL(    P_TO => P_TO,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO2,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO3,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO4,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

END CC_ROAM_OUTBOUND_CORREO_IPS;

PROCEDURE BUSCAR_TRAFICO_PREVIO(V_TELEFONO VARCHAR2,V_PERIODOBUSQUEDA VARCHAR2,V_METODOLOGIA VARCHAR2,pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
SELECT PERIODO,OPERADOR,TELEFONO,to_char(METODOLOGIA)
FROM TNP_TRAFICO_PREVIO_RESUMEN
WHERE TELEFONO=V_TELEFONO AND
      (V_PERIODOBUSQUEDA='-1' OR PERIODO=V_PERIODOBUSQUEDA) AND
      (V_METODOLOGIA='-1' OR METODOLOGIA=V_METODOLOGIA)
ORDER BY PERIODO DESC, METODOLOGIA DESC;
END BUSCAR_TRAFICO_PREVIO;

PROCEDURE cc_ldi_notificar_tplan (V_FECHA DATE, V_PLAN VARCHAR2) IS

 HTML CLOB;
  P_TO VARCHAR2(200);
  P_TO2 VARCHAR2(200);
  P_TO3 VARCHAR2(200);
  P_TO4 VARCHAR2(200);
  P_TO5 VARCHAR2(200);
  P_TO6 VARCHAR2(200);
  P_TO7 VARCHAR2(200);
  P_TO8 VARCHAR2(200);
  P_TO9 VARCHAR2(200);
  P_TO10 VARCHAR2(200);
  P_TO11 VARCHAR2(200);
  P_FROM VARCHAR2(200);
  P_SUBJECT VARCHAR2(200);
  P_TEXT VARCHAR2(200);
  P_HTML CLOB;
  P_SMTP_HOSTNAME VARCHAR2(200);
  P_SMTP_PORTNUM VARCHAR2(200);
  BEGIN

    P_HTML :='';

     HTML :=
             '<style>'||
                            '  table { '||
                                 '   border:1px solid #000000;'||
                                 '   border-spacing: 0;'||
                                 '   border-collapse: collapse;'||
                                 '   height:100%;'||
                                 '   margin:0px;padding:0px;'||
                               ' } .fr td{ '||
                                   ' background-color:#4B088A;'||
                                   ' text-align:center;'||
                                   ' border-width:0px 0px 1px 1px;'||
                                   ' font-size:12px;'||
                                   ' font-family:sans-serif;'||
                                   ' font-weight:bold;'||
                                   ' color:#ffffff;'||
                               ' }  td{'||
                                '    vertical-align:middle;'||
                                '    background-color:#ffffff;'||
                                '    border:1px solid #000000;'||
                                 '   border-width:0px 1px 1px 0px;'||
                                 '   text-align:left;'||
                                 '   padding:5px;'||
                                 '   font-size:10px;'||
                                  '  font-family:sans-serif;'||
                                  '  color:#000000;'||
                               ' } h2,p {font-family:sans-serif;}' ||
                         '</style>';



           html := html || '<h2>Alerta - Control de consumos Larga Distancia Internacional </h2>';
            html := html ||
                   '<table>'||
                        '<tr class=''fr''>'||
                            '<td>Raz&oacuten Social</td>'||
                            '<td>Teléfono</td>'||
                            '<td>Contrato</td>'||
                            '<td>Periodo Fact.</td>'||
                            '<td>Plan Tarifario</td>'||
                            '<td>Cod. Plan</td>'||
                            '<td>Pa&iacutes</td>'||
                            '<td>Tipo de Destino</td>'||
                            '<td>Minutos</td>'||
                            '<td>Llamadas</td>'||
                            '<td>Precio</td>'||
                            '<td>Minutos x tel.</td>'||
                            '<td>Precio x tel.</td>'||
                            '<td>Minutos x comp.</td>'||
                            '<td>Precio x comp.</td>'||
                            '<td>Límite de crédito</td>'||
                            '<td>Fecha proceso</td>'||
                            '<td>Fecha inicio</td>'||
                            '<td>Fecha fin</td>'||
                            '<td>Celda</td>'||
                            '<td>Validaci&oacuten</td>'||
                            '<td>Empleado</td>'||
                        '</tr>';


    FOR REC IN
      (
        SELECT * FROM
        (SELECT   a.compania
                , a.telefono
                , a.codigocontratobscs
                , a.periodo_facturacion
                , a.plantarifario
                , a.pais
                , a.tipo_destino
                , a.minutos
                , a.llamadas
                , TRIM(TO_CHAR(a.precio ,'999999.99')) precio
                , a.min_telefono
                , TRIM(TO_CHAR(a.precio_telefono ,'999999.99')) precio_telefono
                , a.min_compania
                , TRIM(TO_CHAR(a.precio_compania ,'999999.99')) precio_compania
                , a.limite_credito_cc
                , a.fecha_proceso
                , a.celda
                , a.c_plan
                , a.fecha_inicial
                , a.fecha_final
                , NVL(validacion.validacion,'ACTIV. ANTES DE BIO')validacion
                , emp.modalidad_contratacion
          FROM ( SELECT *
                   FROM cc_ldi_resumen_ciclo
                  WHERE TRUNC(FECHA_PROCESO) = TRUNC(V_FECHA)
                    AND PRECIO > 0
                    AND tipo_plan = 'Postpago'  ) a
          LEFT JOIN fotoequipos b
            ON a.codigocontratobscs = b.codigocontratobscs
         LEFT JOIN (SELECT * FROM P_EMPLEADO WHERE activo = 1) emp
            ON a.ruccompania = emp.dni
         LEFT JOIN pm_planes p
           ON a.c_plan = p.c_plan
         LEFT JOIN
                (SELECT contrato
                     , DECODE(validacion_identidad,'NOT BIOMETRIC','NO BIO: ','BIOMETRIC','BIO: ',validacion_identidad)
                     ||DECODE(resultado_validacion,'NO VALIDADO','',resultado_validacion) VALIDACION
                FROM p_inar
                WHERE estadoinar in ('NEWS','ADDS','REAC')) validacion
              ON a.codigocontratobscs = validacion.contrato
        WHERE a.tipo_plan = 'Postpago'
        ORDER BY  a.precio_telefono desc, a.precio desc, a.compania, a.telefono,a.pais )
           where rownum <= 80
      )
    LOOP
      HTML := HTML  || '<tr><td>' ||  REC.compania ||
                        '</td><td>' || REC.telefono ||
                        '</td><td>' || REC.codigocontratobscs ||
                        '</td><td>' || REC.periodo_facturacion ||
                        '</td><td>' || REC.plantarifario ||
                        '</td><td>' || REC.c_plan ||
                        '</td><td>' || rec.pais ||
                        '</td><td>' || REC.tipo_destino ||
                        '</td><td>' || REC.minutos ||
                        '</td><td>' || rec.llamadas ||
                        '</td><td>' || REC.precio ||
                        '</td><td>' || REC.min_telefono ||
                        '</td><td>' || rec.precio_telefono ||
                        '</td><td>' || REC.min_compania ||
                        '</td><td>' || REC.precio_compania ||
                        '</td><td>' || rec.limite_credito_cc||
                        '</td><td>' || REC.fecha_proceso ||
                        '</td><td>' || REC.fecha_inicial ||
                        '</td><td>' || REC.fecha_final ||
                        '</td><td>' || REC.celda ||
                        '</td><td>' || REC.validacion ||
                        '</td><td>' || REC.modalidad_contratacion ||
                        '</td></tr>';
      --DBMS_OUTPUT.PUT_LINE(length(html));
    END LOOP;
    --IP
    P_TO := 'alejandra.linares@entel.pe';
    P_TO2 := 'francisco.espinoza@entel.pe';
    P_TO9 := 'nathali.vega@entel.pe';
    P_TO7 := 'pamela.pimentel@entel.pe';

    --CONTROL DE CONSUMOS
    P_TO6 := 'Finanzas.ControldeConsumos@entel.pe';
    P_TO8 := 'jcarvallo@rcpasesores.com';
    P_TO10 := 'msaavedra@rcpasesores.com';
    P_TO11 := 'bzegarra@rcpasesores.com';

    --FRAUDES
    P_TO4 := 'daniel.delzo@entel.pe';
    P_TO5 := 'jimmy.robles@entel.pe';

    P_FROM := 'ip_alertas@entel.pe';
    P_SUBJECT := 'Control de consumos LDI ('|| V_PLAN ||')';
    P_TEXT := 'msg';
    P_HTML := HTML;
    --P_SMTP_HOSTNAME := 'relay-alertas.entel.pe';
    P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
    P_SMTP_PORTNUM := '25';


    --IP
    BEGIN HTML_EMAIL(    P_TO => P_TO,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO2,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO9,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO7,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

    --CONTROL DE CONSUMOS
    BEGIN HTML_EMAIL(    P_TO => P_TO6,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO8,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO10,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO11,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

    --FRAUDES
    --BEGIN HTML_EMAIL(    P_TO => P_TO3,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO4,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO5,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

END;

PROCEDURE CC_DATOS_NOTIFICAR_TPLAN (V_FECHA DATE, V_PLAN VARCHAR2) IS
  HTML CLOB;
  P_TO VARCHAR2(200);
  P_TO2 VARCHAR2(200);
  P_TO3 VARCHAR2(200);
  P_TO4 VARCHAR2(200);
  P_TO5 VARCHAR2(200);
  P_TO6 VARCHAR2(200);
  P_TO7 VARCHAR2(200);
  P_TO8 VARCHAR2(200);
  P_TO9 VARCHAR2(200);
  P_FROM VARCHAR2(200);
  P_SUBJECT VARCHAR2(200);
  P_TEXT VARCHAR2(200);
  P_HTML CLOB;
  P_SMTP_HOSTNAME VARCHAR2(200);
  P_SMTP_PORTNUM VARCHAR2(200);
  BEGIN

    EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS = ''. ''';

    P_HTML :='';

     HTML :=
             '<style>'||
                            '  table { '||
                                 '   border:1px solid #000000;'||
                                 '   border-spacing: 0;'||
                                 '   border-collapse: collapse;'||
                                 '   height:100%;'||
                                 '   margin:0px;padding:0px;'||
                               ' } .fr td{ '||
                                   ' background-color:#F25E4E;'||
                                   ' text-align:center;'||
                                   ' border-width:0px 0px 1px 1px;'||
                                   ' font-size:12px;'||
                                   ' font-family:sans-serif;'||
                                   ' font-weight:bold;'||
                                   ' color:#000000;'||
                               ' }  td{'||
                                '    vertical-align:middle;'||
                                '    background-color:#ffffff;'||
                                '    border:1px solid #000000;'||
                                 '   border-width:0px 1px 1px 0px;'||
                                 '   text-align:left;'||
                                 '   padding:5px;'||
                                 '   font-size:10px;'||
                                  '  font-family:sans-serif;'||
                                  '  color:#000000;'||
                               ' } h2,p {font-family:sans-serif;}' ||
                         '</style>';



           html := html || '<h2>Alerta - Control de consumos de datos </h2>';

            html := html ||
                   '<table>'||
                        '<tr class=''fr''>'||
                            '<td>Raz&oacuten Social</td>'||
                            '<td>Teléfono</td>'||
                            '<td>Contrato</td>'||
                            '<td>Periodo Fact.</td>'||
                            '<td>Ciclo Fact.</td>'||
                            '<td>Plan Tarifario</td>'||
                            '<td>Cod. Plan</td>'||
                            '<td>Bucket mb</td>'||
                            '<td>Exceso mb</td>'||
                            '<td>Exceso precio</td>'||
                            '<td>Límite de cr&eacute;dito(CC)</td>'||
                            '<td>Ratio cr&eacute;dito</td>'||
                            '<td>Fecha inicial</td>'||
                            '<td>Fecha final</td>'||
                            '<td>Fecha proceso</td>'||
                            '<td>Validaci&oacuten</td>'||
                            '<td>Empleado</td>'||
                        '</tr>';


    FOR REC IN
      (
        SELECT * FROM
                (SELECT a.compania
                     , a.telefono
                     , a.contrato
                     , a.periodo_fact
                     , a.ciclo
                     , a.n_plan
                     , a.bucket_mb
                     , a.adic_mb
                     , a.adic_precio
                     , NVL(e.limite_credito,DECODE(obtener_tipodoc_2(a.RUCCOMPANIA),'RUC20',
                            CASE WHEN  contratos_comp < 4  THEN 500
                                 WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800
                                 WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200
                                 WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000
                                 WHEN  contratos_comp >=80 THEN 4500
                            END
                               , 500) )  LIMITE_CC
                     , ROUND(a.adic_precio / NVL(e.limite_credito,DECODE(obtener_tipodoc_2(a.RUCCOMPANIA),'RUC20',
                            CASE WHEN  contratos_comp < 4  THEN 500
                                 WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800
                                 WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200
                                 WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000
                                 WHEN  contratos_comp >=80 THEN 4500
                            END , 500 )) ,4 ) RATIO_LDC
                     , a.fecha_ini
                     , a.fecha_fin
                     , a.fecha_proceso
                     , a.c_plan
                     , NVL(validacion.validacion,'ACTIV. ANTES DE BIO')validacion
                     , emp.modalidad_contratacion
                  FROM cc_datos_resumen_ciclo a
                  LEFT JOIN (SELECT * FROM P_EMPLEADO WHERE activo = 1) emp
                    ON a.ruccompania = emp.dni
                  LEFT JOIN cc_especiales e
                    ON a.codigocompania =  e.codigocompania
                   LEFT JOIN pm_planes p
                    ON a.c_plan = p.c_plan
                  LEFT JOIN
                    (SELECT contrato
                         , DECODE(validacion_identidad,'NOT BIOMETRIC','NO BIO: ','BIOMETRIC','BIO: ',validacion_identidad)
                         ||DECODE(resultado_validacion,'NO VALIDADO','',resultado_validacion) VALIDACION
                    FROM p_inar
                    WHERE estadoinar in ('NEWS','ADDS','REAC')) validacion
                  ON a.contrato = validacion.contrato
                  WHERE periodo_fact =  OBTENER_PERIODO_FACT_ACTUAL(CICLO,V_FECHA)
                    AND a.adic_precio>0
                    AND adic_mb is not null
                    AND a.tipo_plan = 'Postpago'
                    AND p.t_plan = V_PLAN
                   -- AND NVL(a.mb_youtube,0)=0
                  ORDER BY ROUND(a.adic_precio / NVL(e.limite_credito,DECODE(obtener_tipodoc_2(a.RUCCOMPANIA),'RUC20',
                            CASE WHEN  contratos_comp < 4  THEN 500
                                 WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800
                                 WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200
                                 WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000
                                 WHEN  contratos_comp >=80 THEN 4500
                            END , 500 )) ,4 ) DESC )
           WHERE rownum <= 80
      )
    LOOP
      HTML := HTML  || '<tr><td>' ||  REC.compania ||
                        '</td><td>' || REC.telefono ||
                        '</td><td>' || REC.contrato||
                        '</td><td>' || REC.periodo_fact ||
                        '</td><td>' || REC.ciclo ||
                        '</td><td>' || REC.n_plan ||
                        '</td><td>' || REC.c_plan ||
                        '</td><td>' || REC.bucket_mb ||
                        '</td><td>' || REC.adic_mb ||
                        '</td><td>' || REC.adic_precio ||
                        '</td><td>' || REC.limite_cc ||
                        '</td><td>' || REC.RATIO_LDC ||
                        '</td><td>' || REC.fecha_ini ||
                        '</td><td>' || REC.fecha_fin ||
                        '</td><td>' || REC.fecha_proceso ||
                        '</td><td>' || REC.validacion ||
                        '</td><td>' || REC.modalidad_contratacion ||
                        '</td></tr>';
      --DBMS_OUTPUT.PUT_LINE(length(html));
    END LOOP;

    --IP
    P_TO := 'alejandra.linares@entel.pe';
    P_TO2 := 'francisco.espinoza@entel.pe';
    P_TO3 := 'nathali.vega@entel.pe';
    P_TO4 := 'pamela.pimentel@entel.pe';
    --CONTROL DE CONSUMOS
    P_TO6 := 'Finanzas.ControldeConsumos@entel.pe';
    P_TO7 := 'jcarvallo@rcpasesores.com';
    P_TO8 := 'msaavedra@rcpasesores.com';
    P_TO9 := 'bzegarra@rcpasesores.com';

    P_FROM := 'ip_alertas@entel.pe';
    P_SUBJECT := 'Control de consumos - Datos ('|| V_PLAN ||')';
    P_TEXT := 'msg';
    P_HTML := HTML;
    P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
    P_SMTP_PORTNUM := '25';


    --IP
    BEGIN HTML_EMAIL(    P_TO => P_TO,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO2,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO3,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO4,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    --CONTROL DE CONSUMOS
    BEGIN HTML_EMAIL(    P_TO => P_TO6,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO7,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO8,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO9,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;



END CC_DATOS_NOTIFICAR_TPLAN;

PROCEDURE cc_local_notificar_tplan (V_FECHA DATE, V_PLAN VARCHAR2) IS
  HTML CLOB;
  P_TO VARCHAR2(200);
  P_TO2 VARCHAR2(200);
  P_TO3 VARCHAR2(200);
  P_TO4 VARCHAR2(200);
  P_TO5 VARCHAR2(200);
  P_TO6 VARCHAR2(200);
  P_TO7 VARCHAR2(200);
  P_TO8 VARCHAR2(200);
  P_TO9 VARCHAR2(200);
  P_TO10 VARCHAR2(200);
  P_FROM VARCHAR2(200);
  P_SUBJECT VARCHAR2(200);
  P_TEXT VARCHAR2(200);
  P_HTML CLOB;
  P_SMTP_HOSTNAME VARCHAR2(200);
  P_SMTP_PORTNUM VARCHAR2(200);
  BEGIN

    EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS = ''. ''';

    P_HTML :='';

     HTML :=
             '<style>'||
                            '  table { '||
                                 '   border:1px solid #000000;'||
                                 '   border-spacing: 0;'||
                                 '   border-collapse: collapse;'||
                                 '   height:100%;'||
                                 '   margin:0px;padding:0px;'||
                               ' } .fr td{ '||
                                   ' background-color:#FFBF00;'||
                                   ' text-align:center;'||
                                   ' border-width:0px 0px 1px 1px;'||
                                   ' font-size:12px;'||
                                   ' font-family:sans-serif;'||
                                   ' font-weight:bold;'||
                                   ' color:#000000;'||
                               ' }  td{'||
                                '    vertical-align:middle;'||
                                '    background-color:#ffffff;'||
                                '    border:1px solid #000000;'||
                                 '   border-width:0px 1px 1px 0px;'||
                                 '   text-align:left;'||
                                 '   padding:5px;'||
                                 '   font-size:10px;'||
                                  '  font-family:sans-serif;'||
                                  '  color:#000000;'||
                               ' } h2,p {font-family:sans-serif;}' ||
                         '</style>';



           html := html || '<h2>Alerta - Control de consumos locales </h2>';

            html := html ||
                   '<table>'||
                        '<tr class=''fr''>'||
                            '<td>Raz&oacuten Social</td>'||
                            '<td>Teléfono</td>'||
                            '<td>Contrato</td>'||
                            '<td>Periodo Fact.</td>'||
                            '<td>CIclo Fact.</td>'||
                            '<td>Plan Tarifario</td>'||
                            '<td>Cod. Plan</td>'||
                            '<td>Exceso Min. Onnet </td>'||
                            '<td>Exceso Min. Offnet M&oacutevil </td>'||
                            '<td>Exceso Min. Offnet Fijo</td>'||
                            '<td>Exceso Min. Offnet</td>'||
                            '<td>Exceso Min. TD</td>'||

                            '<td>Exceso Prec. Onnet (S/.)</td>'||
                            '<td>Exceso Prec. Offnet M&oacutevil (S/.)</td>'||
                            '<td>Exceso Prec. Offnet Fijo (S/.)</td>'||
                            '<td>Exceso Prec. Offnet (S/.)</td>'||
                            '<td>Exceso Prec. TD (S/.)</td>'||

                            '<td>Límite de crédito(CC)</td>'||
                            '<td>Fecha tráfico</td>'||
                            '<td>Exceso Prec. Total (S/.)</td>'||
                            '<td>Ratio cr&eacute;dito</td>'||
                            '<td>Fecha inicial</td>'||
                            '<td>Fecha final</td>'||
                            '<td>Validaci&oacuten</td>'||
                            '<td>Empleado</td>'||
                        '</tr>';


    FOR REC IN
      (
        SELECT * FROM
        (SELECT   a.compania
                , a.telefono
                , a.contrato
                , a.periodo_facturacion
                , a.ciclofacturacioncontrato
                , a.plan_tarifario
                , a.exceso_minutos_onnet exceso_minutos_onnet
                , a.exceso_minutos_offnet_movil exceso_minutos_offnet_movil
                , a.exceso_minutos_offnet_fijo exceso_minutos_offnet_fijo
                , a.exceso_minutos_offnet exceso_minutos_offnet
                , a.exceso_minutos_td exceso_minutos_td
                , a.exceso_precio_onnet exceso_precio_onnet
                , a.exceso_precio_offnet_movil exceso_precio_offnet_movil
                , a.exceso_precio_offnet_fijo exceso_precio_offnet_fijo
                , a.exceso_precio_offnet exceso_precio_offnet
                , a.exceso_precio_td exceso_precio_td
                , a.limite_credito_cc limite_credito_cc
                , a.fecha_proceso
                ,NVL(exceso_precio_onnet,0)
                +NVL(exceso_precio_offnet_movil,0)
                +NVL(exceso_precio_offnet_fijo,0)
                +NVL(exceso_precio_offnet,0)
                +NVL(exceso_precio_td,0) EXCESO_PRECIO_TOTAL
            ,ROUND((NVL(exceso_precio_onnet,0)
                +NVL(exceso_precio_offnet_movil,0)
                +NVL(exceso_precio_offnet_fijo,0)
                +NVL(exceso_precio_offnet,0)
                +NVL(exceso_precio_td,0))/limite_credito_cc,4) RATIO_CREDITO
            ,a.fecha_inicial
            ,a.fecha_final
            ,a.c_plan
            ,NVL(validacion.validacion,'ACTIV. ANTES DE BIO')validacion
            , emp.modalidad_contratacion
          FROM cc_local_resumen_ciclo a
          LEFT JOIN pm_planes p
            ON a.c_plan = p.c_plan
          LEFT JOIN (SELECT * FROM P_EMPLEADO WHERE activo = 1) emp
            ON a.ruccompania = emp.dni
          LEFT JOIN
                (SELECT contrato
                     , DECODE(validacion_identidad,'NOT BIOMETRIC','NO BIO: ','BIOMETRIC','BIO: ',validacion_identidad)
                     ||DECODE(resultado_validacion,'NO VALIDADO','',resultado_validacion) VALIDACION
                FROM p_inar
                WHERE estadoinar in ('NEWS','ADDS','REAC')) validacion
              ON a.contrato = validacion.contrato
        WHERE TRUNC(FECHA_PROCESO) = TRUNC(V_FECHA)
            AND (NVL(exceso_precio_onnet,0)
                +NVL(exceso_minutos_offnet_movil,0)
                +NVL(exceso_minutos_offnet_fijo,0)
                +NVL(exceso_minutos_offnet,0)
                +NVL(exceso_minutos_td,0))>0
            AND p.t_plan = V_PLAN
        ORDER BY  (NVL(exceso_precio_onnet,0)
                +NVL(exceso_minutos_offnet_movil,0)
                +NVL(exceso_minutos_offnet_fijo,0)
                +NVL(exceso_minutos_offnet,0)
                +NVL(exceso_minutos_td,0)) desc, a.telefono )
           where rownum <= 50
      )
    LOOP
      HTML := HTML  || '<tr><td>' ||  REC.compania ||
                        '</td><td>' || REC.telefono ||
                        '</td><td>' || REC.contrato||
                        '</td><td>' || REC.periodo_facturacion ||
                        '</td><td>' || REC.ciclofacturacioncontrato ||
                        '</td><td>' || REC.plan_tarifario ||
                        '</td><td>' || REC.c_plan ||
                        '</td><td>' || REC.exceso_minutos_onnet ||
                        '</td><td>' || REC.exceso_minutos_offnet_movil ||
                        '</td><td>' || REC.exceso_minutos_offnet_fijo ||
                        '</td><td>' || REC.exceso_minutos_offnet ||
                        '</td><td>' || REC.exceso_minutos_td ||
                        '</td><td>' || REC.exceso_precio_onnet ||
                        '</td><td>' || REC.exceso_precio_offnet_movil ||
                        '</td><td>' || REC.exceso_precio_offnet_fijo ||
                        '</td><td>' || REC.exceso_precio_offnet ||
                        '</td><td>' || REC.exceso_precio_td ||
                        '</td><td>' || REC.limite_credito_cc ||
                        '</td><td>' || REC.fecha_proceso ||
                        '</td><td>' || REC.EXCESO_PRECIO_TOTAL ||
                        '</td><td>' || REC.RATIO_CREDITO ||
                        '</td><td>' || REC.fecha_inicial ||
                        '</td><td>' || REC.fecha_final ||
                        '</td><td>' || REC.validacion ||
                        '</td><td>' || REC.modalidad_contratacion ||

                        '</td></tr>';
      --DBMS_OUTPUT.PUT_LINE(length(html));
    END LOOP;
    --IP
    P_TO := 'alejandra.linares@entel.pe';
    P_TO2 := 'francisco.espinoza@entel.pe';
    P_TO3 := 'nathali.vega@entel.pe';
    P_TO7 := 'pamela.pimentel@entel.pe';
    --CONTROL DE CONSUMOS
    P_TO6 := 'Finanzas.ControldeConsumos@entel.pe';
    P_TO8 := 'jcarvallo@rcpasesores.com';
    P_TO9 := 'msaavedra@rcpasesores.com';
    P_TO10 := 'bzegarra@rcpasesores.com';

    --FRAUDES
    P_TO4 := 'daniel.delzo@entel.pe';
    P_TO5 := 'jimmy.robles@entel.pe';


    P_FROM := 'ip_alertas@entel.pe';
    P_SUBJECT := 'Control de consumos - Local ('|| V_PLAN ||')';
    P_TEXT := 'msg';
    P_HTML := HTML;
    P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
    P_SMTP_PORTNUM := '25';


    --IP
    BEGIN HTML_EMAIL(    P_TO => P_TO,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO2,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO3,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO7,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

    --CONTROL DE CONSUMOS
    BEGIN HTML_EMAIL(    P_TO => P_TO6,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO8,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO9,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO10,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

    --FRAUDES
    BEGIN HTML_EMAIL(    P_TO => P_TO4,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO5,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;


    COMMIT;

END cc_local_notificar_tplan;

PROCEDURE BUSCAR_TRAFICOPREVIO_MASIVA(V_PERIODOBUSQUEDA VARCHAR2,V_METODOLOGIA VARCHAR2,pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
select  PERIODO,
        OPERADOR,
        TELEFONO,
        to_char(METODOLOGIA)
FROM TNP_TRAFICO_PREVIO_RESUMEN A,
     BUSQUEDA_TRAFICO_PREVIO B
WHERE A.TELEFONO =B.CAMPO AND
      (V_PERIODOBUSQUEDA='-1' OR PERIODO=V_PERIODOBUSQUEDA) AND
      (V_METODOLOGIA='-1' OR METODOLOGIA=V_METODOLOGIA)
ORDER BY PERIODO DESC, METODOLOGIA DESC;
END BUSCAR_TRAFICOPREVIO_MASIVA;

PROCEDURE CI_VENTAFACTURADA_LOAD(p_periodo IN VARCHAR2)
IS
  V_TIPOBASE VARCHAR2(3):= 'VF';
BEGIN

    --PREPARAR DATOS PARA PASAR REGISTROS A TABLA FINAL
    UPDATE temp_ri_ventafact_socionegocio
    SET PERIODO_LIQUIDACION = TO_CHAR(TO_DATE(FECHA_LIQUIDACION,'DD/MM/YYYY'),'YYYYMM'),
        PERIODO_ORDEN = TO_CHAR(TO_DATE(FECHA_ORDEN_RETAIL,'DD/MM/YYYY'),'YYYYMM'),
        --,PRECIO_SKU = REPLACE(SUBSTR(PRECIO_SKU, 1, instr(PRECIO_SKU, '.', 1, 1)-1),',','')
        PRECIO_SKU = replace(PRECIO_SKU,',',''),
        SOLUCION = replace(trim(SOLUCION),'Ã³','ó'),
        POST_PRE = (CASE WHEN UPPER(TRIM(SOLUCION)) LIKE '%POST%' THEN 'POST' ELSE 'PRE' END), --campo creado para facilitar el resumen
        TIPO_BASE = V_TIPOBASE
    ;
    COMMIT;

    --COMPLETAR CAMPO 'CANAL'
    MERGE INTO temp_ri_ventafact_socionegocio A
    --USING (SELECT CODIGO, CANAL FROM RI_VENTAFACTURADA_COMISION WHERE PERIODO = p_periodo) B
    USING ( --por si acaso, eliminar repetidos, ya que sino se caería el merge
            SELECT  CODIGO, CANAL
            FROM    ( SELECT CODIGO, canal
                            ,row_number() over(partition by codigo order by codigo) rn
                      FROM ri_ventafact_ma_comision
                      WHERE PERIODO = p_periodo )
            WHERE   RN = 1
          ) B
    ON (A.CODIGO_SUCURSAL = B.CODIGO)
    WHEN MATCHED THEN
      UPDATE SET A.CANAL = B.CANAL;
    COMMIT;

    --MANTENER TABLA FINAL
    DELETE FROM ri_ventafact_socionegocio A
    WHERE TIPO_BASE = V_TIPOBASE AND EXISTS (
                SELECT FECHA_ORDEN_RETAIL
                FROM temp_ri_ventafact_socionegocio
                WHERE PERIODO_ORDEN = A.PERIODO_ORDEN AND FECHA_ORDEN_RETAIL = A.FECHA_ORDEN_RETAIL
                );
    COMMIT;

    INSERT INTO ri_ventafact_socionegocio
    (FECHAPROCESO,PERIODO_LIQUIDACION,PERIODO_ORDEN,NUMERO_LIQUIDACION,FECHA_LIQUIDACION,ESTADO_LIQUIDACION,CANAL,
    CODIGO_SUCURSAL,CADENA,SUCURSAL,PROMOTOR,FACTURA,FECHA_EMISION_FACTURA,FECHA_INI,FECHA_FIN,SOLUCION,POST_PRE,NRO_ORDEN_RETAIL,
    FECHA_ORDEN_RETAIL,TIPO_ORDEN,COD_CLIENTE,CLIENTE,PRODUCTO,SKU,PRECIO_SKU,VOUCHER,TELEFONO,CONTRATO,MODELO,PLAN,
    IMEI,SIM,COSTO_EQUIPO,COSTO_SERVICIO,COMISION_EQUIPO,COMISION_SERVICIO,SECUENCIA,PACK,COM_VARIABLE,FACT_ENTEL,COM_FIJA,COM_TOTAL,TIPO_BASE)
        SELECT
            SYSDATE,PERIODO_LIQUIDACION,PERIODO_ORDEN,NUMERO_LIQUIDACION,FECHA_LIQUIDACION,ESTADO_LIQUIDACION,CANAL,
            CODIGO_SUCURSAL,CADENA,SUCURSAL,PROMOTOR,FACTURA,FECHA_EMISION_FACTURA,FECHA_INI,FECHA_FIN,SOLUCION,POST_PRE,NRO_ORDEN_RETAIL,
            FECHA_ORDEN_RETAIL,TIPO_ORDEN,COD_CLIENTE,CLIENTE,PRODUCTO,SKU,TO_NUMBER(PRECIO_SKU),VOUCHER,TELEFONO,CONTRATO,MODELO,PLAN,
            IMEI,SIM,COSTO_EQUIPO,COSTO_SERVICIO,COMISION_EQUIPO,COMISION_SERVICIO,SECUENCIA,PACK,COM_VARIABLE,FACT_ENTEL,COM_FIJA,COM_TOTAL,TIPO_BASE
        FROM
            temp_ri_ventafact_socionegocio;
    COMMIT;

    --MANTENER TABLA DE RESUMEN
    /*DELETE FROM RI_VENTAFACTURADA_RES WHERE PERIODO_ORDEN = p_periodo;
    COMMIT;

    INSERT INTO RI_VENTAFACTURADA_RES
    (PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE, FACT_ENTEL, COM_TOTAL, COM_VARIABLE, COM_FIJA)
      SELECT  PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE
            ,SUM(FACT_ENTEL) TOT_FACT_ENTEL
            ,SUM(COM_TOTAL) TOT_COM_TOTAL
            ,SUM(COM_VARIABLE) TOT_COM_VARIABLE
            ,SUM(COM_FIJA) TOT_COM_FIJA
      FROM    RI_VENTAFACTURADA
      WHERE   PERIODO_ORDEN = p_periodo
      GROUP BY PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE
      ORDER BY CANAL, CADENA, SOLUCION;
    COMMIT;*/

    CI_VENTAFACTURADA_RESUMEN(p_periodo,V_TIPOBASE);
    CI_VENTAFACTURADA_RES_FA(p_periodo);

END CI_VENTAFACTURADA_LOAD;

PROCEDURE CI_VENTAFACTURADA_AJUSTE_LOAD(p_periodo IN VARCHAR2)
IS
  V_TIPOBASE VARCHAR2(3):= 'VFA';
BEGIN

    --PREPARAR DATOS PARA PASAR REGISTROS A TABLA FINAL
    UPDATE temp_ri_ventafact_socionegocio
    SET PERIODO_LIQUIDACION = TO_CHAR(FECHA_LIQUIDACION,'YYYYMM'),
        PERIODO_ORDEN = TO_CHAR(FECHA_ORDEN_RETAIL,'YYYYMM'),
        PRECIO_SKU = replace(PRECIO_SKU,',',''),
        SOLUCION = replace(trim(SOLUCION),'Ã³','ó'),
        POST_PRE = (CASE WHEN UPPER(TRIM(SOLUCION)) LIKE '%POST%' THEN 'POST' ELSE 'PRE' END), --campo creado para facilitar el resumen
        TIPO_BASE = V_TIPOBASE
    ;
    COMMIT;

    --COMPLETAR CAMPO 'CANAL'
    MERGE INTO temp_ri_ventafact_socionegocio A
    USING ( --por si acaso, eliminar repetidos, ya que sino se caería el merge
            SELECT  CODIGO, CANAL
            FROM    ( SELECT CODIGO, canal
                            ,row_number() over(partition by codigo order by codigo) rn
                      FROM ri_ventafact_ma_comision
                      WHERE PERIODO = p_periodo )
            WHERE   RN = 1
          ) B
    ON (A.CODIGO_SUCURSAL = B.CODIGO)
    WHEN MATCHED THEN
      UPDATE SET A.CANAL = B.CANAL;
    COMMIT;

INSERT INTO RI_VENTAFACT_SOCIONEGOCIO (FECHAPROCESO,PERIODO_LIQUIDACION,PERIODO_ORDEN,NUMERO_LIQUIDACION,FECHA_LIQUIDACION,ESTADO_LIQUIDACION,CANAL,
    CODIGO_SUCURSAL,CADENA,SUCURSAL,PROMOTOR,FACTURA,FECHA_EMISION_FACTURA,FECHA_INI,FECHA_FIN,SOLUCION,POST_PRE,NRO_ORDEN_RETAIL,
    FECHA_ORDEN_RETAIL,TIPO_ORDEN,COD_CLIENTE,CLIENTE,PRODUCTO,SKU,PRECIO_SKU,VOUCHER,TELEFONO,CONTRATO,MODELO,PLAN,
    IMEI,SIM,COSTO_EQUIPO,COSTO_SERVICIO,COMISION_EQUIPO,COMISION_SERVICIO,SECUENCIA,PACK,COM_VARIABLE,FACT_ENTEL,COM_FIJA,COM_TOTAL,TIPO_BASE)
SELECT SYSDATE,PERIODO_LIQUIDACION,PERIODO_ORDEN,NUMERO_LIQUIDACION,FECHA_LIQUIDACION,ESTADO_LIQUIDACION,CANAL,
       CODIGO_SUCURSAL,CADENA,SUCURSAL,PROMOTOR,FACTURA,FECHA_EMISION_FACTURA,FECHA_INI,FECHA_FIN,SOLUCION,POST_PRE,NRO_ORDEN_RETAIL,
       FECHA_ORDEN_RETAIL,TIPO_ORDEN,COD_CLIENTE,CLIENTE,PRODUCTO,SKU,TO_NUMBER(PRECIO_SKU),VOUCHER,TELEFONO,CONTRATO,MODELO,PLAN,
       IMEI,SIM,COSTO_EQUIPO,COSTO_SERVICIO,COMISION_EQUIPO,COMISION_SERVICIO,SECUENCIA,PACK,COM_VARIABLE,FACT_ENTEL,COM_FIJA,COM_TOTAL,TIPO_BASE
        FROM
            temp_ri_ventafact_socionegocio A
where A.imei not in (select imei from RI_VENTAFACT_SOCIONEGOCIO where PERIODO_ORDEN = p_periodo);
    COMMIT;
    CI_VENTAFACTURADA_RESUMEN(p_periodo,V_TIPOBASE);
    CI_VENTAFACTURADA_RES_FA(p_periodo);

END CI_VENTAFACTURADA_AJUSTE_LOAD;

PROCEDURE CI_VENTAFACTURADA_FA_LOAD(p_periodo IN VARCHAR2)
IS
BEGIN
  --
  UPDATE temp_ri_ventafact_facturacion
    SET MES = (CASE UPPER(SUBSTR(TRIM(MES_LIQUIDADO),1,3))
                      WHEN 'JAN' THEN '01'
                      WHEN 'FEB' THEN '02'
                      WHEN 'MAR' THEN '03'
                      WHEN 'ABR' THEN '04'
                      WHEN 'MAY' THEN '05'
                      WHEN 'JUN' THEN '06'
                      WHEN 'JUL' THEN '07'
                      WHEN 'AUG' THEN '08'
                      WHEN 'SEP' THEN '09'
                      WHEN 'OCT' THEN '10'
                      WHEN 'NOV' THEN '11'
                      WHEN 'DIC' THEN '12'
                  END);
  COMMIT;

  UPDATE temp_ri_ventafact_facturacion
    SET PERIODO = '20' || SUBSTR(MES_LIQUIDADO,-2) || MES
        ,FECHA_EMISION_DATE = TO_DATE(SUBSTR(FECHA_EMISION,1,2)||'/'||MES||'/'||'20' || SUBSTR(MES_LIQUIDADO,-2),'DD/MM/YYYY')
        ,FECHA_DESDE_DATE = TO_DATE(SUBSTR(FECHA_DESDE,1,2)||'/'||MES||'/'||'20' || SUBSTR(MES_LIQUIDADO,-2),'DD/MM/YYYY')
        ,FECHA_HASTA_DATE = TO_DATE(SUBSTR(FECHA_HASTA,1,2)||'/'||MES||'/'||'20' || SUBSTR(MES_LIQUIDADO,-2),'DD/MM/YYYY')
        ,MONTO_CONIGV = replace(MONTO_CONIGV,',','')
      ;
  COMMIT;

  DELETE FROM ri_ventafact_facturacion WHERE PERIODO = p_periodo;

  INSERT INTO ri_ventafact_facturacion
  (FECHAPROCESO, MES_LIQUIDADO, MES, PERIODO, CODIGO, CLIENTE, LIQUIDACION, DOCUMENTO, FECHA_EMISION, FECHA_EMISION_DATE,
    NUMERO, FECHA_DESDE, FECHA_DESDE_DATE, FECHA_HASTA, FECHA_HASTA_DATE, MONTO_CONIGV, TIPO, OBSERVACION)
    SELECT SYSDATE, MES_LIQUIDADO, MES, PERIODO, CODIGO, CLIENTE, LIQUIDACION, DOCUMENTO, FECHA_EMISION, FECHA_EMISION_DATE,
            NUMERO, FECHA_DESDE, FECHA_DESDE_DATE, FECHA_HASTA, FECHA_HASTA_DATE, TO_NUMBER(MONTO_CONIGV), TIPO, OBSERVACION
    FROM    temp_ri_ventafact_facturacion;
  COMMIT;

  CI_VENTAFACTURADA_RES_FA(p_periodo);

END CI_VENTAFACTURADA_FA_LOAD;

PROCEDURE CI_VENTAFACTURADA_TPF_LOAD(p_periodo IN VARCHAR2, p_tipobase IN VARCHAR2)
IS
  V_TIPOBASE VARCHAR2(12):= p_tipobase;
BEGIN

  UPDATE  TEMP_RI_VENTAFACT_TPF
    SET PERIODO = TO_CHAR(TO_DATE(FECHA_CIERRE_ORDEN,'DD/MM/YYYY'),'YYYYMM')
        ,SOLUCION = replace(trim(SOLUCION),'Ã³','ó')
        ,POST_PRE = (CASE WHEN UPPER(TRIM(SOLUCION)) LIKE '%POST%' THEN 'POST' ELSE 'PRE' END) --campo creado para facilitar el resumen
        ,TIPO_BASE = V_TIPOBASE
        ,PRECIO = replace(PRECIO,',','')
        ,MONTO_TOTAL = replace(MONTO_TOTAL,',','')
        ,COSTO_EQUIPO = replace(COSTO_EQUIPO,',','')
        ,PRECIO_EXCEPCION = replace(PRECIO_EXCEPCION,',','')
        ,RENTA_ADELANTADA = replace(RENTA_ADELANTADA,',','')
        ,PACK = to_number(trim(decode(monto_total,NULL,'0',replace(monto_total,',',''))),'999999.999999999999999999999999999999')
        ,SS = (CASE --postpago = 0, prepago es 0.1, menos CDM y Reposición que son 0
                WHEN UPPER(SOLUCION) LIKE '%POSTPAGO%'
                      OR UPPER(TIPO_OPERACION) LIKE '%CAMBIO DE MODELO%'
                      OR REPLACE(UPPER(TIPO_OPERACION),'Ó','O') LIKE '%REPOSICION%'
                    THEN 0
                ELSE 0.1 --prepago, menos CDM y Reposición
              END)
        ,COM = 0 --no se paga comisión a TPF en la liquidación
    ;
  COMMIT;

  UPDATE TEMP_RI_VENTAFACT_TPF
    SET EQ = (CASE WHEN UPPER(SOLUCION) LIKE '%POSTPAGO%' THEN PACK ELSE PACK-0.1 END) --postpago = precio_sku, todo prepago = precio_sku-0.1
        ,EQ_SIN_IGV = (CASE WHEN UPPER(SOLUCION) LIKE '%POSTPAGO%' THEN PACK ELSE PACK-0.1 END)/1.18 --eq/1.18
        ,SS_SIN_IGV = SS/1.18
        ,PACK_SIN_IGV = PACK/1.18
        ,NETO = PACK - COM
        --en caso el periodo se haya generado con '0' adelante por considerarse el año con 2 caracteres en el update anterior
        ,PERIODO = (CASE WHEN SUBSTR(PERIODO,1,1) = '0' THEN '2'||SUBSTR(PERIODO,2,5) ELSE PERIODO END)
    ;
  COMMIT;

  --INSERTAR REGISTROS TPF EN SU TABLA FINAL
  DELETE FROM RI_VENTAFACT_TPF A
  WHERE EXISTS (SELECT  FECHA_CIERRE_ORDEN
                FROM    TEMP_RI_VENTAFACT_TPF
                WHERE   PERIODO = A.PERIODO
                        AND FECHA_CIERRE_ORDEN = A.FECHA_CIERRE_ORDEN
                        AND TIPO_BASE = A.TIPO_BASE);
  COMMIT;

  INSERT INTO RI_VENTAFACT_TPF
  (FECHAPROCESO, PERIODO, FECHA_CREACION_ORDEN, FECHA_CIERRE_ORDEN, SOCIO_NEGOCIO,
            TIENDA, ID_TIENDA, VENDEDOR, ORDEN, COD_CLIENTE, CLIENTE, PRODUCTO, MODELO,
            PLAN_TARIFARIO_ORIGEN, PLAN_TARIFARIO, VOUCHER, SOLUCION, PRECIO, CANTIDAD,
            MONTO_TOTAL, COSTO_EQUIPO, PRECIO_EXCEPCION, TIPO_MONEDA, RENTA_ADELANTADA,
            NUMERO_CUOTAS, IMEI, SIM, CONTRATO, TELEFONO, TIPO_OPERACION, PACK, EQ,
            EQ_SIN_IGV, SS, SS_SIN_IGV, PACK_SIN_IGV, COM, NETO, TIPO_BASE, POST_PRE)
    SELECT  SYSDATE, PERIODO, FECHA_CREACION_ORDEN, FECHA_CIERRE_ORDEN, SOCIO_NEGOCIO,
            TIENDA, ID_TIENDA, VENDEDOR, ORDEN, COD_CLIENTE, CLIENTE, PRODUCTO, MODELO,
            PLAN_TARIFARIO_ORIGEN, PLAN_TARIFARIO, VOUCHER, SOLUCION, TO_NUMBER(PRECIO), CANTIDAD,
            TO_NUMBER(MONTO_TOTAL), TO_NUMBER(COSTO_EQUIPO), TO_NUMBER(PRECIO_EXCEPCION), TIPO_MONEDA, TO_NUMBER(RENTA_ADELANTADA),
            NUMERO_CUOTAS, IMEI, SIM, CONTRATO, TELEFONO, TIPO_OPERACION, PACK, EQ,
            EQ_SIN_IGV, SS, SS_SIN_IGV, PACK_SIN_IGV, COM, NETO, TIPO_BASE, POST_PRE
    FROM    TEMP_RI_VENTAFACT_TPF;
  COMMIT;

  --INSERTAR REGISTROS TPF EN TABLA DE VENTAS FACTURADAS
  DELETE FROM ri_ventafact_socionegocio A
  WHERE TIPO_BASE = V_TIPOBASE AND EXISTS (
              SELECT FECHA_CIERRE_ORDEN
              FROM TEMP_RI_VENTAFACT_TPF
              WHERE PERIODO = A.PERIODO_ORDEN AND FECHA_CIERRE_ORDEN = A.FECHA_ORDEN_RETAIL AND TIPO_BASE = A.TIPO_BASE
              );
  COMMIT;

  INSERT INTO ri_ventafact_socionegocio
  (FECHAPROCESO,PERIODO_ORDEN,FECHA_ORDEN_RETAIL,CANAL,CADENA,SUCURSAL,NRO_ORDEN_RETAIL,COD_CLIENTE,CLIENTE,PRODUCTO,MODELO,PLAN,
    VOUCHER,SOLUCION,POST_PRE,PRECIO_SKU,IMEI,SIM,CONTRATO,TELEFONO,TIPO_ORDEN,PACK,COSTO_EQUIPO,COSTO_SERVICIO,COM_VARIABLE,FACT_ENTEL,TIPO_BASE)
      SELECT  SYSDATE,PERIODO,FECHA_CIERRE_ORDEN,'AGENTE-TIENDA EXPRESS',SOCIO_NEGOCIO,TIENDA,ORDEN,COD_CLIENTE,CLIENTE,PRODUCTO,MODELO,PLAN_TARIFARIO,
              VOUCHER,SOLUCION,POST_PRE,PRECIO,IMEI,SIM,CONTRATO,TELEFONO,TIPO_OPERACION,PACK,EQ,SS,COM,NETO,TIPO_BASE
      FROM    TEMP_RI_VENTAFACT_TPF;
  COMMIT;

  CI_VENTAFACTURADA_RES_TPF(p_periodo,V_TIPOBASE);

END CI_VENTAFACTURADA_TPF_LOAD;

PROCEDURE CI_VENTAFACTURADA_RESUMEN(p_periodo IN VARCHAR2, p_tipobase IN VARCHAR2)
IS
  V_PERIODO VARCHAR2(6) := p_periodo;
  V_TIPO_BASE VARCHAR2(9) := p_tipobase;
BEGIN

  /*PESTAÑA "Resumen Facturación y Comisiones"*/

  --Mantener tabla de resumen actualizada
  DELETE FROM RI_VENTAFACT_RES_SN WHERE PERIODO_ORDEN = V_PERIODO AND TIPO_BASE = V_TIPO_BASE;
  COMMIT;

  INSERT INTO RI_VENTAFACT_RES_SN
  (PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE, FACT_ENTEL, COM_TOTAL, COM_VARIABLE, COM_FIJA, TIPO_BASE)
    SELECT  PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE
          ,SUM(FACT_ENTEL) TOT_FACT_ENTEL
          ,SUM(COM_TOTAL) TOT_COM_TOTAL
          ,SUM(COM_VARIABLE) TOT_COM_VARIABLE
          ,SUM(COM_FIJA) TOT_COM_FIJA
          ,TIPO_BASE
    FROM    ri_ventafact_socionegocio
    WHERE   PERIODO_ORDEN = V_PERIODO AND TIPO_BASE = V_TIPO_BASE
    GROUP BY PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE, TIPO_BASE
    ORDER BY CANAL, CADENA, SOLUCION;
  COMMIT;

  --Devolver cursor con detalle para las pivots
 -- OPEN pcursor FOR
 -- SELECT  PERIODO_ORDEN, CANAL, CADENA, SOLUCION, POST_PRE, FACT_ENTEL, COM_TOTAL, COM_VARIABLE, COM_FIJA
 -- FROM    RI_VENTAFACTURADA_RES
 -- WHERE   PERIODO_ORDEN = V_PERIODO;

END CI_VENTAFACTURADA_RESUMEN;

PROCEDURE CI_VENTAFACTURADA_RES_TPF(p_periodo IN VARCHAR2, p_tipobase IN VARCHAR2)
IS
  V_PERIODO VARCHAR2(6) := p_periodo;
  V_TIPOBASE VARCHAR2(12):= p_tipobase;
BEGIN

  /*PESTAÑA "Resumen Express"*/

  --Mantener tabla de resumen actualizada
  DELETE FROM RI_VENTAFACT_RES_TPF WHERE PERIODO = V_PERIODO AND TIPO_BASE = V_TIPOBASE;
  COMMIT;

  INSERT INTO RI_VENTAFACT_RES_TPF
  (PERIODO, SOCIO_NEGOCIO, SOLUCION, POST_PRE, SUM_NETO, SUM_MONTO_TOTAL, TIPO_BASE)
    SELECT  PERIODO, SOCIO_NEGOCIO, SOLUCION, POST_PRE, SUM(NETO) AS SUM_NETO, SUM(MONTO_TOTAL) AS SUM_MONTO_TOTAL, TIPO_BASE
    FROM    RI_VENTAFACT_TPF
    WHERE   PERIODO = V_PERIODO AND TIPO_BASE = V_TIPOBASE
    GROUP BY PERIODO, SOCIO_NEGOCIO, SOLUCION, POST_PRE, TIPO_BASE
    ORDER BY PERIODO, SOCIO_NEGOCIO;
  COMMIT;

END CI_VENTAFACTURADA_RES_TPF;

PROCEDURE CI_VENTAFACTURADA_RES_FA(p_periodo IN VARCHAR2)
IS
  V_PERIODO VARCHAR2(6) := p_periodo;
BEGIN

    /*PESTAÑA "Reporte vs Facturación"*/

  --Mantener tabla de resumen actualizada
  DELETE FROM RI_VENTAFACT_RES_FACT WHERE PERIODO_ORDEN = V_PERIODO;
  COMMIT;

  INSERT INTO RI_VENTAFACT_RES_FACT
  (PERIODO_ORDEN, CODIGO_SUCURSAL, CADENA, DOCUMENTO, SUM_FACT_ENTEL, SUM_MONTO_CONIGV, DIF)
    select  a.PERIODO_ORDEN, a.codigo_sucursal, a.cadena, b.documento, a.tot_fact_nextel
            ,sum(b.monto_conigv) as tot_monto_conigv
            ,(sum(b.monto_conigv)-a.tot_fact_nextel) as dif
    from    (
            select  PERIODO_ORDEN, codigo_sucursal, cadena, sum(fact_entel) tot_fact_nextel
            from    ri_ventafact_socionegocio
            where   PERIODO_ORDEN = V_PERIODO
            group by PERIODO_ORDEN,codigo_sucursal, cadena
            ) A
            ,ri_ventafact_facturacion B
    where   A.PERIODO_ORDEN = b.periodo
            and a.codigo_sucursal = b.codigo
    group by a.PERIODO_ORDEN, a.codigo_sucursal, a.cadena, a.tot_fact_nextel, b.codigo, b.cliente, b.documento
    order by a.PERIODO_ORDEN, a.codigo_sucursal, b.documento;
  COMMIT;

END CI_VENTAFACTURADA_RES_FA;

PROCEDURE CI_VENTAFACTURADA_MA_COMISION(p_periodo IN VARCHAR2)
IS
    V_PERIODO VARCHAR2(6) := p_periodo;
BEGIN

    --setear periodo y dar formato a campos de porcentaje de comisión variable en la tabla temporal
    UPDATE ODS_GPF.temp_RI_VENTAFACT_MA_COMISION
    SET PERIODO = V_PERIODO,
        COMVAR_POST = NVL((CASE
                              --si el último caracter no es % y tiene un punto, entonces viene como decimal
                              WHEN SUBSTR(COMVAR_POST,-1) <> '%' AND INSTR(COMVAR_POST,'.') > 0 THEN COMVAR_POST
                              --viene como porcentaje
                              ELSE
                                --cuando el último caracter es porcentaje, entonces se le quita el simbolo de % (último caracter) y se convierte a decimal
                                (CASE WHEN SUBSTR(COMVAR_POST,-1) = '%' THEN TO_CHAR(TO_NUMBER(SUBSTR(COMVAR_POST,1,LENGTH(COMVAR_POST)-1))/100) END)
                          END),0),
        COMVAR_PRE = NVL((CASE
                              --si el último caracter no es % y tiene un punto, entonces viene como decimal
                              WHEN SUBSTR(COMVAR_PRE,-1) <> '%' AND INSTR(COMVAR_PRE,'.') > 0 THEN COMVAR_PRE
                              --viene como porcentaje
                              ELSE
                                --cuando el último caracter es porcentaje, entonces se le quita el simbolo de % (último caracter) y se convierte a decimal
                                (CASE WHEN SUBSTR(COMVAR_PRE,-1) = '%' THEN TO_CHAR(TO_NUMBER(SUBSTR(COMVAR_PRE,1,LENGTH(COMVAR_PRE)-1))/100) END)
                          END),0);
    COMMIT;

    --Mantener tabla maestra
    DELETE FROM ODS_GPF.ri_ventafact_ma_comision WHERE PERIODO = V_PERIODO;

    INSERT INTO ODS_GPF.ri_ventafact_ma_comision
    (FECHAPROCESO, PERIODO, CADENA, CODIGO, CANAL, COMVAR_POST, COMVAR_PRE, COMFIJ_POST, COMFIJ_PRE, OBSERVACIONES)
        SELECT  SYSDATE, PERIODO, CADENA, CODIGO, CANAL, TO_NUMBER(COMVAR_POST), TO_NUMBER(COMVAR_PRE), COMFIJ_POST, COMFIJ_PRE, OBSERVACIONES
        FROM    ODS_GPF.temp_ri_ventafact_ma_comision;

    COMMIT;

END CI_VENTAFACTURADA_MA_COMISION;

PROCEDURE YOUTUBE_ILIMITADO_USUARIOS (V_FECHA IN DATE) IS

BEGIN

    /* LÓGICA CON ARCHIVOS DE APROVISIONAMIENTO - TI
    MERGE INTO (SELECT * FROM TEMP_TRAFICO_INTERNET WHERE FECHA = TRUNC(V_FECHA)) A
    USING ( SELECT A.*
                     , DECODE(estado_servicio,'A',TRUNC(V_FECHA),date_servicio-1) final_servicio
                  FROM
                (SELECT co_id
                     , estado_contrato
                     , estado_servicio
                     , date_servicio
                     , fecha_proceso
                     , MIN(date_servicio) OVER (PARTITION BY CO_ID) inicio_serv
                     , ROW_NUMBER() OVER (PARTITION BY CO_ID ORDER BY date_servicio desc, fecha_proceso desc) RN
                  FROM CC_USUARIOS_YOUTUBE_GRATIS x
                 WHERE fecha_proceso<= TRUNC(V_FECHA)+1) A
                WHERE RN = 1 ) B
    ON (A.contrato = B.co_id)
    WHEN MATCHED THEN UPDATE SET A.ser_113_gratis = 'GRATIS'
    WHERE A.FECHA BETWEEN  B.inicio_serv AND B.final_servicio;*/

/*
    MERGE INTO (SELECT * FROM TEMP_TRAFICO_INTERNET WHERE FECHA = TRUNC(V_FECHA)) X
    USING (SELECT a.fecha, a.nroactivaciones, a.nrosuspensiones,
                   a.nrodesactivaciones, a.codigocontratofuente,
                   a.fechacarga, a.servicio
          FROM (
                        SELECT a.*, row_number() over (PARTITION BY codigocontratofuente
                                                           ORDER BY TO_DATE(fecha,'DD/MM/YYYY HH24:MI:SS') desc)  rn
                          FROM dwh_servicio_streaming a
                         WHERE TRUNC(TO_DATE(fecha,'DD/MM/YYYY HH24:MI:SS')) <= TRUNC(V_FECHA)
                    ) a
         WHERE rn = 1 AND nroactivaciones >0) Y
     ON (X.contrato = Y.codigocontratofuente)
     WHEN MATCHED THEN UPDATE SET ser_113_gratis = 'GRATIS';
*/

    COMMIT;

END YOUTUBE_ILIMITADO_USUARIOS;


PROCEDURE CC_BUSQUEDA_CONSOLIDADO (V_PERIODO_INI VARCHAR2, V_PERIODO_FIN VARCHAR2, V_CAMPO VARCHAR2
                                    , pcursor OUT T_CURSOR, pcursor2 OUT T_CURSOR
                                    , pcursor3 OUT T_CURSOR, pcursor4 OUT T_CURSOR) IS

V_CAMPO_AUX varchar2(90);
V_CAMPO_AUX2 varchar2(90);
BEGIN

    IF V_CAMPO = 'documento' THEN
        V_CAMPO_AUX := 'ruccompania';
        V_CAMPO_AUX2 := 'ruccompania';
    ELSIF V_CAMPO = 'contrato' THEN
        V_CAMPO_AUX := 'codigocontratobscs';
        V_CAMPO_AUX2 := 'contrato';
    ELSIF V_CAMPO = 'telefono' THEN
        V_CAMPO_AUX := 'telefono';
        V_CAMPO_AUX2 := 'telefono';
    END IF;

OPEN pcursor FOR --DATOS
      'SELECT a.compania'
    || '    , a.ruccompania'
    || '    , a.telefono'
    || '    , a.contrato'
    || '    , a.periodo_fact'
    || '    , a.ciclo'
    || '    , a.n_plan'
    || '    , a.c_plan'
    || '    , a.mb'
    || '    , a.mb_whatsapp'
    || '    , a.mb_youtube'
    || '    , a.bucket_mb'
    || '    , a.adic_mb'
    || '    , a.adic_precio'
    || '    , NVL(e.limite_credito,DECODE(obtener_tipodoc_2(a.RUCCOMPANIA),''RUC20'','
    || '           CASE WHEN  contratos_comp < 4  THEN 500'
    || '                WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800'
    || '                WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200'
    || '                WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000'
    || '                WHEN  contratos_comp >=80 THEN 4500'
    || '           END'
    || '              , 500) )  LIMITE_CC'
    || '    , ROUND(a.adic_precio / NVL(e.limite_credito,DECODE(obtener_tipodoc_2(a.RUCCOMPANIA),''RUC20'','
    || '           CASE WHEN  contratos_comp < 4  THEN 500'
    || '                WHEN  contratos_comp >=4  AND contratos_comp < 11 THEN 800'
    ||'                WHEN  contratos_comp >=11 AND contratos_comp < 20 THEN 1200'
    || '                WHEN  contratos_comp >=20 AND contratos_comp < 80 THEN 2000'
    || '                WHEN  contratos_comp >=80 THEN 4500'
    || '           END , 500 )) ,4 ) RATIO_LDC'
    || '    , a.fecha_ini'
    || '    , a.fecha_fin'
    || '    , a.fecha_proceso'
    || '    , NVL(validacion.validacion,''ACTIV. ANTES DE BIO'')validacion'
    || ' FROM cc_datos_resumen_ciclo a'
    || ' JOIN cc_busqueda b'
    || '  ON '|| V_CAMPO_AUX2 ||' = b.campo'
    || ' LEFT JOIN cc_especiales e'
    || '   ON a.codigocompania =  e.codigocompania'
    || '  LEFT JOIN pm_planes p'
    || '   ON a.c_plan = p.c_plan'
    || ' LEFT JOIN'
    || '   (SELECT contrato'
    || '        , DECODE(validacion_identidad,''NOT BIOMETRIC'',''NO BIO: '',''BIOMETRIC'',''BIO: '',validacion_identidad)'
    || '        ||DECODE(resultado_validacion,''NO VALIDADO'','''',resultado_validacion) VALIDACION'
    || '   FROM p_inar'
    || '   WHERE estadoinar in (''NEWS'',''ADDS'',''REAC'')) validacion'
    || ' ON a.contrato = validacion.contrato'
    || ' WHERE periodo_fact BETWEEN '''||V_PERIODO_INI||''' AND '''||V_PERIODO_FIN ||'''';



OPEN pcursor2 FOR --LDI
       ' SELECT   a.compania'
    || '        , a.ruccompania   '
    || '        , a.telefono'
    || '        , a.codigocontratobscs'
    || '        , a.periodo_facturacion'
    || '        , a.plantarifario'
    || '            , a.c_plan'
    || '            , a.pais'
    || '            , a.tipo_destino'
    || '            , a.minutos'
    || '            , a.llamadas'
    || '            , TRIM(TO_CHAR(a.precio ,''999999.99'')) precio'
    || '            , a.min_telefono'
    || '            , TRIM(TO_CHAR(a.precio_telefono ,''999999.99'')) precio_telefono'
    || '            , a.min_compania'
    || '            , TRIM(TO_CHAR(a.precio_compania ,''999999.99'')) precio_compania'
    || '            , a.limite_credito_cc'
    || '            , a.fecha_proceso'
    || '            , a.celda'
    || '            , a.fecha_inicial'
    || '            , a.fecha_final'
    || '            , NVL(validacion.validacion,''ACTIV. ANTES DE BIO'')validacion'
    || '      FROM cc_ldi_resumen_ciclo a'
    || '      JOIN cc_busqueda x '
    || '       ON '|| V_CAMPO_AUX ||' = x.campo'
    || '      LEFT JOIN (SELECT *'
    || '                   FROM ( SELECT a.*'
    || '                               , rank() over (PARTITION BY telefono'
    || '                                                  ORDER BY fechacargacontrato desc) rn'
    || '                            FROM fotoequipos a )'
    || '                  WHERE rn = 1 ) b'
    || '        ON a.telefono = ''51''||b.telefono'
    || '        LEFT JOIN'
    || '         ( Select distinct a.*,b.numerocuentaresponsable from'
    || '                                 (select  NUMEROCUENTACOMPANIA, count(distinct codigocontratobscs) numcontratos'
    || '                                                        from fotoequipos'
    || '                                                       where estadocontrato in (''Activo'',''Suspendido'')'
    || '                                                         and product not like ''%Pre%'''
    || '                                                         and tipopersona = ''Jurídica'''
    || '                                                    group by NUMEROCUENTACOMPANIA ) a'
    || '                                left join fotoequipos b'
    || '                                on a.NUMEROCUENTACOMPANIA= b.NUMEROCUENTACOMPANIA ) ccontratos'
    || '        ON b.numerocuentaresponsable  = ccontratos.numerocuentaresponsable'
    || '     LEFT JOIN pm_planes p'
    || '       ON a.c_plan = p.c_plan'
    || '      LEFT JOIN'
    || '            (SELECT contrato'
    || '                 , DECODE(validacion_identidad,''NOT BIOMETRIC'',''NO BIO: '',''BIOMETRIC'',''BIO: '',validacion_identidad)'
    || '                 ||DECODE(resultado_validacion,''NO VALIDADO'','''',resultado_validacion) VALIDACION'
    || '            FROM p_inar'
    || '            WHERE estadoinar in (''NEWS'',''ADDS'',''REAC'')) validacion'
    || '          ON a.codigocontratobscs = validacion.contrato'
    || '    WHERE a.periodo_facturacion BETWEEN '''||V_PERIODO_INI||''' AND '''||V_PERIODO_FIN ||'''';


OPEN pcursor3 FOR -- LOCAL
           'SELECT   a.compania'
        ||'        , a.ruccompania'
        ||'        , a.telefono'
        ||'        , a.contrato'
        ||'        , a.periodo_facturacion'
        ||'        , a.ciclofacturacioncontrato'
        ||'        , a.plan_tarifario'
        ||'        , a.c_plan'
        ||'        , a.minutos_onnet'
        ||'        , a.minutos_offnet_movil'
        ||'        , a.minutos_offnet_fijo'
        ||'        , a.exceso_minutos_onnet exceso_minutos_onnet'
        ||'        , a.exceso_minutos_offnet_movil exceso_minutos_offnet_movil'
        ||'        , a.exceso_minutos_offnet_fijo exceso_minutos_offnet_fijo'
        ||'        , a.exceso_minutos_offnet exceso_minutos_offnet'
        ||'        , a.exceso_minutos_td exceso_minutos_td'
        ||'        , a.exceso_precio_onnet exceso_precio_onnet'
        ||'        , a.exceso_precio_offnet_movil exceso_precio_offnet_movil'
        ||'        , a.exceso_precio_offnet_fijo exceso_precio_offnet_fijo'
        ||'        , a.exceso_precio_offnet exceso_precio_offnet'
        ||'        , a.exceso_precio_td exceso_precio_td'
        ||'        , a.limite_credito_cc limite_credito_cc'
        ||'        , a.fecha_proceso'
        ||'        ,NVL(exceso_precio_onnet,0)'
        ||'        +NVL(exceso_precio_offnet_movil,0)'
        ||'        +NVL(exceso_precio_offnet_fijo,0)'
        ||'        +NVL(exceso_precio_offnet,0)'
        ||'        +NVL(exceso_precio_td,0) EXCESO_PRECIO_TOTAL'
        ||'     ,ROUND((NVL(exceso_precio_onnet,0)'
        ||'        +NVL(exceso_precio_offnet_movil,0)'
        ||'        +NVL(exceso_precio_offnet_fijo,0)'
        ||'        +NVL(exceso_precio_offnet,0)'
        ||'        +NVL(exceso_precio_td,0))/limite_credito_cc,4) RATIO_CREDITO'
        ||'    ,a.fecha_inicial'
        ||'    ,a.fecha_final'
        ||'    ,NVL(validacion.validacion,''ACTIV. ANTES DE BIO'')validacion'
        ||'  FROM cc_local_resumen_ciclo a'
        ||'  JOIN cc_busqueda x '
        ||'    ON '|| V_CAMPO_AUX2 ||' = x.campo'
        ||'  LEFT JOIN pm_planes p'
        ||'    ON a.c_plan = p.c_plan'
        ||'  LEFT JOIN'
        ||'        (SELECT contrato'
        ||'             , DECODE(validacion_identidad,''NOT BIOMETRIC'',''NO BIO: '',''BIOMETRIC'',''BIO: '',validacion_identidad)'
        ||'             ||DECODE(resultado_validacion,''NO VALIDADO'','''',resultado_validacion) VALIDACION'
        ||'        FROM p_inar'
        ||'        WHERE estadoinar in (''NEWS'',''ADDS'',''REAC'')) validacion'
        ||'      ON a.contrato = validacion.contrato'
        ||'   WHERE a.periodo_facturacion BETWEEN '''||V_PERIODO_INI||''' AND '''||V_PERIODO_FIN ||'''';


OPEN pcursor4 FOR --roam tapin
              'SELECT  a.tipopersona,'
||'                  a.tipocuenta,'
||'                  a.compania,'
||'                  a.fecha_proceso,'
||'                  a.imsi,'
||'                  a.telefono,'
||'                  a.consumoLlamadas_minutos,'
||'                  a.montoLlamadas,'
||'                  a.consumoMensajes_cant,'
||'                  a.montoMensajes,'
||'                  a.consumoDatos_KB,'
||'                  a.montoDatos,'
||'                  a.monto_total,'
||'                  a.totalcuenta,'
||'                  a.fechaini,'
||'                  a.fechafin,'
||'                  a.LIMITE_EMPRESA ,'
||'                  a.numcontratos ,'
||'                  a.c_plan,'
||'                  p.n_plan,'
||'                  NVL(validacion.validacion,''ACTIV. ANTES DE BIO'')validacion'
||'                  , emp.modalidad_contratacion'
||'                  , a.periodo_facturacion'
||'                  , a.ciclo'
||'                  , a.ruccompania'
||'            FROM  (select a.*,foto.ruccompania from cc_roaming3g_ciclo a LEFT JOIN fotoequipos foto ON a.contrato = foto.codigocontratobscs) a'
||'            LEFT JOIN pm_planes p'
||'              ON  a.c_plan = p.c_plan'
||'            LEFT JOIN fotoequipos foto'
||'              ON a.contrato = foto.codigocontratobscs'
||'            JOIN cc_busqueda b'
||'              ON a.'|| V_CAMPO_AUX2 ||' = b.campo'
||'            LEFT JOIN (SELECT * FROM P_EMPLEADO WHERE activo = 1) emp'
||'              ON a.ruccompania = emp.dni'
||'            LEFT JOIN'
||'                 (SELECT contrato'
||'                      , DECODE(validacion_identidad,''NOT BIOMETRIC'',''NO BIO: '',''BIOMETRIC'',''BIO: '',validacion_identidad)'
||'                      ||DECODE(resultado_validacion,''NO VALIDADO'','''',resultado_validacion) VALIDACION'
||'                 FROM p_inar'
||'                 WHERE estadoinar in (''NEWS'',''ADDS'',''REAC'')) validacion'
||'               ON a.contrato = validacion.contrato'
||'            WHERE a.periodo_facturacion BETWEEN '''||V_PERIODO_INI||''' AND '''||V_PERIODO_FIN||''''
||'              AND foto.estadocontrato <> ''Desactivado''';

END CC_BUSQUEDA_CONSOLIDADO;

PROCEDURE CI_QRY_TIPOBASE(P_TIPOBASE VARCHAR2,P_PERIODO VARCHAR2,pcursor OUT t_cursor) IS

V_PERIODO_ANT VARCHAR2(8);

BEGIN
V_PERIODO_ANT := TO_CHAR(ADD_MONTHS(TO_DATE(P_PERIODO,'YYYYMM'),-1),'YYYYMM');

IF(P_TIPOBASE='VF')
THEN  OPEN pcursor FOR
        SELECT P2.TIPO_BASE,
               NVL(P1.CANTIDAD,0),
               P2.CANTIDAD,
               NVL(ROUND((P2.CANTIDAD-P1.CANTIDAD)*100/P1.CANTIDAD,2),0) VARIACION
        FROM
        (SELECT Periodo_orden PERIODO,
                DECODE(tipo_base,'VF','Socio de Negocio') tipo_base,
                COUNT(1) CANTIDAD
                FROM ri_ventafact_socionegocio
                WHERE Periodo_orden= V_PERIODO_ANT and tipo_base='VF'
                group by periodo_orden,tipo_base)P1
        FULL OUTER JOIN
        (SELECT Periodo_orden PERIODO,
                DECODE(tipo_base,'VF','Socio de Negocio') tipo_base,
                COUNT(1) CANTIDAD
                FROM ri_ventafact_socionegocio
                WHERE Periodo_orden= P_PERIODO and tipo_base='VF'
                group by periodo_orden,tipo_base)P2
        ON P1.TIPO_BASE=P2.TIPO_BASE;
ELSE IF(P_TIPOBASE LIKE 'TPF%')
THEN  OPEN pcursor FOR
        SELECT P2.TIPO_BASE,
               NVL(P1.CANTIDAD,0),
               P2.CANTIDAD,
               NVL(ROUND((P2.CANTIDAD-P1.CANTIDAD)*100/P1.CANTIDAD,2),0) VARIACION
        FROM
        (SELECT PERIODO,tipo_base,COUNT(1) CANTIDAD
                FROM RI_VENTAFACT_TPF
                WHERE PERIODO=V_PERIODO_ANT
                group by PERIODO
                ,tipo_base) P1
        FULL OUTER JOIN
        (SELECT PERIODO,tipo_base,COUNT(1) CANTIDAD
                FROM RI_VENTAFACT_TPF
                WHERE PERIODO=P_PERIODO
                group by PERIODO
                ,tipo_base) P2
        ON P1.TIPO_BASE=P2.TIPO_BASE;

ELSE IF(P_TIPOBASE ='FACTURACION')
THEN  OPEN pcursor FOR
        SELECT P2.TIPO_BASE,
               NVL(P1.CANTIDAD,0),
               P2.CANTIDAD,
               NVL(ROUND((P2.CANTIDAD-P1.CANTIDAD)*100/P1.CANTIDAD,2),0) VARIACION
        FROM
        (SELECT PERIODO,'Facturación' TIPO_BASE,COUNT(1) CANTIDAD
                FROM RI_VENTAFACT_FACTURACION
                WHERE PERIODO=V_PERIODO_ANT
                GROUP BY PERIODO)P1
        FULL OUTER JOIN
        (SELECT PERIODO,'Facturación' TIPO_BASE,COUNT(1) CANTIDAD
                FROM RI_VENTAFACT_FACTURACION
                WHERE PERIODO=P_PERIODO
                GROUP BY PERIODO)P2
        ON P1.TIPO_BASE=P2.TIPO_BASE;

ELSE IF(P_TIPOBASE ='COMISION')
THEN  OPEN pcursor FOR
        SELECT P2.TIPO_BASE,
               NVL(P1.CANTIDAD,0),
               P2.CANTIDAD,
               NVL(ROUND((P2.CANTIDAD-P1.CANTIDAD)*100/P1.CANTIDAD,2),0) VARIACION
        FROM
        (SELECT  PERIODO,'Comision' tipo_base,COUNT(1) CANTIDAD
                FROM ri_ventafact_ma_comision
                WHERE PERIODO= V_PERIODO_ANT
                group by PERIODO)P1
        FULL OUTER JOIN
        (SELECT  PERIODO,'Comision' tipo_base,COUNT(1) CANTIDAD
                FROM ri_ventafact_ma_comision
                WHERE PERIODO= P_PERIODO
                group by PERIODO)P2
        ON P1.TIPO_BASE=P2.TIPO_BASE;
END IF;
END IF;
END IF;
END IF;
END CI_QRY_TIPOBASE;

PROCEDURE CI_VENTASFACTURADAS_CORREO(P_TIPO VARCHAR2,P_PERIODO varchar2,FLAG varchar2) iS

  HTML CLOB;
  P_TO VARCHAR2(200);
  P_TO2 VARCHAR2(200);
  P_TO3 VARCHAR2(200);
  P_TO4 VARCHAR2(200);
  P_FROM VARCHAR2(200);
  P_SUBJECT VARCHAR2(200);
  P_TEXT VARCHAR2(200);
  P_HTML CLOB;
  P_SMTP_HOSTNAME VARCHAR2(200);
  P_SMTP_PORTNUM VARCHAR2(200);
  PCURSOR SYS_REFCURSOR;
  V_TIPO_LABEL VARCHAR2(30);
  VAR1 VARCHAR2(100);
  VAR2 NUMBER;
  VAR3 NUMBER;
  VAR4 NUMBER;
  V_PERIODO_ANT VARCHAR(6);


  BEGIN
  IF(P_TIPO='VF') THEN V_TIPO_LABEL:='Socio de Negocio'; END IF;
  IF(P_TIPO like 'TPF%') THEN V_TIPO_LABEL:='Tiendas Propias Franquiciadas';  END IF;
  IF(P_TIPO ='FACTURACION') THEN V_TIPO_LABEL:='Facturaci&oacute;n';  END IF;
  IF(P_TIPO ='COMISION') THEN V_TIPO_LABEL:='Comisi&oacute;n';  END IF;
  IF(UPPER(P_TIPO) ='AJUSTE') THEN V_TIPO_LABEL:='Ajuste de Socios de Negocio';  END IF;
  V_PERIODO_ANT := TO_CHAR(ADD_MONTHS(TO_DATE(P_PERIODO,'YYYYMM'),-1),'YYYYMM');


 HTML := '<h1 style = "font-size:20px;font-family:sans-serif; ">'||
                'Carga de bases. Ventas facturadas'||
            '</h1>';
IF(FLAG='1')
THEN
    HTML:= '<p>Finaliz&oacute; la carga de la base '||V_TIPO_LABEL||'.'||
    '<style>'||
                '  table { margin:0px;padding:0px;'||
                     '   border:1px solid #000000;'||
                     '   border-collapse: collapse;'||
                      '   border-spacing: 0;'||
                     '   height:100%;'||
                     '   margin:0px;padding:0px;'||
                   ' } .fr td{ '||
                       ' background-color:#3177e0;'||
                       ' text-align:center;'||
                       ' border-width:0px 0px 1px 1px;'||
                       ' font-size:12px;'||
                       ' font-family:sans-serif;'||
                       ' font-weight:bold;'||
                       ' color:#ffffff;'||
                   ' }  td{'||
                    '    vertical-align:middle;'||
                    '    background-color:#ffffff;'||
                    '    border:1px solid #000000;'||
                     '   border-width:0px 1px 1px 0px;'||
                     '   text-align:left;'||
                     '   padding:5px;'||
                     '   font-size:10px;'||
                      '  font-family:sans-serif;'||
                      '  color:#000000;'||
                   ' }' ||
             '</style>' ||
          '<table  border="1">'||
            '<tr class="fr"><td>Tipo Base</td><td>'||V_PERIODO_ANT||'</td><td>'||P_PERIODO||'</td><td>Variación(%)</td></tr>';
    Paquete_Riesgos.CI_QRY_TIPOBASE(P_TIPO,P_PERIODO,pcursor);
    LOOP
      FETCH PCURSOR INTO VAR1,VAR2,VAR3,VAR4;
      EXIT WHEN PCURSOR%NOTFOUND;
      HTML := HTML  || '<tr><td style="text-align:right;">'   ||  VAR1
                    || '</td><td style="text-align:right;">'  ||  VAR2
                    || '</td><td style="text-align:right;">'  ||  VAR3
                    || '</td><td style="text-align:right;">'  ||  VAR4
                    || '</td></tr>';
    END LOOP;
    HTML := HTML || '</table>';

ELSIF (FLAG='2') THEN
      HTML:='<p>El archivo ' || P_TIPO||P_PERIODO || '.csv no se encontr&oacute; en la ruta.';
ELSIF (FLAG='3') THEN
      HTML:='<p>El archivo ' || P_TIPO||P_PERIODO || '.csv no pudo ser cargado debido a un error en el proceso.';

END IF;

    P_TO := 'andres.bravo@entel.pe';
    P_TO2:= 'carlos.perez.betancour@entel.pe';
    P_TO3:= 'francisco.espinoza@entel.pe';

    P_FROM := 'ip_alertas@entel.pe';
    P_SUBJECT := 'Carga de bases Ventas Facturadas';
    P_TEXT := 'msg';
    P_HTML := HTML;
    P_SMTP_HOSTNAME := 'relay-procesos.entel.pe';
    P_SMTP_PORTNUM := '25';

    BEGIN HTML_EMAIL(    P_TO => P_TO,     P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    BEGIN HTML_EMAIL(    P_TO => P_TO2,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;
    --BEGIN HTML_EMAIL(    P_TO => P_TO3,    P_FROM => P_FROM,    P_SUBJECT => P_SUBJECT,    P_TEXT => P_TEXT,    P_HTML => P_HTML,   P_SMTP_HOSTNAME => P_SMTP_HOSTNAME,    P_SMTP_PORTNUM => P_SMTP_PORTNUM  ); END;

END CI_VENTASFACTURADAS_CORREO;

PROCEDURE BUSCAR_DEUDA_CONTRATO(pcursor_contrato OUT t_cursor) IS
BEGIN
OPEN pcursor_contrato FOR
  --PESTAÑA CONTRATO
      SELECT codigocompania,razonsocial
            ,equiposactivospostpago activa_post
            ,equiposactivosprepago  activa_pre
            ,desactivacionesmes    desactivados
            ,suspensiones,
            cuentacompania
        FROM P_COMPANIA
        where codigocompania in (select codigocompania
                                 from FOTOEQUIPOS
                                 where codigocontratobscs in (select CODIGOCONTRATO from BUSQUEDA_DEUDAS))
       and--a.campo1=b.cuentacompania(+) and
      codigocompania is not null
      and codigocompania is not null;
END BUSCAR_DEUDA_CONTRATO;

PROCEDURE BUSCAR_DEUDA_DETALLE(pcursor_detalle OUT t_cursor) IS
BEGIN
OPEN pcursor_detalle FOR
  --PESTAÑA DETALLE
        select codigocuenta,
               codigocompania,
               razonsocial,
               contrato,
               --estadocontrato,    --CAMPO ELIMINADO EN 201610
               c_plan,
               n_plan,
               ciclo,
               to_char(fechaactivacion,'dd/mm/yyyy') fechaactivacion,
               monto_total_deuda,
               pago_total,
               nvl(monto_total_deuda-pago_total,0) deuda,
               canal
        from
        (
          select 'personas' as canal,monto_total_deuda, pago_total, fecha_facturacion, fecha_vencimiento,codigocuenta,contrato,n_plan,ciclo,fechaactivacion,c_plan,razonsocial,codigocompania
          from tnp_inar_personas_ods WHERE  contrato IN (SELECT CODIGOCONTRATO FROM BUSQUEDA_DEUDAS)
          union all
          select 'empresas' as canal,monto_total_deuda, pago_total, fecha_facturacion, fecha_vencimiento,codigocuenta,contrato,n_plan,ciclo,fechaactivacion,c_plan,razonsocial,codigocompania
          from tnp_inar_empresas_ods WHERE  contrato IN (SELECT CODIGOCONTRATO FROM BUSQUEDA_DEUDAS)
        );
END BUSCAR_DEUDA_DETALLE;

PROCEDURE BUSQUEDA_ROAMING_CONSUMO(p_telefono VARCHAR2, pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
  SELECT  serimsi AS imsi
        ,sermsisdn AS telefono
        ,to_date(substr(recopentim,1,8),'yyyymmdd') fecha
        ,pais
        ,banda
        ,tarifa
        ,sum(volup+voldown)/1024 KB
        ,sum(volup+voldown)/1024/1024 MB
        ,SUM( (VOLDOWN+VOLUP)*TARIFA )/1024 AS MONTO
FROM    roaming_ggsn_cdr
WHERE   sermsisdn = '51'||p_telefono
        AND trunc(sysdate)-to_date(substr(recopentim,1,8),'yyyymmdd') < 31
GROUP BY serimsi, sermsisdn, to_date(substr(recopentim,1,8),'yyyymmdd'), pais, banda,tarifa
ORDER BY to_date(substr(recopentim,1,8),'yyyymmdd');
END BUSQUEDA_ROAMING_CONSUMO;

PROCEDURE BUSCAR_RECHAZADOS_PM(pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
SELECT distinct
nvl(fotoequipos.telefono,'-'),
nvl(accountnumber,'-'),
nvl(fotoequipos.estadocontrato,'-'),
nvl(fotoequipos.solucion,'-'),
nvl(fotoequipos.product,'-')
,nvl(fotoequipos.ciclofacturacioncontrato,'-')
FROM ri_busqueda_rechazados_pm
left join
fotoequipos
on accountnumber=numerocuentaresponsable;

END BUSCAR_RECHAZADOS_PM;

PROCEDURE BUSQUEDA_TAPIN(V_FECHA date,pcursor OUT t_cursor) IS
BEGIN
OPEN pcursor FOR
SELECT * FROM
            (SELECT  a.tipopersona,
                     a.tipocuenta,
                     a.compania,
                     a.fecha_proceso,
                     a.imsi,
                     a.telefono,
                     a.consumoLlamadas_minutos,
                     a.montoLlamadas,
                     a.consumoMensajes_cant,
                     a.montoMensajes,
                     a.consumoDatos_KB,
                     a.montoDatos,
                     a.monto_total,
                     a.totalcuenta,
                     a.fechaini,
                     a.fechafin,
                     a.LIMITE_EMPRESA ,
                     a.numcontratos ,
                     a.c_plan,
                     p.n_plan,
                     NVL(validacion.validacion,'ACTIV. ANTES DE BIO')validacion
                     , emp.modalidad_contratacion
                     , a.periodo_facturacion
                     , a.ciclo
               FROM  cc_roaming3g_ciclo a
               LEFT JOIN pm_planes p
                 ON  a.c_plan = p.c_plan
               LEFT JOIN fotoequipos foto
                 ON a.contrato = foto.codigocontratobscs
               LEFT JOIN (SELECT * FROM P_EMPLEADO WHERE activo = 1) emp
                 ON foto.ruccompania = emp.dni
               LEFT JOIN
                    (SELECT contrato
                         , DECODE(validacion_identidad,'NOT BIOMETRIC','NO BIO: ','BIOMETRIC','BIO: ',validacion_identidad)
                         ||DECODE(resultado_validacion,'NO VALIDADO','',resultado_validacion) VALIDACION
                    FROM p_inar
                    WHERE estadoinar in ('NEWS','ADDS','REAC')) validacion
                  ON a.contrato = validacion.contrato
               WHERE fecha_proceso = TRUNC(V_FECHA)
                 AND foto.estadocontrato <> 'Desactivado'
            ORDER BY DECODE ( a.tipopersona,'Empleado',1,'Natural',2,'Jurídica',3), totalcuenta desc, monto_total desc, tipocuenta);
END BUSQUEDA_TAPIN;

PROCEDURE PROCESARSUSPENCIONESPERSON(p_fecha VARCHAR2, p_tipo VARCHAR2)
IS
BEGIN
-- PROPÓSITO:
--
-- HISTORIAL DE MODIFICACION
-- Usuario                   Fecha           Comentario
-- ----------                ---------       ----------------------
-- CCHAHUAS/FESPINOZA        12/05/2017      Creacion del flujo.
-- --------------------------------------------------------------------------

update TEMP_RI_SUSP_PERSONAS_A set fecha=p_fecha where fecha is null;
update TEMP_RI_SUSP_PERSONAS_A set periodo=substr(p_fecha,1,4)||substr(p_fecha,6,2) where periodo is null;
commit;

delete from RI_SUSP_PERSONAS_DET where to_char(fecha,'yyyymmdd')=substr(p_fecha,1,4)||substr(p_fecha,6,2)||substr(p_fecha,-2) and TIPO_SUSPENSION=p_tipo;
commit;
insert into RI_SUSP_PERSONAS_DET
(CLIENTE,CICLO,CODCUENTA,NRO_TELEFONO,ESTADO,ESTADO_BSCS,CO_ID,FECHA,PERIODO,RUCCOMPANIA,SOLUCION,PLANTARIFARIO,RENTABASICA,COMPANIA,NUMEROCUENTACOMPANIA,TELEFONO,TIPODOCUMENTO,TIPOCLIENTE,DEUDACLIENTE,TIPO_SUSPENSION)
select x.cliente,x.ciclo,x.codcuenta,x.nro_telefono,x.estado,x.estado_bscs,x.co_id,x.fecha,x.periodo,x.ruccompania,x.solucion,x.plantarifario,x.rentabasica,x.compania,x.numerocuentacompania,x.telefono,x.tipodocumento,
            CASE WHEN x.TIPODOCUMENTO='DNI' THEN 'PERSONAS'
                        WHEN SUBSTR(x.TIPODOCUMENTO,1,3)='RUC' THEN 'EMPRESAS' END as tipocliente, NVL(y.deuda,0),p_tipo as TIPO_SUSPENSION
FROM (
select  a.cliente,a.ciclo,a.codcuenta,a.nro_telefono,a.estado,a.estado_bscs,a.co_id,to_date(a.fecha,'yyyy-mm-dd') as fecha,a.periodo,
              b.ruccompania,b.solucion,b.plantarifario,b.rentabasica,b.compania,b.numerocuentacompania,b.telefono,b.codigocompania,
              CASE WHEN LENGTH(b.ruccompania)<=10 THEN 'DNI'
                       WHEN LENGTH(b.ruccompania)>10 AND SUBSTR(b.ruccompania,1,2)='10' THEN  'RUC10'
                       WHEN LENGTH(b.ruccompania)>10 AND SUBSTR(b.ruccompania,1,2)='15' THEN  'RUC15'
                       WHEN LENGTH(b.ruccompania)>10 AND SUBSTR(b.ruccompania,1,2)='17' THEN  'RUC17'
                       WHEN LENGTH(b.ruccompania)>10 AND SUBSTR(b.ruccompania,1,2)='20' THEN  'RUC20'
                       WHEN LENGTH(b.ruccompania)>10 AND SUBSTR(b.ruccompania,1,2)='00' THEN  'DNI' END as tipodocumento
from TEMP_RI_SUSP_PERSONAS_A a ,fotoequipos b
where a.co_id=codigocontratobscs (+)  and estado='EXITO'
) x,(select codigocompania,SUM(deudaservicios) deuda from ODS_GPF.RI_DEUDAS@PODS_LM where fechafoto in (select max(fechafoto) from ODS_GPF.RI_DEUDAS@PODS_LM) group by codigocompania)  y
where x.codigocompania=y.codigocompania (+);
commit;

-- Copiar al PODS_LM
delete from ODS_GPF.RI_SUSP_PERSONAS_DET@PODS_LM where to_char(fecha,'yyyymmdd')=substr(p_fecha,1,4)||substr(p_fecha,6,2)||substr(p_fecha,-2);
commit;

insert into ODS_GPF.RI_SUSP_PERSONAS_DET@PODS_LM
(select * from ODS_GPF.RI_SUSP_PERSONAS_DET where to_char(fecha,'yyyymmdd')=substr(p_fecha,1,4)||substr(p_fecha,6,2)||substr(p_fecha,-2));
commit;

END PROCESARSUSPENCIONESPERSON;

PROCEDURE CC_ROAMING_REPORTE_GC (V_FECHA DATE) AS
BEGIN

    DELETE FROM pf_roaming_rep_dia WHERE fecha >= TRUNC(V_FECHA-30);

    INSERT INTO pf_roaming_rep_dia
    SELECT T.fecha
         , T.numerocuentaresponsable
         , T.telefono
         , T.contrato
         , T.ciclo
         , T.codigocompania
         , T.tipodoc
         , T.periodo_facturacion
         , T.consumo_minutos
         , T.consumo_sms
         , T.consumo_kb
         , T.monto_voz_tapin
         , T.monto_sms_tapin
         , T.monto_datos_tapin
         , G.mb_ggsn
         , G.mb_ggsn_paquete
         , G.mb_ggsn_exceso
         , G.mb_paq_contratado
         , G.compra_paquete
         , CASE WHEN NVL(T.monto_voz_tapin,0)+ NVL(T.monto_sms_tapin,0)+ NVL(T.monto_datos_tapin,0)>0
                OR G.compra_paquete = 'PAQUETE' THEN 'INGRESO' END INGRESO
     FROM
    ( SELECT /*+PARALLEL(8)*/
            c.fecha,
             c.numerocuentaresponsable,
             c.telefono,
             c.contrato,
             c.ciclo,
             c.codigocompania,
             obtener_tipodoc_2(com.ruccompania) tipodoc,
             obtener_periodo_fact_actual (c.ciclo, c.fecha) periodo_facturacion,
             SUM (DECODE (tipollamada, 'LLAMADAS VOZ', consumo, 0)) consumo_minutos,
             SUM (DECODE (tipollamada, 'MENSAJES', consumo, 0)) consumo_sms,
             ROUND ( (SUM (DECODE (tipollamada, 'DATA', consumo, 0)) / 1024), 2)
                 consumo_kb,
             SUM (DECODE (tipollamada, 'LLAMADAS VOZ', monto, 0)) monto_voz_tapin,
             SUM (DECODE (tipollamada, 'MENSAJES', monto, 0)) monto_sms_tapin,
             SUM (DECODE (tipollamada, 'DATA', monto, 0)) monto_datos_tapin
        FROM roam_detalle3g_fecllam c
        LEFT JOIN p_compania com
          ON c.codigocompania = com.codigocompania
       WHERE fecha >= TRUNC(V_FECHA-30)
         AND c.contrato IS NOT NULL
    GROUP BY c.fecha,
             c.numerocuentaresponsable,
             c.telefono,
             c.contrato,
             c.ciclo,
             obtener_periodo_fact_actual (c.ciclo, fecha),
             c.codigocompania,
             obtener_tipodoc_2(com.ruccompania) ) T
    LEFT JOIN (  SELECT GP.*
                     , CASE WHEN mb_ggsn<= mb_paq_contratado THEN mb_ggsn
                       ELSE mb_paq_contratado END mb_ggsn_paquete
                     , CASE WHEN mb_ggsn> mb_paq_contratado THEN mb_ggsn - mb_paq_contratado
                       ELSE 0 END mb_ggsn_exceso
                  FROM
                    ( SELECT fecha_ggsn,
                             telefono,
                             contrato,
                             SUM(NVL(mb_ggsn,0)) mb_ggsn,
                             SUM(NVL(mb_paq,0)) mb_paq_contratado,
                             CASE WHEN SUM(NVL(mb_paq,0)) > 0 THEN 'PAQUETE' END compra_paquete
                        FROM pf_datos_ggsn_jg
                       WHERE fecha_ggsn >= TRUNC(V_FECHA-30)
                    GROUP BY fecha_ggsn, telefono, contrato ) GP) g
    ON T.telefono = g.telefono AND t.fecha = g.fecha_ggsn;
    COMMIT;


    --pf_roaming_rep_facturacion
    DELETE FROM pf_roaming_rep_facturacion WHERE periodo_facturacion>= TO_CHAR(TRUNC(V_FECHA-30),'YYYYMM');

    INSERT INTO pf_roaming_rep_facturacion (numerocuentaresponsable, telefono, contrato, ciclo,
                                        codigocompania, periodo_facturacion, consumo_minutos,
                                        consumo_sms, consumo_kb, monto_voz_tapin,
                                        monto_sms_tapin, monto_datos_tapin)
     SELECT /*+PARALLEL(8)*/ NUMEROCUENTARESPONSABLE,
            TELEFONO, contrato, ciclo, codigocompania,
            obtener_periodo_fact_actual(ciclo, fecha) periodo_facturacion,
            SUM(DECODE(tipollamada,'LLAMADAS VOZ',consumo,0)) consumo_minutos,
            SUM(DECODE(tipollamada,'MENSAJES',consumo,0)) consumo_sms,
            ROUND((SUM(DECODE(tipollamada,'DATA',consumo,0))/1024), 2) consumo_KB,
            SUM(DECODE(tipollamada,'LLAMADAS VOZ',monto,0)) monto_voz_tapin,
            SUM(DECODE(tipollamada,'MENSAJES',monto,0)) monto_sms_tapin,
            SUM(DECODE(tipollamada,'DATA',monto,0)) monto_datos_tapin
      FROM roam_detalle3g_fecllam c
     WHERE obtener_periodo_fact_actual(ciclo,fecha) >= TO_CHAR(TRUNC(V_FECHA-30),'YYYYMM')
     GROUP BY NUMEROCUENTARESPONSABLE,
            TELEFONO, contrato, ciclo,
            obtener_periodo_fact_actual(ciclo, fecha), codigocompania;

    MERGE INTO (SELECT *
                  FROM pf_roaming_rep_facturacion
                 WHERE periodo_facturacion>= TO_CHAR(TRUNC(V_FECHA-30),'YYYYMM')) R
    USING (SELECT periodo, codigocompania , telefono
             , SUM(DECODE(conceptofacturacion,'Roaming 3G',monto_doc,0)) monto_voz_sms_roam
             , SUM(DECODE(conceptofacturacion,'Navegador Nextel 3G',monto_doc,0)) monto_datos
          FROM tnp_facturacion
         WHERE monto_doc>0
           AND periodo >= TO_CHAR(TRUNC(V_FECHA-30),'YYYYMM')
           AND conceptofacturacion IN ('Roaming 3G', 'Navegador Nextel 3G')
         GROUP BY periodo, codigocompania , telefono  ) F
     ON (R.codigocompania = F.codigocompania
            AND R.telefono = F.telefono
            AND R.periodo_facturacion = F.periodo)
     WHEN MATCHED THEN UPDATE SET monto_voz_sms_roam_fact = monto_voz_sms_roam
                                , monto_datos_fact = monto_datos;

     COMMIT;

END;

PROCEDURE TRANSACCION_BANCO(pcursor OUT t_cursor) AS
BEGIN

INSERT INTO RI_TRANSACCIONES_BANCO
SELECT OPERACIONIB,CODIGODEUDOR,CICLO,CODIGOBSCS,RAZONSOCIAL,NRODOCUMENTO,ESTADOCONTRATO,SOLUCION,FECHAPROCESO FROM (
SELECT b.operacionib OPERACIONIB,
       b.codigodeudor CODIGODEUDOR,
       nvl(f.ciclofacturacioncontrato,h.ciclofacturacioncontrato) CICLO,
       nvl(f.numerocuentaresponsable,h.numerocuentaresponsable) CODIGOBSCS,
       nvl(f.compania,h.compania) RAZONSOCIAL,
       nvl(f.ruccompania,h.ruccompania) NRODOCUMENTO,
       nvl(f.estadocontrato,h.estadocontrato) ESTADOCONTRATO,
       nvl(f.solucion ,h.solucion) SOLUCION,
       b.fechaproceso FECHAPROCESO,
       ROW_NUMBER() OVER (PARTITION BY b.codigodeudor
                ORDER BY nvl(f.fechaproceso,h.fechaproceso) DESC NULLS LAST) RN
       FROM RI_TRANSACCIONES_BANCO_TEMP b
LEFT JOIN fotoequipos f ON b.codigodeudor = f.telefono
LEFT JOIN p_fotoequipos_historico h ON b.codigodeudor = h.telefono) A WHERE RN = 1;
COMMIT;

OPEN pcursor FOR
SELECT nvl(OPERACIONIB,'-'),nvl(CODIGODEUDOR,'-'),nvl(CICLO,'-'),nvl(CODIGOBSCS,'-'),nvl(RAZONSOCIAL,'-'),nvl(NRODOCUMENTO,'-'),nvl(ESTADOCONTRATO,'-'),nvl(SOLUCION,'-')
FROM RI_TRANSACCIONES_BANCO t
INNER JOIN
(SELECT MAX(to_char(fechaproceso, 'mm/dd/yyyy hh24:mi:ss')) FECHAPROCESO2 FROM RI_TRANSACCIONES_BANCO_TEMP) s
ON to_char(t.fechaproceso, 'mm/dd/yyyy hh24:mi:ss') = s.fechaproceso2;

END TRANSACCION_BANCO;

PROCEDURE BASE_SUSPENSION(pcursor OUT t_cursor) IS
BEGIN
OPEN PCURSOR FOR
SELECT NVL(A.FECHASUSPENSION, '-'),
       NVL(A.FECHABASE,'-'),
       NVL(A.FECHAASIGNACIONGESTION, '-'),
       NVL(A.FECHAFINALGESTION,'-'),
       NVL(A.CODIGOCONTRATOBSCS,0),
       NVL(A.PLANTARIFARIO, '-'),
       NVL(A.PENALIDAD,0),
       NVL(B.ESTADOCONTRATO, '-'),
       NVL(B.MOTIVOMOVIMIENTO, '-'),
       NVL(B.TIPOMOTIVOMOVIMIENTO, '-'),
       NVL(TO_CHAR(NVL(B.FECHAMOVIMIENTO,B.FECHACARGACONTRATO),'DD/MM/YYYY'),'-') FECHACARGACONTRATO,
       NVL(TO_CHAR(B.FECHAACTIVACIONCONTRATO,'DD/MM/YYYY'),'-') FECHAACTIVACIONCONTRATO,
       NVL(CASE WHEN B.ESTADOCONTRATO = 'Desactivado' THEN TO_CHAR(NVL(B.FECHAMOVIMIENTO,B.FECHADESACTIVACIONCONTRATO),'DD/MM/YYYY') END,'-') FECHADESACTIVACIONCONTRATO
FROM CB_BASE_SUSPENSION A,
     FOTOEQUIPOS B
WHERE A.CODIGOCONTRATOBSCS = B.CODIGOCONTRATOBSCS (+);

END BASE_SUSPENSION;

END PAQUETE_RIESGOS;